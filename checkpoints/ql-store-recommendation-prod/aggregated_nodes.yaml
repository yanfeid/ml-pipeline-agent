- Driver Creation:
    line_range: Lines 4-512
    inputs:
    - file_path: "../config/base_config.yaml"
    - training_exclude_merch: "config['driver_config']['training_exclude_merch']"
    - train_start_date: "config['driver_config']['train_start_date']"
    - oot_start_date: "config['driver_config']['oot_start_date']"
    - training_hot_positive_attributed_txn_sampling_alpha: "config['driver_config']['training_hot_positive_attributed_txn_sampling_alpha']"
    - training_attributed_txn_upsampling_rate: "config['driver_config']['training_attributed_txn_upsampling_rate']"
    - val_start_date: "config['driver_config']['val_start_date']"
    - removing_highly_active_user_threshold: "config['driver_config']['removing_highly_active_user_threshold']"
    - removing_highly_active_user_merchant_threshold: "config['driver_config']['removing_highly_active_user_merchant_threshold']"
    - removing_highly_active_user_merchant_date_threshold: "config['driver_config']['removing_highly_active_user_merchant_date_threshold']"
    - training_hot_positive_organic_txn_sampling_alpha: "config['driver_config']['training_hot_positive_organic_txn_sampling_alpha']"
    - save_label_mixing_rate: "config['driver_config']['save_label_mixing_rate']"
    - ratio_for_hard_negtive: "config['driver_config']['ratio_for_hard_negtive']"
    - hard_negative_impression_time_window: "config['driver_config']['hard_negative_impression_time_window']"
    - negative_sampling_avoid_delay_postive_feedback_window: "config['driver_config']['negative_sampling_avoid_delay_postive_feedback_window']"
    - training_hot_negative_sampling_alpha: "config['driver_config']['training_hot_negative_sampling_alpha']"
    - uniform_negative_postive_ratio: "config['driver_config']['uniform_negative_postive_ratio']"
    outputs:
    - live_unique_merchants_train: "{bq_prefix}live_unique_merchants_train"
    - driver_00: "{bq_prefix}driver_00"
    - driver_0: "{bq_prefix}driver_0"
    - driver_1: "{bq_prefix}driver_1"
    - driver_positive_train_attributed: "{bq_prefix}driver_positive_train_attributed"
    - driver_positive_train_organic_0: "{bq_prefix}driver_positive_train_organic_0"
    - driver_positive_train_organic: "{bq_prefix}driver_positive_train_organic"
    - driver_positive: "{bq_prefix}driver_positive"
    - driver_positive_training_split_0: "{bq_prefix}driver_positive_training_split_0"
    - driver_positive_training_split: "{bq_prefix}driver_positive_training_split"
    - driver_training_hard_negative: "{bq_prefix}driver_training_hard_negative"
    - driver_training_hard_negative_downsample: "{bq_prefix}driver_training_hard_negative_downsample"
    - driver_training_uniform_negative: "{bq_prefix}driver_training_uniform_negative"
    - driver_training_uniform_negative_remove_window_positive: "{bq_prefix}driver_training_uniform_negative_remove_window_positive"
    - driver_training_uniform_negative_downsample_0: "{bq_prefix}driver_training_uniform_negative_downsample_0"
    - driver_training_uniform_negative_downsample: "{bq_prefix}driver_training_uniform_negative_downsample"
    - driver_dev: "{bq_prefix}driver_dev"
    - driver_oot_uniform_negative_0: "{bq_prefix}driver_oot_uniform_negative_0"
    - driver_oot_uniform_negative: "{bq_prefix}driver_oot_uniform_negative"
    - driver_oot: "{bq_prefix}driver_oot"
    - driver_simu: "{bq_prefix}driver_simu"
    - driver_simu_consumer: "{bq_prefix}driver_simu_consumer"
- Feature Engineering:
    line_range: Lines 17-817
    inputs:
    - file_path: "../config/base_config.yaml"
    - bq_prefix: "config['general_config']['bq_project_dataset_prefix']"
    - train_start_date: "config['driver_config']['train_start_date']"  # Unified with Driver Creation
    outputs:
    - driver_simu_txn_365d_table: "{bq_prefix}driver_simu_txn_365d"
    - driver_simu_txn_365d_agg_table: "{bq_prefix}driver_simu_txn_365d_agg"
    - driver_consumer_base_table: "{bq_prefix}driver_consumer_base"
    - driver_consumer_base_txn_5k_merch_category_table: "{bq_prefix}driver_consumer_base_txn_5k_merch_category"
    - driver_consumer_base_last_10_txn_table: "{bq_prefix}driver_consumer_base_last_10_txn"
    - driver_consumer_base_all_history_array_0_table: "{bq_prefix}driver_consumer_base_all_history_array_0"
    - driver_consumer_base_all_history_array_table: "{bq_prefix}driver_consumer_base_all_history_array"
    - driver_combine_category_table: "{bq_prefix}driver_combine_category"
    - driver_combine_category_agg_0_table: "{bq_prefix}driver_combine_category_agg_0"
    - driver_combine_category_agg_1_table: "{bq_prefix}driver_combine_category_agg_1"
    - driver_combine_category_agg_2_table: "{bq_prefix}driver_combine_category_agg_2"
    - driver_combine_category_agg_3_table: "{bq_prefix}driver_combine_category_agg_3"
    - driver_combine_category_agg_4_table: "{bq_prefix}driver_combine_category_agg_4"
    - driver_combine_category_agg_5_table: "{bq_prefix}driver_combine_category_agg_5"
    - driver_merchant_base_table: "{bq_prefix}driver_merchant_base"
    - driver_merchant_base_txn_30d_table: "{bq_prefix}driver_merchant_base_txn_30d"
    - driver_merchant_base_txn_30d_filter_sndr_table: "{bq_prefix}driver_merchant_base_txn_30d_filter_sndr"
    - driver_merchant_base_price_agg_table: "{bq_prefix}driver_merchant_base_price_agg"
    - driver_merchant_base_sales_agg_table: "{bq_prefix}driver_merchant_base_sales_agg"
    - driver_elig_save_365d_category_table: "{bq_prefix}driver_elig_save_365d_category"
    - driver_elig_save_agg_00_table: "{bq_prefix}driver_elig_save_agg_00"
    - driver_elig_save_agg_0_table: "{bq_prefix}driver_elig_save_agg_0"
    - driver_elig_save_agg_1_table: "{bq_prefix}driver_elig_save_agg_1"
    - driver_elig_save_agg_2_table: "{bq_prefix}driver_elig_save_agg_2"
    - driver_elig_save_agg_3_table: "{bq_prefix}driver_elig_save_agg_3"
    - driver_merchant_base_click_save_table: "{bq_prefix}driver_merchant_base_click_save"
    - driver_consumer_base_gender_table: "{bq_prefix}driver_consumer_base_gender"
- Data Pulling:
    line_range: Lines 34-73
    inputs:
    - stage: "training"
    - seq_num: "20231010"  # Example date
    - is_prod: "True"
    - job_name: "ql_store_rmr"
    - group_name: "mls_gads"
    - model_name: "ql_store_rmr_datafetcher"
    - model_owner: "chenzhao"
    - description: "ranking_combined_datafetcher"
    - manager: "Farhad"
    - on_gcp: True
    - gcp_project_id: "ccg24-hrzana-gds-pacman"
    - gcs_bucket_name: "pypl-bkt-rsh-row-std-gds-pacman"
    - bq_materialization_project: "pypl-bods"
    - bq_materialization_dataset: "rsh_row_gds_pacman"
    - driver_loc: "gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_driver_simu_consumer"
    outputs:
    - data_loc: "gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_driver_simu_consumer_varmart"
- Feature Consolidation:
    line_range: Lines 4-639
    inputs:
    - config_file_path: "../config/base_config.yaml"  # Unified with Driver Creation and Feature Engineering
    - driver_dev_table: "{bq_prefix}driver_dev"  # Unified with Driver Creation
    - driver_simu_txn_365d_agg_table: "{bq_prefix}driver_simu_txn_365d_agg"  # Unified with Feature Engineering
    - driver_consumer_base_last_10_txn_table: "{bq_prefix}driver_consumer_base_last_10_txn"  # Unified with Feature Engineering
    - driver_consumer_base_all_history_array_table: "{bq_prefix}driver_consumer_base_all_history_array"  # Unified with Feature Engineering
    - driver_combine_category_agg_3_table: "{bq_prefix}driver_combine_category_agg_3"  # Unified with Feature Engineering
    - driver_combine_category_agg_5_table: "{bq_prefix}driver_combine_category_agg_5"  # Unified with Feature Engineering
    - driver_merchant_base_price_agg_table: "{bq_prefix}driver_merchant_base_price_agg"  # Unified with Feature Engineering
    - driver_merchant_base_sales_agg_table: "{bq_prefix}driver_merchant_base_sales_agg"  # Unified with Feature Engineering
    - driver_elig_save_agg_00_table: "{bq_prefix}driver_elig_save_agg_00"  # Unified with Feature Engineering
    - driver_elig_save_agg_0_table: "{bq_prefix}driver_elig_save_agg_0"  # Unified with Feature Engineering
    - driver_elig_save_agg_3_table: "{bq_prefix}driver_elig_save_agg_3"  # Unified with Feature Engineering
    - driver_merchant_base_click_save_table: "{bq_prefix}driver_merchant_base_click_save"  # Unified with Feature Engineering
    - driver_consumer_base_gender_table: "{bq_prefix}driver_consumer_base_gender"  # Unified with Feature Engineering
    - ql_store_honey_merch_quality_scores_external_table: "pypl-bods.gds_pacman_prod.ql_store_honey_merch_quality_scores_external"
    - driver_simu_consumer_varmart_external_table: "{bq_prefix}driver_simu_consumer_varmart_external"
    - store_recommendation_kg_embedding_32_v2_table: "pypl-bods.gds_pacman_prod.store_recommendation_kg_embedding_32_v2"
    outputs:
    - consolidated_feature_set_path: "gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_driver_dev_features/part*.parquet"
- Data Preprocessing:
    line_range: Lines 21-175
    inputs:
    - directory: "../data/ql_store_rmr_driver_dev_features"
    - parquet_files: [list of parquet files in the directory]
    - state_to_abbreviation: { 'ALABAMA': 'AL', 'ALASKA': 'AK', ... }
    - categorical_features: ['sndr_consu_engagmnt_seg_key', 'sndr_ebay_member_y_n', 'gender', 'sndr_prmry_cc_type_code', 'sndr_consu_age_band_key', 'sndr_consu_dmgrphc_seg_key']
    - numeric_features: ["sndr_rcvr_txn_num_30d", "sndr_rcvr_txn_num_180d", "sndr_rcvr_txn_num_365d", "sndr_rcvr_txn_amt_30d", "sndr_rcvr_txn_amt_180d", ...]
    - sequence_feature: 'sndr_most_recent_100_merch_category'
    - tokenizer_feature: 'sndr_most_recent_100_merch_list'
    - chunk_size: 1000000
    - output_dir: '../data/ql_store_rmr_driver_dev_features_transformed'
    outputs:
    - processed_data_path: '../data/ql_store_rmr_driver_dev_features_transformed'
- Model Training:
    line_range: Lines 140-169
    inputs:
    - train_data_path: "../data/ql_store_rmr_driver_dev_features_transformed"  # Unified with Data Preprocessing
    - numeric_names: ["sndr_rcvr_txn_num_30d", "sndr_rcvr_txn_num_180d", "sndr_rcvr_txn_num_365d", ...]
    - rcvr_id_names: ["rcvr_id"]
    - gpt_cate_names: ["gpt_1st_category_l2_index", "sndr_1st_freq_merchant_category_30d", ...]
    outputs:
    - model_artifact_path: os.path.join(exported_model_base, 'din.h5')
    - tf_model_path: os.path.join(exported_model_base, 'din_saved_model')
- Model Packaging:
    line_range: Lines 171-185
    inputs:
    - trained_model_path: os.path.join(exported_model_base, 'din_saved_model')  # Unified with Model Training
    outputs:
    - onnx_spec_path: exported_model_base
    - oot_scoring_path: os.path.join(exported_model_base, 'oot_scoring')
    - onnx_model_path: os.path.join(exported_model_base, 'tf_2_onnx_model.m')
    - renamed_model_path: os.path.join(exported_model_base, 'oot_scoring/din_expand_seq.m')
    - prod_model_path: exported_model_base
    - test_data_output_path: './testdata/testdata.json'
    - onnx_output_path: os.path.join(exported_model_base, 'din.onnx')
- Model Scoring:
    line_range: Lines 26-104
    inputs:
    - working_path: "/projects/gds-packman/apps/ql-store-recommendation-prod/research"
    - params_path: "/projects/gds-packman/apps/ql-store-recommendation-prod/research/config"
    - model_version_path: "/projects/gds-packman/apps/ql-store-recommendation-prod/research/_current_model_version"
    - exported_model_base: "/projects/gds-packman/apps/ql-store-recommendation-prod/research/artifacts/{model_version}/exported_models"
    - m_local_folder: "/projects/gds-packman/apps/ql-store-recommendation-prod/research/artifacts/din_20240708/18/exported_models/oot_scoring"
    - m_gcp_folder: "gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/challenger/oot_scoring"
    - oot_data_path: "gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_oot_transformed"
    outputs:
    - eval_result_path: "gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_oot_transformed_scored"
    - log_file: "/projects/gds-packman/apps/ql-store-recommendation-prod/research/logs/{job_id}.log"
- Model Evaluation:
    line_range: Lines 375-731
    inputs:
    - model_version_path: "../_current_model_version"  # Unified with Model Scoring
    - model_version_base: "../artifacts/{model_version}/18"
    - config_file_path: "../config/base_config.yaml"  # Unified with Driver Creation, Feature Engineering, and Feature Consolidation
    - remove_list: "'1365556366671835703','2254348706417584521','1581565211190403045','1157330454984142772','1339933886421356550','1812170125034785903','6053464759929799123','1587111025150613712','1672368731209095395','1365556366671835703','6085552794250364378','1954349237309389875'"
    outputs:
    - exported_eval_readout_base: "../artifacts/{model_version}/18/exported_eval_readouts"
    - performance_metrics_csv: "../artifacts/{model_version}/18/exported_eval_readouts/performane_all.csv"
    - performance_metrics_plot: "../artifacts/{model_version}/18/exported_eval_readouts/performane_all.png"
    - performance_ftu_csv: "../artifacts/{model_version}/18/exported_eval_readouts/performane_ftu.csv"
    - performance_ftu_plot: "../artifacts/{model_version}/18/exported_eval_readouts/performane_ftu.png"
    - performance_wo_ebay_csv: "../artifacts/{model_version}/18/exported_eval_readouts/performane_wo_ebay.csv"
    - performance_wo_ebay_plot: "../artifacts/{model_version}/18/exported_eval_readouts/performane_wo_ebay.png"
