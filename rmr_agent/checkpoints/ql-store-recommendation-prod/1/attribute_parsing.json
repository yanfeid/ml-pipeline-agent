{
  "attribute_parsing": [
    {
      "Driver Creation": {
        "file_name": "rmr_agent/repos/ql-store-recommendation-prod/research/pipeline/00_driver.py",
        "line_range": "Lines 1-513",
        "inputs": [
          "file_path: '../config/base_config.yaml'",
          "bq_project_dataset_prefix: config['general_config']['bq_project_dataset_prefix']",
          "training_exclude_merch: config['driver_config']['training_exclude_merch']",
          "train_start_date: config['driver_config']['train_start_date']",
          "oot_start_date: config['driver_config']['oot_start_date']",
          "training_hot_positive_attributed_txn_sampling_alpha: config['driver_config']['training_hot_positive_attributed_txn_sampling_alpha']",
          "training_attributed_txn_upsampling_rate: config['driver_config']['training_attributed_txn_upsampling_rate']",
          "removing_highly_active_user_threshold: config['driver_config']['removing_highly_active_user_threshold']",
          "removing_highly_active_user_merchant_threshold: config['driver_config']['removing_highly_active_user_merchant_threshold']",
          "removing_highly_active_user_merchant_date_threshold: config['driver_config']['removing_highly_active_user_merchant_date_threshold']",
          "training_hot_positive_organic_txn_sampling_alpha: config['driver_config']['training_hot_positive_organic_txn_sampling_alpha']",
          "val_start_date: config['driver_config']['val_start_date']",
          "save_label_mixing_rate: config['driver_config']['save_label_mixing_rate']",
          "ratio_for_hard_negtive: config['driver_config']['ratio_for_hard_negtive']",
          "hard_negative_impression_time_window: config['driver_config']['hard_negative_impression_time_window']",
          "negative_sampling_avoid_delay_postive_feedback_window: config['driver_config']['negative_sampling_avoid_delay_postive_feedback_window']",
          "training_hot_negative_sampling_alpha: config['driver_config']['training_hot_negative_sampling_alpha']",
          "uniform_negative_postive_ratio: config['driver_config']['uniform_negative_postive_ratio']"
        ],
        "outputs": [
          "driver_dev: {bq_prefix}driver_dev",
          "driver_oot: {bq_prefix}driver_oot",
          "driver_simu: {bq_prefix}driver_simu",
          "driver_simu_consumer: {bq_prefix}driver_simu_consumer"
        ]
      }
    },
    {
      "Feature Engineering": {
        "file_name": "rmr_agent/repos/ql-store-recommendation-prod/research/pipeline/01_bq_feat.py",
        "line_range": "1-819",
        "inputs": [
          "file_path: '../config/base_config.yaml'",
          "bq_prefix: config['general_config']['bq_project_dataset_prefix']",
          "train_start_date: config['driver_config']['train_start_date']"
        ],
        "outputs": [
          "final_table: {bq_prefix}driver_consumer_base_gender"
        ]
      }
    },
    {
      "Data Pulling": {
        "file_name": "rmr_agent/repos/ql-store-recommendation-prod/research/pipeline/01_varmart_feat.py",
        "line_range": "1-73",
        "inputs": [
          "gcp_project_id: 'ccg24-hrzana-gds-pacman'",
          "gcs_bucket_name: 'pypl-bkt-rsh-row-std-gds-pacman'",
          "bq_materialization_project: 'pypl-bods'",
          "bq_materialization_dataset: 'rsh_row_gds_pacman'",
          "driver_loc: 'gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_driver_simu_consumer'",
          "variables: ['prmry_addr_state', 'days_on_file', 'ebay_member_y_n', 'consu_engagmnt_seg_key', 'prmry_cc_type_code', 'days_appweb_visit', 'consu_age_band_key', 'consu_income_band_key', 'consu_dmgrphc_seg_key']",
          "split_ratio: {\"train\": 1.0}",
          "num_of_splits: 1"
        ],
        "outputs": [
          "data_loc: 'gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_driver_simu_consumer_varmart'"
        ]
      }
    },
    {
      "Feature Consolidation": {
        "file_name": "rmr_agent/repos/ql-store-recommendation-prod/research/pipeline/02_combine.py",
        "line_range": "1-642",
        "inputs": [
          "file_path: '../config/base_config.yaml'",
          "bq_prefix: config['general_config']['bq_project_dataset_prefix']",
          "{bq_prefix}driver_dev: {bq_prefix}driver_dev",
          "{bq_prefix}driver_simu_txn_365d_agg: {bq_prefix}driver_simu_txn_365d_agg",
          "{bq_prefix}driver_consumer_base_last_10_txn: {bq_prefix}driver_consumer_base_last_10_txn",
          "{bq_prefix}driver_consumer_base_all_history_array: {bq_prefix}driver_consumer_base_all_history_array",
          "{bq_prefix}driver_combine_category_agg_3: {bq_prefix}driver_combine_category_agg_3",
          "{bq_prefix}driver_combine_category_agg_5: {bq_prefix}driver_combine_category_agg_5",
          "{bq_prefix}driver_merchant_base_price_agg: {bq_prefix}driver_merchant_base_price_agg",
          "{bq_prefix}driver_merchant_base_sales_agg: {bq_prefix}driver_merchant_base_sales_agg",
          "{bq_prefix}driver_elig_save_agg_00: {bq_prefix}driver_elig_save_agg_00",
          "{bq_prefix}driver_elig_save_agg_0: {bq_prefix}driver_elig_save_agg_0",
          "{bq_prefix}driver_elig_save_agg_3: {bq_prefix}driver_elig_save_agg_3",
          "{bq_prefix}driver_merchant_base_click_save: {bq_prefix}driver_merchant_base_click_save",
          "{bq_prefix}driver_consumer_base_gender: {bq_prefix}driver_consumer_base_gender",
          "pypl-bods.gds_pacman_prod.ql_store_honey_merch_quality_scores_external: pypl-bods.gds_pacman_prod.ql_store_honey_merch_quality_scores_external",
          "{bq_prefix}driver_simu_consumer_varmart_external: {bq_prefix}driver_simu_consumer_varmart_external",
          "pypl-bods.gds_pacman_prod.store_recommendation_kg_embedding_32_v2: pypl-bods.gds_pacman_prod.store_recommendation_kg_embedding_32_v2"
        ],
        "outputs": [
          "gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_driver_dev_features/part*.parquet: gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_driver_dev_features/part*.parquet"
        ]
      }
    },
    {
      "Data Preprocessing": {
        "file_name": "rmr_agent/repos/ql-store-recommendation-prod/research/pipeline/03_prepare_training_data.py",
        "line_range": "1-185",
        "inputs": [
          "model_version_base: '../artifacts/din_<today_date>'",
          "exported_feature_transformer: '../artifacts/din_<today_date>/exported_feature_transformer'",
          "directory: '../data/ql_store_rmr_driver_dev_features'",
          "parquet_files: List of parquet files in the directory",
          "state_to_abbreviation: Dictionary mapping state names to abbreviations",
          "categorical_features: ['sndr_consu_engagmnt_seg_key', 'sndr_ebay_member_y_n', 'gender', 'sndr_prmry_cc_type_code', 'sndr_consu_age_band_key', 'sndr_consu_dmgrphc_seg_key']",
          "numeric_features: ['sndr_rcvr_txn_num_30d', 'sndr_rcvr_txn_num_180d', 'sndr_rcvr_txn_num_365d', 'sndr_rcvr_txn_amt_30d', 'sndr_rcvr_txn_amt_180d', ... (abbreviated)]",
          "rcvr_id_tokenizer_params: {'num_words': 1000, 'oov_token': '<OOV>'}",
          "output_dir: '../data/ql_store_rmr_driver_dev_features_transformed'",
          "chunk_size: 1000000"
        ],
        "outputs": [
          "transformed_data_path: '../data/ql_store_rmr_driver_dev_features_transformed'",
          "rcvr_id_tokenizer_path: '../artifacts/din_<today_date>/exported_feature_transformer/rcvr_id_tokenizer'",
          "categorical_feature_encoders_path: '../artifacts/din_<today_date>/exported_feature_transformer/categorical_feature_encoders'",
          "numerical_feature_scalars_path: '../artifacts/din_<today_date>/exported_feature_transformer/numerical_feature_scalars'"
        ]
      }
    },
    {
      "Model Training": {
        "file_name": "rmr_agent/repos/ql-store-recommendation-prod/research/pipeline/04_training.py",
        "line_range": "1-170",
        "inputs": [
          "file_path: '../config/base_config.yaml'",
          "model_version_base: '../artifacts/{model_version}/19'",
          "exported_feature_transformer: '../artifacts/{model_version}/exported_feature_transformer'",
          "directory: '../data/ql_store_rmr_driver_dev_features_transformed'",
          "numeric_names: [\"sndr_rcvr_txn_num_30d\", \"sndr_rcvr_txn_num_180d\", \"sndr_rcvr_txn_num_365d\", ...]",
          "rcvr_id_names: ['rcvr_id']",
          "gpt_cate_names: ['gpt_1st_category_l2_index', 'sndr_1st_freq_merchant_category_30d', ...]",
          "batch_size: config['training_config']['DIN']['batch_size']",
          "learning_rate: config['training_config']['DIN']['learning_rate']",
          "dnn_use_bn: config['training_config']['DIN']['dnn_use_bn']",
          "dnn_hidden_units: config['training_config']['DIN']['dnn_hidden_units']",
          "dnn_activation: config['training_config']['DIN']['dnn_activation']",
          "att_hidden_size: config['training_config']['DIN']['att_hidden_size']",
          "att_activation: config['training_config']['DIN']['att_activation']",
          "att_weight_normalization: config['training_config']['DIN']['att_weight_normalization']",
          "l2_reg_dnn: config['training_config']['DIN']['l2_reg_dnn']",
          "l2_reg_embedding: config['training_config']['DIN']['l2_reg_embedding']",
          "dnn_dropout: config['training_config']['DIN']['dnn_dropout']",
          "seed: config['training_config']['DIN']['seed']",
          "epochs: config['training_config']['DIN']['epochs']"
        ],
        "outputs": [
          "h5_model_path: '../artifacts/{model_version}/19/exported_models/din.h5'",
          "tf_model_path: '../artifacts/{model_version}/19/exported_models/din_saved_model'"
        ]
      },
      "Model Packaging": {
        "file_name": "rmr_agent/repos/ql-store-recommendation-prod/research/pipeline/04_training.py",
        "line_range": "171-269",
        "inputs": [
          "model: `model` (TensorFlow model object)",
          "exported_model_base: `os.path.join(model_version_base, 'exported_models')`",
          "input_mappings: 'hist_rcvr_id': `[f'hist_rcvr_id_{i}' for i in range(1, 101)]`",
          "input_mappings: 'hist_gpt_1st_category_l2_index': `[f'hist_gpt_1st_category_{i}' for i in range(1, 101)]`",
          "output_mappings: `{model.output.name[:-2]: 'out'}`",
          "categorical_feature_encoders: `os.path.join(exported_feature_transformer, 'categorical_feature_encoders')`",
          "numerical_feature_scalars: `os.path.join(exported_feature_transformer, 'numerical_feature_scalars')`",
          "test_cust: `test_cust` (variable not defined in the provided code)",
          "test_date: `test_date` (variable not defined in the provided code)",
          "test_df: `data[(data['cust_id'] == test_cust) & (data['run_date'] == test_date)]`",
          "test_data_local: `test_data_local` (dictionary created from `test_df`)",
          "test_data_tf: `test_data_tf` (dictionary created from `test_df`)",
          "onnx_output_path: `os.path.join(exported_model_base, 'din.onnx')`",
          "saved_model_path: `os.path.join(exported_model_base, 'din_saved_model')`",
          "output_file: `./testdata/testdata.json`"
        ],
        "outputs": [
          "h5_model_path: `os.path.join(exported_model_base, 'din.h5')`",
          "tf_model_path: `os.path.join(exported_model_base, 'din_saved_model')`",
          "onnx_spec: `onnx_spec.save(exported_model_base)`",
          "prod_model: `prod_model.save(exported_model_base)`",
          "path: `exported_model_base + '/din_prod.m'`",
          "test_data: `{\"data\": {\"names\": inputs, \"ndarray\": [test_data_local[feat][0] for feat in inputs]}}`",
          "onnx_output_path: `os.path.join(exported_model_base, 'din.onnx')`",
          "results_ort: `sess.run(None, test_data_onnx)`"
        ]
      }
    },
    {
      "Model Scoring": {
        "file_name": "rmr_agent/repos/ql-store-recommendation-prod/research/pipeline/05_scoring_oot.py",
        "line_range": "1-104",
        "inputs": [
          "working_path: \"/projects/gds-packman/apps/ql-store-recommendation-prod/research\"",
          "params_path: \"/projects/gds-packman/apps/ql-store-recommendation-prod/research/config\"",
          "section_name: \"oot_data_scoring\"",
          "model_version_path: \"/projects/gds-packman/apps/ql-store-recommendation-prod/research/_current_model_version\"",
          "exported_model_base: \"/projects/gds-packman/apps/ql-store-recommendation-prod/research/artifacts/{model_version}/exported_models\"",
          "m_local_folder: \"/projects/gds-packman/apps/ql-store-recommendation-prod/research/artifacts/din_20240708/18/exported_models/oot_scoring\"",
          "m_gcp_folder: \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/challenger/oot_scoring\"",
          "oot_data_path: \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_oot_transformed\"",
          "eval_path: \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_oot_transformed_scored\""
        ],
        "outputs": [
          "eval_result_path: \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/chenzhao/prod/ql-store-rmr/data/ql_store_rmr_oot_transformed_scored\"",
          "log_file: \"/projects/gds-packman/apps/ql-store-recommendation-prod/research/logs/{job_id}.log\""
        ]
      }
    },
    {
      "Component Name": {
        "file_name": "research/driver_creation.ipynb",
        "line_range": "Lines 258-311",
        "inputs": [
          "input_data: The dataset to be processed",
          "config: Configuration settings for the processing"
        ],
        "outputs": [
          "processed_data: The resulting dataset after processing",
          "log: Log information about the processing steps"
        ]
      }
    }
  ]
}