{
  "summaries": {
    "rmr_agent/repos/bt-retry-v2/etl/01_etl.py": "**[Create and populate table with filtered transactions] (Lines 4-15):**\n- Drops existing table if it exists.\n- Creates a new table with transactions that meet specific criteria, including non-null retried transactions, certain strategy types, a date range, and a random sampling factor.\n\n**[Define temporary functions for categorizing transaction codes] (Lines 17-68):**\n- Defines several temporary functions to categorize transaction response codes into various types such as hard decline, soft decline, success, etc.\n\n**[Create and populate table with primary retry transactions] (Lines 69-167):**\n- Drops existing table if it exists.\n- Creates a new table by joining retry transactions with primary transactions and other related tables to include various transaction details and response types.\n\n**[Create and populate table with additional features] (Lines 177-235):**\n- Drops existing table if it exists.\n- Creates a new table by adding features such as currency exchange rates to the retry transactions.\n\n**[Join with credit card details for additional features] (Lines 237-320):**\n- Drops existing table if it exists.\n- Creates a new table by joining retry transactions with credit card details to include additional credit card-related features.\n\n**[Rename features to match model variable names] (Lines 322-386):**\n- Drops existing table if it exists.\n- Creates a new table by renaming features to match the model's variable names.\n\n**[Join with bin and strategy features] (Lines 388-545):**\n- Drops existing table if it exists.\n- Creates a new table by joining retry transactions with bin and strategy features to include additional RADD features.\n\n**[Convert BIGNUMERIC to Numeric] (Lines 547-562):**\n- Drops existing table if it exists.\n- Creates a new table by converting a specific column's data type from BIGNUMERIC to float64.\n\n**[Filter and deduplicate data] (Lines 985-1005):**\n- Drops existing table if it exists.\n- Creates a new table by filtering out rows with null values in specific columns and deduplicating based on primary transaction ID.\n\n**[Train-validation-test split] (Lines 1008-1113):**\n- Drops existing tables if they exist.\n- Creates new tables for training, validation, and test datasets by splitting the data based on a random sampling factor.\n\n**[Copy test dataset to scratch for QPull purposes] (Lines 1118-1125):**\n- Drops existing table if it exists.\n- Creates a new table in a different schema for easier access and querying.",
    "rmr_agent/repos/bt-retry-v2/etl/02_bq_to_dataproc.py": "**[Configuration settings for Spark and BigQuery] (Lines 1-16):**\n- Sets up Spark configuration to use BigQuery connector.\n- Specifies the paths for necessary JAR files.\n- Configures Spark to enable views and sets materialization project and dataset.\n- Sets a temporary Google Cloud Storage bucket for intermediate data storage.\n\n**[Function to create a BigQuery table] (Lines 17-23):**\n- Defines a function to read data from a source BigQuery table.\n- Writes the data to a target BigQuery table, overwriting any existing data.\n\n**[Function to create a GCS table] (Lines 24-29):**\n- Defines a function to read data from a source BigQuery table.\n- Writes the data to a specified Google Cloud Storage path in Parquet format, overwriting any existing data.\n\n**[Create GCS tables for training, validation, and test datasets] (Lines 30-38):**\n- Specifies source BigQuery tables and target GCS paths for training, validation, and test datasets.\n- Calls the function to create GCS tables for each dataset, storing them in the specified paths.",
    "rmr_agent/repos/bt-retry-v2/model-dev/train.py": "**[Import necessary libraries and set display options] (Lines 6-21):**\n- Imports various libraries such as os, json, joblib, numpy, pandas, lightgbm, optuna, and mlflow.\n- Sets display options for pandas to control the display of rows, column width, and float format.\n\n**[Define helper functions] (Lines 22-61):**\n- Defines functions to save and read lists and dictionaries to/from text and JSON files.\n- Defines a function to convert column types in a pandas DataFrame to specific data types.\n\n**[Define metric functions] (Lines 66-138):**\n- Imports necessary libraries for metrics.\n- Defines functions to calculate precision at a given recall, threshold at a given recall, savings at a given recall, partial area under the PR curve, and evaluate a list of metrics.\n\n**[Set up feature paths and load data] (Lines 153-172):**\n- Defines paths for feature files and data files.\n- Loads feature lists from text files and data from parquet files into pandas DataFrames.\n\n**[Define column types and target column] (Lines 175-258):**\n- Specifies which columns are numerical, integer, categorical, and the target column.\n- Combines all feature columns into a single list.\n\n**[Convert data types and extract features and target] (Lines 265-276):**\n- Converts data types of columns in the training and validation DataFrames.\n- Extracts feature matrices and target vectors from the training and validation DataFrames.\n\n**[Train LightGBM model and evaluate metrics] (Lines 278-309):**\n- Defines best parameters for the model.\n- Trains a LightGBM model on the training data.\n- Predicts probabilities on the validation data and evaluates metrics.\n- Saves the trained model and plots feature importance.\n\n**[Set up Optuna for hyperparameter tuning] (Lines 312-367):**\n- Defines paths and settings for Optuna study.\n- Sets up MLflow tracking.\n- Defines the objective function for Optuna, which includes training a LightGBM model, evaluating metrics, and logging parameters and metrics to MLflow.\n- Runs the Optuna study to optimize hyperparameters and saves the study results.",
    "rmr_agent/repos/bt-retry-v2/model-dev/evaluate.py": "**Import necessary libraries and configure plotting style (Lines 6-15):**\n- Imports essential libraries for data manipulation, plotting, and machine learning.\n- Configures the plotting style and figure size.\n\n**Define utility functions for file operations (Lines 18-42):**\n- Functions to save and read lists and dictionaries to/from text and JSON files.\n\n**Define function to convert column types in a DataFrame (Lines 43-56):**\n- Converts specified columns in a DataFrame to categorical, float, or integer types.\n\n**Define metric calculation functions (Lines 61-147):**\n- Functions to calculate various metrics such as precision at a given recall, threshold at recall, savings at recall, retry success rate, partial AUC, and evaluate a list of metrics.\n\n**Define functions to handle features and target extraction (Lines 147-149):**\n- Function to extract feature matrix and target vector from a DataFrame.\n\n**Define partial functions for specific metrics (Lines 151-163):**\n- Partial functions for precision and savings at specific recall values, and partial AUC for recall values greater than 0.9.\n\n**Set paths and load data (Lines 166-174):**\n- Defines paths for data and model files.\n- Loads the dataset from a specified path.\n\n**Define columns and convert data types (Lines 177-254):**\n- Specifies numerical, integer, and categorical columns.\n- Converts the data types of these columns in the dataset.\n\n**Load features and models (Lines 256-259):**\n- Loads feature lists and pre-trained LightGBM models from specified paths.\n\n**Predict and evaluate metrics for V1 and V2 models (Lines 261-267):**\n- Predicts scores using V1 and V2 models.\n- Evaluates metrics for these predictions.\n\n**Calculate additional metrics and scores (Lines 268-285):**\n- Calculates retry success rate, savings, precision, recall, and AUC for V1 and V2 models.\n\n**Create DataFrames for metrics (Lines 286-288):**\n- Creates DataFrames to store evaluated metrics for V1 and V2 models.\n\n**Define function to evaluate metrics by segment (Lines 290-298):**\n- Function to evaluate metrics for different segments of the data.\n\n**Evaluate metrics by segment (Lines 300-308):**\n- Evaluates metrics by primary response type and retry strategy type for V1 and V2 models.\n\n**Plot precision-recall curves (Lines 309-351):**\n- Plots precision-recall curves for V1 and V2 models, and by retry strategy and primary response type.\n\n**Plot precision-recall curves by retry strategy and decline type (Lines 352-377):**\n- Plots precision-recall curves for V1 and V2 models by retry strategy and primary response type.\n\n**Export validation data (Lines 378-383):**\n- Exports a subset of the data as a CSV file for model validation.",
    "rmr_agent/repos/bt-retry-v2/deployment/01_export_to_ume.py": "**Import necessary libraries (Lines 3-4):**\n- Imports the `json` library for handling JSON data.\n- Imports the `lightgbm` library for working with LightGBM models.\n\n**Define utility function to read text file into list (Lines 5-11):**\n- Defines a function `list_from_txt` that reads a file from a given path and returns a list of its lines.\n\n**Load feature names from file (Lines 13-14):**\n- Specifies the path to the features file.\n- Uses the `list_from_txt` function to load feature names into the `FEATURES` list.\n\n**Define categorical columns (Lines 15-36):**\n- Lists the names of categorical columns used in the model.\n\n**Load LightGBM model from file (Line 39):**\n- Loads a LightGBM model from a specified text file.\n\n**Prepare model for export (Lines 42-49):**\n- Sets a name for the model files.\n- Dumps the model into a JSON format.\n- Adds categorical feature names to the JSON.\n- Writes the JSON model to a file.\n\n**Transform model to UME format (Lines 51-56):**\n- Imports `LightGBMTransformer` from `pyScoring`.\n- Creates a `LightGBMTransformer` object using the JSON model file.\n- Generates a binary specification for the model.\n- Saves the binary specification to a specified output path.",
    "rmr_agent/repos/bt-retry-v2/deployment/02_pyscoring_validation.py": "**Import necessary libraries and modules (Lines 2-9):**\n- Imports various libraries and modules required for the script, including `pyScoring`, `pandas`, `numpy`, and custom modules for model building and validation.\n\n**Define numerical, integer, and categorical columns (Lines 12-83):**\n- Specifies lists of column names categorized into numerical, integer, and categorical types for data processing.\n\n**Define target column (Line 84):**\n- Sets the target column for the model as `retry_is_success`.\n\n**Function to convert column types (Lines 85-98):**\n- Defines a function to convert columns in a DataFrame to appropriate data types: categorical columns to `pd.Categorical`, numerical columns to `np.float64`, and integer columns to `np.int64`.\n\n**Set model directory and name (Lines 99-101):**\n- Specifies the directory and name for the model files.\n\n**Start semi-automatic transformation (Line 103):**\n- Initiates the semi-automatic transformation process using the specified model directory and name.\n\n**Load and preprocess validation sample (Lines 105-111):**\n- Loads a validation sample from a CSV file, converts its column types using the previously defined function, and prepares it for validation.\n\n**Function to read features from a text file (Lines 113-119):**\n- Defines a function to read a list of features from a specified text file.\n\n**Load features list (Line 120):**\n- Loads the list of features from a specified text file into a variable.\n\n**Load UME model and make predictions (Lines 122-125):**\n- Loads the UME model from a file and makes predictions on the validation sample.\n\n**Filter predictions and save to CSV (Lines 127-130):**\n- Filters the predictions to remove rows with missing values in the `mcc_code` column and saves the first 5000 rows to a CSV file.\n\n**Iterate over samples for individual predictions (Lines 133-135):**\n- Iterates over the first 10 samples in the validation set, converting each sample to a dictionary format.\n\n**Validate model predictions (Line 136):**\n- Validates the model predictions by comparing them to expected values, allowing for a small delta."
  },
  "cleaned_code": {
    "rmr_agent/repos/bt-retry-v2/etl/01_etl.py": "   1 | # %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n   2 | # %config PPMagics.autolimit=0\n   3 | # # 1. Pull Base Transactions\n   4 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions;\n   5 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions as\n   6 | (\n   7 |     select *\n   8 |     from pypl-edl.braintree_raw_tables.gateway_transactions\n   9 |     where retried_transaction_fk is not null\n  10 |     and strategy_type in ('PAN', 'NO_AVS', 'NETWORK_TOKENIZATION', 'ABU') -- the set of available strategies may change in the future \n  11 |     and created_at between '2023-08-15' and '2025-01-02'  -- date range\n  12 |     and abs(mod(farm_fingerprint(cast(retried_transaction_fk as string)), 1000)) < 15  -- random sampling factor\n  13 | );\n  14 | select count(*), min(created_at), max(created_at)\n  15 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions\n  16 | # # 2. Categorize Decline Codes, Pull Primary Retry Transactions\n  17 | create temp function IsHardDecline(code STRING)\n  18 |     returns STRING\n  19 |     as (IF(code in ('2004','2005','2006','2007','2008','2009','2010','2011','2012','2013','2014','2015',\n  20 |                     '2017','2018','2019','2020','2021','2022','2023','2024','2027','2028','2029','2030',\n  21 |                     '2031','2032','2033','2036','2037','2039','2041','2043','2044','2045','2047','2049',\n  22 |                     '2050','2051','2052','2053','2054','2055','2056','2058','2059','2060','2061','2063',\n  23 |                     '2064','2065','2066','2067','2068','2069','2070','2071','2072','2073','2074','2075',\n  24 |                     '2076','2077','2079','2081','2082','2083','2084','2085','2086','2087','2088','2089',\n  25 |                     '2090','2091','2093','2094','2095','2096','2097','2098','2100', '2107', '2108'), -- ADDED '2107', '2108'\n  26 |            'Y', 'N'));\n  27 | create temp function IsSoftDecline(code STRING)\n  28 |     returns STRING\n  29 |     as (IF((code in ('2002','2003','2016','2025', -- DELETED '2000','2001'\n  30 |                      '2026','2034','2035','2038','2040','2042',\n  31 |                      '2046','2048','2057','2062','2092','2099',\n  32 |                      '2101', '2102','2103','2104','2105','2106','3000')) -- ADDED ,'2101', '2102','2103','2104','2105','2106','3000'\n  33 |            or ((code >= '2109') and (code < '3000')), -- CHANGED > '2100' to >= '2109'\n  34 |            'Y', 'N'));\n  35 | create temp function IsDecline(code STRING)\n  36 |     returns STRING\n  37 |     as (IF((code >= '2000') and (code < '3000'), 'Y', 'N'));\n  38 | create temp function IsSuccess(code STRING)\n  39 |     returns STRING\n  40 |     as (IF(code in ('1000','1001','1002','1003'), 'Y', 'N'));\n  41 | create temp function IsNoHonor(code STRING)\n  42 |     returns STRING\n  43 |     as (IF(code = '2000', 'Y', 'N'));\n  44 | create temp function IsNSF(code STRING)\n  45 |     returns STRING\n  46 |     as (IF(code = '2001', 'Y', 'N'));\n  47 | create temp function IsInvalidCC(code STRING)\n  48 |     returns STRING\n  49 |     as (IF(code = '2005', 'Y', 'N'));\n  50 | create temp function IsNetworkUnavailable(code STRING)\n  51 |     returns STRING\n  52 |     as (IF(code = '3000', 'Y', 'N'));\n  53 | create temp function IsRetry(retried_transaction_fk INT64)\n  54 |     returns STRING\n  55 |     as (IF(retried_transaction_fk is null, 'N', 'Y'));\n  56 | create temp function ResponseType(code STRING)\n  57 |     returns STRING\n  58 |     as\n  59 |         (case\n  60 |             when code is null then 'NULL'\n  61 |             when IsSuccess(code) = 'Y' then 'SUCCESS'\n  62 |             when IsNoHonor(code) = 'Y' then 'NO HONOR'\n  63 |             when IsNSF(code) = 'Y' then 'NSF'\n  64 |             when IsInvalidCC(code) = 'Y' then 'INVALID CC'\n  65 |             when (IsSoftDecline(code) = 'Y' and IsNSF(code) = 'N' and IsNoHonor(code) = 'N') then 'SOFT OTHER'\n  66 |             when (IsHardDecline(code) = 'Y' and IsInvalidCC(code) = 'N') then 'HARD OTHER'\n  67 |             else 'OTHER'\n  68 |         end);\n  69 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions;\n  70 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions as\n  71 | (\n  72 |     select\n  73 |         date(pri.created_at) as dt,\n  74 |         -- other\n  75 |         case when pri.cvv_response_code='M' then 1 else 0 end  as is_cvv_present,\n  76 |         pri.recurring as recurring,\n  77 |         pri.vaulted_credential_type as vaulted_credential_type,\n  78 |         -- amount fields\n  79 |         pri.currency_iso_code as currency_iso_code,\n  80 |         pri.amount_requested as amount_requested,\n  81 |         pri.amount_authorized as amount_authorized,\n  82 |         pri.amount_submitted_for_settlement as amount_submitted_for_settlement,\n  83 |         pri.cdc_shard,\n  84 |         -- pmt method fields\n  85 |         pri.cdc_original_payment_method_fk as cdc_original_payment_method_fk,\n  86 |         pri.payment_instrument_detail_fk as payment_instrument_detail_fk,\n  87 |         pri.payment_method_fk as payment_method_fk,\n  88 |         pmt.token as payment_method_token, -- ADDED\n  89 |         pmt.payment_instrument_type, -- ADDED \n  90 |         -- customer fields\n  91 |         pri.cdc_original_customer_fk as cdc_original_customer_fk,\n  92 |         -- merchant fields\n  93 |         pri.cdc_original_merchant_account_fk as cdc_original_merchant_account_fk,\n  94 |         pri.merchant_account_fk as merchant_account_fk,\n  95 |         pri.merchant_fk as merchant_fk,\n  96 |         merc.company_name as company_name,\n  97 |         merc.country_name as merchant_country, -- ADDED \n  98 |         -- merchant acc fields (ADDED) \n  99 |         -- merc_acc.token as merchant_account_token, \n 100 |         -- merc_acc.kind as merchant_account_kind, \n 101 |         -- primary fields\n 102 |         ---- ids and strategy\n 103 |         pri.pk as primary_txn_id,\n 104 |         pri.public_id as primary_public_id,\n 105 |         pri.strategy_type as primary_strategy_type,\n 106 |         ---- NT fields\n 107 |         pri.created_using_token as primary_created_using_token,\n 108 |         nte.enrollment_id,  -- ADDED \n 109 |         nte.enrollment_status, -- ADDED \n 110 |         nte.token_status, -- ADDED \n 111 |         ---- processor fields\n 112 |         pri.cdc_original_processor_settings_fk as cdc_original_processor_settings_fk,\n 113 |         pri.processor_response_code as primary_processor_response_code,\n 114 |         pri.processor_settings_fk as primary_processor_settings_fk,\n 115 |         pri.processor_settings_type as primary_processor_settings_type,\n 116 |         -- status fields\n 117 |         ResponseType(pri.processor_response_code) as primary_response_type,\n 118 |         -- retry fields\n 119 |         ---- ids and strategy\n 120 |         ---- NEW STUFF -----------------------\n 121 |         rank() over (partition by retry.retried_transaction_fk order by retry.created_at asc) as retry_order,\n 122 |         --------------------------------------\n 123 |         retry.pk as retry_txn_id,\n 124 |         retry.public_id as retry_public_id,\n 125 |         retry.strategy_type as retry_strategy_type,\n 126 |         ---- NT fields\n 127 |         retry.created_using_token as retry_created_using_token,\n 128 |         ---- processor fields\n 129 |         retry.cdc_original_processor_settings_fk as retry_cdc_original_processor_settings_fk,\n 130 |         retry.processor_response_code as retry_processor_response_code,\n 131 |         retry.processor_settings_fk as retry_processor_settings_fk,\n 132 |         retry.processor_settings_type as retry_processor_settings_type,\n 133 |         -- status fields\n 134 |         ResponseType(retry.processor_response_code) as retry_response_type,\n 135 |         -- add binary & string label directly\n 136 |         if(ResponseType(retry.processor_response_code) = 'SUCCESS', 'Y', 'N') as retry_is_success_y_n,\n 137 |         if(ResponseType(retry.processor_response_code) = 'SUCCESS', 1, 0) as retry_is_success\n 138 |     from\n 139 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions retry\n 140 |     -- trying inner join directly with gateway txns\n 141 |     inner join\n 142 |         -- date range\n 143 |         (select * from pypl-edl.braintree_raw_tables.gateway_transactions where created_at between '2023-01-01' and '2025-01-02') pri\n 144 |     on\n 145 |         retry.retried_transaction_fk = pri.pk\n 146 |     -- trying join directly with authy merchants\n 147 |     left join\n 148 |         pypl-edl.braintree_raw_tables.authy_merchants merc\n 149 |     on\n 150 |         retry.merchant_fk = merc.pk\n 151 |     -- to get payment method fields\n 152 |     left join \n 153 |         pypl-edl.braintree_raw_tables.gateway_payment_methods pmt\n 154 |     on \n 155 |         retry.payment_method_fk = pmt.pk\n 156 |     and \n 157 |         pmt.payment_instrument_type='CreditCard'\n 158 |     -- to get NT enrollment fields\n 159 |     left join \n 160 |         pypl-edl.braintree_raw_tables.gateway_credit_cards cd\n 161 |     on \n 162 |         pmt.payment_instrument_fk = cd.pk -- CHECK THIS LOGIC\n 163 |     left join \n 164 |         pypl-edl.braintree_raw_tables.gateway_network_tokenization_enrollments nte\n 165 |     on \n 166 |         nte.pk = cd.enrollment_fk\n 167 | );\n 168 | select count(*), min(dt), max(dt)\n 169 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions\n 170 | select \n 171 |     primary_response_type,\n 172 |     count(*) as n,\n 173 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n 174 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions\n 175 | group by 1\n 176 | # # 3. Get CC RADD Features\n 177 | /* 1. Add FX info for amount in USD */\n 178 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset;\n 179 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset as\n 180 | (\n 181 |     select\n 182 |         retry.dt as dt,\n 183 |         retry.is_cvv_present as is_cvv_present,\n 184 |         retry.recurring as recurring,\n 185 |         retry.vaulted_credential_type as vaulted_credential_type,\n 186 |         retry.currency_iso_code as setec_currency_code,\n 187 |         retry.amount_requested as amount_requested,\n 188 |         retry.amount_authorized as amount_authorized,\n 189 |         retry.amount_submitted_for_settlement as amount_submitted_for_settlement,\n 190 |         round(retry.amount_authorized * fx.site_exchng_rate / 100, 2) as setec_txn_amt_usd,\n 191 |         retry.cdc_shard as cdc_shard,\n 192 |         retry.cdc_original_payment_method_fk as cdc_original_payment_method_fk,\n 193 |         retry.payment_instrument_detail_fk as payment_instrument_detail_fk,\n 194 |         retry.payment_method_fk as payment_method_fk,\n 195 |         retry.cdc_original_customer_fk as cdc_original_customer_fk,\n 196 |         retry.cdc_original_merchant_account_fk as cdc_original_merchant_account_fk,\n 197 |         retry.merchant_account_fk as merchant_account_fk,\n 198 |         retry.merchant_fk as merchant_fk,\n 199 |         retry.merchant_country as merchant_country,\n 200 |         retry.company_name as company_name,\n 201 |         retry.primary_txn_id as primary_txn_id,\n 202 |         retry.primary_public_id as primary_public_id,\n 203 |         retry.primary_strategy_type as primary_strategy_type,\n 204 |         retry.primary_created_using_token as primary_created_using_token,\n 205 |         retry.payment_method_token, \n 206 |         retry.payment_instrument_type, \n 207 |         retry.token_status, \n 208 |         retry.enrollment_status, \n 209 |         retry.enrollment_id,\n 210 |         retry.cdc_original_processor_settings_fk as primary_cdc_original_processor_settings_fk,\n 211 |         retry.primary_processor_response_code as primary_processor_response_code,\n 212 |         retry.primary_processor_settings_fk as primary_processor_settings_fk,\n 213 |         retry.primary_processor_settings_type as primary_processor_settings_type,\n 214 |         retry.primary_response_type as primary_response_type,\n 215 |         retry.retry_order as retry_order,\n 216 |         retry.retry_txn_id as retry_txn_id,\n 217 |         retry.retry_public_id as retry_public_id,\n 218 |         retry.retry_strategy_type as retry_strategy_type,\n 219 |         retry.retry_created_using_token as retry_created_using_token,\n 220 |         retry.retry_cdc_original_processor_settings_fk as retry_cdc_original_processor_settings_fk,\n 221 |         retry.retry_processor_response_code as retry_processor_response_code,\n 222 |         retry.retry_processor_settings_fk as retry_processor_settings_fk,\n 223 |         retry.retry_processor_settings_type as retry_processor_settings_type,\n 224 |         retry.retry_response_type as retry_response_type,\n 225 |         retry.retry_is_success_y_n as retry_is_success_y_n,\n 226 |         retry.retry_is_success as retry_is_success\n 227 |     from\n 228 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions retry\n 229 |     left join\n 230 |         (select exchng_rate_dt, from_curr_code, site_exchng_rate from pypl-edw.pp_access_views.dim_curr_exchng_rate_dly where to_curr_code = 'USD') fx\n 231 |     on\n 232 |         retry.dt - 1 = fx.exchng_rate_dt\n 233 |     and\n 234 |         retry.currency_iso_code = fx.from_curr_code\n 235 | );\n 236 | /* 2. Join with CC details table for CC features */\n 237 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc;\n 238 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc as\n 239 | (\n 240 |     select\n 241 |         retry.dt,\n 242 |         retry.is_cvv_present, -- RENAMED\n 243 |         retry.recurring,\n 244 |         retry.vaulted_credential_type,\n 245 |         retry.setec_currency_code,\n 246 |         retry.amount_requested,\n 247 |         retry.amount_authorized,\n 248 |         retry.amount_submitted_for_settlement,\n 249 |         retry.setec_txn_amt_usd,\n 250 |         retry.cdc_shard,\n 251 |         retry.cdc_original_payment_method_fk,\n 252 |         retry.payment_instrument_detail_fk,\n 253 |         retry.payment_method_fk,\n 254 |         retry.cdc_original_customer_fk,\n 255 |         retry.cdc_original_merchant_account_fk,\n 256 |         retry.merchant_account_fk,\n 257 |         retry.merchant_fk,\n 258 |         retry.merchant_country, \n 259 |         retry.company_name,\n 260 |         retry.primary_txn_id,\n 261 |         retry.primary_public_id,\n 262 |         retry.primary_strategy_type,\n 263 |         retry.primary_created_using_token,\n 264 |         retry.payment_method_token, \n 265 |         retry.payment_instrument_type, \n 266 |         retry.token_status, \n 267 |         retry.enrollment_status, \n 268 |         retry.enrollment_id,\n 269 |         retry.primary_cdc_original_processor_settings_fk,\n 270 |         retry.primary_processor_response_code,\n 271 |         retry.primary_processor_settings_fk,\n 272 |         retry.primary_processor_settings_type,\n 273 |         retry.primary_response_type,\n 274 |         retry.retry_order,\n 275 |         retry.retry_txn_id,\n 276 |         retry.retry_public_id,\n 277 |         retry.retry_strategy_type,\n 278 |         retry.retry_created_using_token,\n 279 |         retry.retry_cdc_original_processor_settings_fk,\n 280 |         retry.retry_processor_response_code,\n 281 |         retry.retry_processor_settings_fk,\n 282 |         retry.retry_processor_settings_type,\n 283 |         retry.retry_response_type,\n 284 |         -- CC context attributes\n 285 |         cc.pk as cc_pk,\n 286 |         cc.type as cc_type,\n 287 |         cc.issuing_bank as cc_issuing_bank,\n 288 |         cc.bin as cc_bin,\n 289 |         cc.postal_code as cc_postal_code,\n 290 |         cc.country_name as cc_country_name,\n 291 |         cc.country_of_issuance as cc_country_of_issuance,\n 292 |         cc.expiration_date as cc_exp_date,        \n 293 |         cc.debit as cc_debit,\n 294 |         cc.prepaid as cc_prepaid,\n 295 |         cc.pan_guid as cc_pan_guid,\n 296 |         cc.created_at as cc_created_at,\n 297 |         -- binary target\n 298 |         retry.retry_is_success_y_n,\n 299 |         retry.retry_is_success\n 300 |     from\n 301 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset retry\n 302 |     left join\n 303 |         (select\n 304 |              pk,\n 305 |              type,\n 306 |              issuing_bank,\n 307 |              bin,\n 308 |              postal_code,\n 309 |              country_name,\n 310 |              country_of_issuance,\n 311 |              expiration_date,\n 312 |              debit,\n 313 |              prepaid,\n 314 |              pan_guid,\n 315 |              created_at\n 316 |          from\n 317 |              pypl-edl.braintree_raw_tables.gateway_credit_card_details where pk is not null) cc\n 318 |     on\n 319 |         retry.payment_instrument_detail_fk = cc.pk\n 320 | );\n 321 | /* 3. Rename features to match model variable names */\n 322 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed;\n 323 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed as\n 324 | (\n 325 |     select\n 326 |         dt,\n 327 |         is_cvv_present, -- RENAMED\n 328 |         recurring as is_recurring_txn, -- RENAMED\n 329 |         vaulted_credential_type,\n 330 |         setec_currency_code,\n 331 |         amount_requested,\n 332 |         amount_authorized,\n 333 |         amount_submitted_for_settlement,\n 334 |         setec_txn_amt_usd,\n 335 |         cdc_shard as shard, -- RENAMED\n 336 |         cdc_original_payment_method_fk as original_payment_method_fk, -- RENAMED\n 337 |         payment_instrument_detail_fk,\n 338 |         payment_method_fk,\n 339 |         cdc_original_customer_fk,\n 340 |         cdc_original_merchant_account_fk as original_merchant_account_fk, -- RENAMED\n 341 |         merchant_account_fk,\n 342 |         merchant_fk,\n 343 |         company_name,\n 344 |         merchant_country, -- ADDED\n 345 |         primary_txn_id,\n 346 |         primary_public_id,\n 347 |         primary_strategy_type,\n 348 |         primary_created_using_token,\n 349 |         payment_method_token, \n 350 |         payment_instrument_type, \n 351 |         token_status, \n 352 |         enrollment_status, \n 353 |         enrollment_id,\n 354 |         primary_cdc_original_processor_settings_fk as original_processor_settings_fk, -- RENAMED\n 355 |         primary_processor_response_code,\n 356 |         primary_processor_settings_fk as processor_settings_fk, -- RENAMED\n 357 |         primary_processor_settings_type as processor_settings_type, -- RENAMED\n 358 |         primary_response_type,\n 359 |         retry_order,\n 360 |         retry_txn_id,\n 361 |         retry_public_id,\n 362 |         retry_strategy_type,\n 363 |         retry_created_using_token,\n 364 |         retry_cdc_original_processor_settings_fk,\n 365 |         retry_processor_response_code,\n 366 |         retry_processor_settings_fk,\n 367 |         retry_processor_settings_type,\n 368 |         retry_response_type,\n 369 |         cc_pk,\n 370 |         cc_type as card_type, -- RENAMED\n 371 |         cc_issuing_bank as issuer, -- RENAMED\n 372 |         cc_bin as bin, -- RENAMED\n 373 |         cc_postal_code,\n 374 |         cc_country_name,\n 375 |         cc_country_of_issuance as issuer_cntry_code, -- RENAMED\n 376 |         cc_exp_date,        \n 377 |         cc_debit,\n 378 |         if(cc_debit is True, 'debit', 'credit') as fi_usage,\n 379 |         cc_prepaid,\n 380 |         cc_pan_guid as pan_guid, -- RENAMED\n 381 |         cc_created_at,\n 382 |         retry_is_success_y_n,\n 383 |         retry_is_success\n 384 |     from\n 385 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc\n 386 | );\n 387 | # # 4. Get Bin, Strategy RADD Features\n 388 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset;\n 389 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset as\n 390 | (\n 391 |     select\n 392 |         retry.dt,\n 393 |         retry.is_cvv_present,\n 394 |         retry.is_recurring_txn,\n 395 |         retry.vaulted_credential_type,\n 396 |         retry.setec_currency_code,\n 397 |         retry.amount_requested,\n 398 |         retry.amount_authorized,\n 399 |         retry.amount_submitted_for_settlement,\n 400 |         retry.setec_txn_amt_usd,\n 401 |         retry.shard, -- RENAMED\n 402 |         retry.original_payment_method_fk, -- RENAMED\n 403 |         retry.payment_instrument_detail_fk,\n 404 |         retry.payment_method_fk,\n 405 |         retry.cdc_original_customer_fk,\n 406 |         retry.original_merchant_account_fk, -- RENAMED\n 407 |         retry.merchant_account_fk,\n 408 |         retry.merchant_fk,\n 409 |         retry.merchant_country, -- ADDED\n 410 |         retry.company_name,\n 411 |         retry.primary_txn_id,\n 412 |         retry.primary_public_id,\n 413 |         retry.primary_strategy_type,\n 414 |         retry.primary_created_using_token,\n 415 |         retry.payment_method_token, \n 416 |         retry.payment_instrument_type, \n 417 |         retry.token_status, \n 418 |         retry.enrollment_status, \n 419 |         retry.enrollment_id,\n 420 |         retry.original_processor_settings_fk, -- RENAMED\n 421 |         retry.primary_processor_response_code,\n 422 |         retry.processor_settings_fk, -- RENAMED\n 423 |         retry.processor_settings_type, -- RENAMED\n 424 |         retry.primary_response_type,\n 425 |         retry.retry_order,\n 426 |         retry.retry_txn_id,\n 427 |         retry.retry_public_id,\n 428 |         retry.retry_strategy_type,\n 429 |         retry.retry_created_using_token,\n 430 |         retry.retry_cdc_original_processor_settings_fk,\n 431 |         retry.retry_processor_response_code,\n 432 |         retry.retry_processor_settings_fk,\n 433 |         retry.retry_processor_settings_type,\n 434 |         retry.retry_response_type,\n 435 |         retry.cc_pk,\n 436 |         retry.card_type,\n 437 |         retry.issuer, -- RENAMED\n 438 |         retry.bin, -- RENAMED\n 439 |         retry.cc_postal_code,\n 440 |         retry.cc_country_name,\n 441 |         retry.issuer_cntry_code,-- RENAMED\n 442 |         retry.cc_exp_date,        \n 443 |         retry.cc_debit,\n 444 |         retry.fi_usage,\n 445 |         retry.cc_prepaid,\n 446 |         retry.pan_guid, -- RENAMED\n 447 |         retry.cc_created_at,\n 448 |         retry.retry_is_success_y_n,\n 449 |         retry.retry_is_success,\n 450 |         -- bin\n 451 |         bin.amt_pri_decline_ratio_6m as idi_bt_unbranded_retry_bin_rdd_amt_pri_decline_ratio_6m,\n 452 |         bin.amt_pri_success_ratio_21d as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_21d,\n 453 |         bin.amt_pri_success_ratio_3m as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_3m,\n 454 |         bin.amt_pri_success_ratio_7d as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_7d,\n 455 |         bin.amt_pri_success_ratio_nt_7d as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_nt_7d,\n 456 |         bin.cnt_pri_decline_ratio_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_decline_ratio_7d,\n 457 |         bin.cnt_pri_decline_ratio_nt_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_decline_ratio_nt_7d,\n 458 |         bin.cnt_pri_success_ratio_14d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d,\n 459 |         bin.cnt_pri_success_ratio_1m as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_1m,\n 460 |         bin.cnt_pri_success_ratio_6m as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_6m,\n 461 |         bin.cnt_pri_success_ratio_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d,\n 462 |         bin.cnt_pri_success_ratio_nt_14d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d,\n 463 |         bin.cnt_pri_success_ratio_nt_3m as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_3m,\n 464 |         bin.cnt_pri_success_ratio_nt_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d,\n 465 |         -- strategy\n 466 |         str.amt_retry_decline_ratio_post_nsf_7d as idi_bt_unbranded_retry_strategy_rdd_amt_retry_decline_ratio_post_nsf_7d,\n 467 |         str.amt_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_strategy_rdd_amt_retry_success_ratio_post_dnh_7d,\n 468 |         str.amt_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_amt_retry_success_ratio_post_hard_14d,\n 469 |         str.cnt_first_retry_success_ratio_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d,\n 470 |         str.cnt_first_retry_success_ratio_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d,\n 471 |         str.cnt_first_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d,\n 472 |         str.cnt_first_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d,\n 473 |         str.cnt_first_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d,\n 474 |         str.cnt_first_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d,\n 475 |         str.cnt_first_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d,\n 476 |         str.cnt_first_retry_success_ratio_post_nsf_1m as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_1m,\n 477 |         str.cnt_first_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d,\n 478 |         str.cnt_first_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d,\n 479 |         str.cnt_first_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d,\n 480 |         str.cnt_retry_decline_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_decline_ratio_post_hard_14d,\n 481 |         str.cnt_retry_success_ratio_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d,\n 482 |         str.cnt_retry_success_ratio_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d,\n 483 |         str.cnt_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d,\n 484 |         str.cnt_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d,\n 485 |         str.cnt_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d,\n 486 |         str.cnt_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d,\n 487 |         str.cnt_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d,\n 488 |         str.cnt_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d,\n 489 |         str.cnt_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d,\n 490 |         str.cnt_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d,\n 491 |         -- bin strategy\n 492 |         bin_str.amt_first_retry_decline_ratio_7d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_first_retry_decline_ratio_7d,\n 493 |         bin_str.amt_first_retry_decline_ratio_post_nsf_7d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_first_retry_decline_ratio_post_nsf_7d,\n 494 |         bin_str.amt_first_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_first_retry_success_ratio_post_hard_7d,\n 495 |         bin_str.amt_retry_decline_ratio_post_nsf_1m as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_decline_ratio_post_nsf_1m,\n 496 |         bin_str.amt_retry_decline_ratio_post_soft_1m as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_decline_ratio_post_soft_1m,\n 497 |         bin_str.amt_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_success_ratio_post_dnh_14d,\n 498 |         bin_str.amt_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_success_ratio_post_nsf_14d,\n 499 |         bin_str.cnt_first_retry_success_ratio_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d,\n 500 |         bin_str.cnt_first_retry_success_ratio_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d,\n 501 |         bin_str.cnt_first_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d,\n 502 |         bin_str.cnt_first_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d,\n 503 |         bin_str.cnt_first_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d,\n 504 |         bin_str.cnt_first_retry_success_ratio_post_hard_1m as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_1m,\n 505 |         bin_str.cnt_first_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d,\n 506 |         bin_str.cnt_first_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d,\n 507 |         bin_str.cnt_first_retry_success_ratio_post_nsf_1m as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_1m,\n 508 |         bin_str.cnt_first_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d,\n 509 |         bin_str.cnt_first_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d,\n 510 |         bin_str.cnt_first_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d,\n 511 |         bin_str.cnt_retry_decline_ratio_post_dnh_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_decline_ratio_post_dnh_7d,\n 512 |         bin_str.cnt_retry_success_ratio_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d,\n 513 |         bin_str.cnt_retry_success_ratio_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d,\n 514 |         bin_str.cnt_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d,\n 515 |         bin_str.cnt_retry_success_ratio_post_dnh_1m as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_1m,\n 516 |         bin_str.cnt_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d,\n 517 |         bin_str.cnt_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d,\n 518 |         bin_str.cnt_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d,\n 519 |         bin_str.cnt_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d,\n 520 |         bin_str.cnt_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d,\n 521 |         bin_str.cnt_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d,\n 522 |         bin_str.cnt_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\n 523 |     from\n 524 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed retry\n 525 |     left join\n 526 |         pypl-edw.pp_cmt_access_views.bt_unbranded_retry_bin bin\n 527 |     on\n 528 |         retry.bin = bin.bin\n 529 |     and\n 530 |         retry.dt = date(bin.dt)\n 531 |     left join\n 532 |         pypl-edw.pp_cmt_access_views.bt_unbranded_retry_strategy str\n 533 |     on\n 534 |         retry.retry_strategy_type = str.retry_strategy_type\n 535 |     and\n 536 |         retry.dt = date(str.dt)\n 537 |     left join\n 538 |         pypl-edw.pp_cmt_access_views.bt_unbranded_retry_bin_strategy bin_str\n 539 |     on\n 540 |         retry.bin = bin_str.bin\n 541 |     and\n 542 |         retry.retry_strategy_type = bin_str.retry_strategy_type\n 543 |     and\n 544 |         retry.dt = date(bin_str.dt)\n 545 | );\n 546 | # ## Convert BIGNUMERIC to Numeric\n 547 | select column_name, data_type\n 548 | from pypl-edw.pp_cmt_access_views.INFORMATION_SCHEMA.COLUMNS\n 549 | where table_name = 'bt_unbranded_retry_bin'\n 550 | order by data_type\n 551 | select column_name, data_type\n 552 | from pypl-bods.gds_pacman_prod.INFORMATION_SCHEMA.COLUMNS\n 553 | where table_name = 'bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast'\n 554 | order by data_type\n 555 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast;\n 556 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast as\n 557 | (\n 558 |     select \n 559 |     * except (setec_txn_amt_usd),\n 560 |     cast(setec_txn_amt_usd as float64) as setec_txn_amt_usd, \n 561 |     from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset\n 562 | ) \n 563 | select retry_strategy_type, count (*) \n 564 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\n 565 | where idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null \n 566 | group by 1\n 567 | select count(*), sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null then 1 else 0 end) \n 568 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\n 569 | with sub as ( select *\n 570 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\n 571 | where idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null \n 572 |  ) \n 573 | select \n 574 | sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d is null then 1 else 0 end) / count(*), \n 575 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d is null then 1 else 0 end) / count(*), \n 576 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d is null then 1 else 0 end) / count(*), \n 577 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d is null then 1 else 0 end) / count(*), \n 578 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 579 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 580 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 581 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 582 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 583 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 584 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 585 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 586 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 587 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 588 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 589 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 590 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 591 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 592 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 593 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 594 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 595 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 596 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 597 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 598 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 599 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 600 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 601 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 602 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 603 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 604 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 605 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 606 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 607 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 608 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 609 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 610 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 611 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 612 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 613 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 614 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 615 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 616 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 617 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 618 |   from sub\n 619 | select dt, sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end), count(*)\n 620 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\n 621 | group by 1\n 622 | order by 2 desc\n 623 | # # 5. Additional features in V1\n 624 | # ## Get 3DS Features from BT 3DS Verifications Table\n 625 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds;\n 626 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds as\n 627 | (\n 628 |     select \n 629 |         driver.*, \n 630 |         -- 3ds related features\n 631 |         tdsv.liability_shifted, \n 632 |         tdsv.liability_shift_possible,\n 633 |         case when tdsv.report_status = 'exemption_low_value_successful' then 1 \n 634 |              when tdsv.report_status = 'data_only_successful' then 1  \n 635 |              when tdsv.report_status = 'exemption_tra_successful' then 1 \n 636 |              when tdsv.report_status = 'authenticate_successful' then 1 \n 637 |              else 0 end as success_3ds\n 638 |     from \n 639 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast driver\n 640 |     left join \n 641 |         pypl-edl.braintree_raw_tables.gateway_three_d_secure_results tdsr\n 642 |     on \n 643 |         tdsr.requester_fk = driver.primary_txn_id \n 644 |     and \n 645 |         tdsr.requester_type = 'Transaction'\n 646 |     left join \n 647 |         pypl-edl.braintree_raw_tables.gateway_three_d_secure_verifications tdsv\n 648 |     on \n 649 |         tdsr.three_d_secure_verification_public_id = tdsv.public_id\n 650 | ) \n 651 | select \n 652 |     success_3ds, \n 653 |     count(*) as n,\n 654 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n 655 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds \n 656 | group by 1 \n 657 | # ## Get Verification Feature from linking verification with payment method, then to transaction\n 658 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver;\n 659 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver as\n 660 | (\n 661 |     select \n 662 |         base.*, \n 663 |         case when ver.pk is not null then 1 else 0 end as verifications_txn \n 664 |         --ver.pk as verification_pmt_method\n 665 |     from \n 666 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds base\n 667 |     left join \n 668 |         pypl-edl.braintree_raw_tables.gateway_verifications ver\n 669 |     on \n 670 |         base.payment_method_fk = ver.payment_method_fk\n 671 |     and \n 672 |         base.merchant_fk = ver.merchant_fk \n 673 |     and \n 674 |         base.dt = date(ver.created_at)\n 675 |     and \n 676 |         ver.status = 'verified'\n 677 | ) \n 678 | select status, count(*)\n 679 | from pypl-edl.braintree_raw_tables.gateway_verifications \n 680 | group by 1\n 681 | order by 2 desc \n 682 | limit 10 \n 683 | select sum(verifications_txn) / count(*) * 100\n 684 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver\n 685 | # ## Get Fastlane Feature from gateway_vaulted_payment_method_grants table\n 686 | #\n 687 | # - payment_method_fk found in gateway_vaulted_payment_method_grants denotes Fastlane transaction\n 688 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl;\n 689 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl as\n 690 | (\n 691 |     select \n 692 |         base.*, \n 693 |         case when fl.pk is not null then 1 else 0 end as fastlane_txn \n 694 |     from \n 695 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver base\n 696 |     left join \n 697 |         pypl-edl.braintree_raw_tables.gateway_vaulted_payment_method_grants fl\n 698 |     on \n 699 |         base.payment_method_fk = fl.payment_method_fk\n 700 |     and \n 701 |         base.merchant_fk = fl.merchant_fk \n 702 |     and \n 703 |         base.dt = date(fl.created_at)\n 704 | ) \n 705 | # ## Get mcc_code\n 706 | select processor_settings_type, count(*)\n 707 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl\n 708 | group by 1\n 709 | -- base population of all txns \n 710 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc ;\n 711 | create table if not exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc as\n 712 | (\n 713 |     select\n 714 |          b.*, \n 715 |         case when processor_settings_type = 'Salem::Settings' then salem.mcc\n 716 |         when processor_settings_type = 'Adyen::Settings' then adyen.merchant_category_code\n 717 |         when processor_settings_type = 'WorldPay::Settings'then wp.merchant_category_code\n 718 |         when processor_settings_type = 'FirstData::Settings'then fd.merchant_category_code\n 719 |         when processor_settings_type = 'VisaDirect::Settings'then vd.merchant_category_code\n 720 |         when processor_settings_type = 'MastercardDirect::Settings'then md.country_code\n 721 |         when processor_settings_type = 'Integrations::Settings' then i.merchant_category_code\n 722 |         when processor_settings_type = 'AIB::Settings' then aib.merchant_category_code\n 723 |         when processor_settings_type = 'CardProcessor::Settings' then cp.merchant_category_code\n 724 |         when processor_settings_type = 'OmnipayDirect::Settings' then od.merchant_category_code\n 725 |         when processor_settings_type = 'AmexDirect::Settings' then amex.merchant_category_code\n 726 |         when processor_settings_type = 'PayPalClosedLoop::Settings' then ppcl.merchant_category_code\n 727 |         when processor_settings_type = 'Tsys::Settings' then tsys.merchant_category_code \n 728 |         when processor_settings_type = 'Nab::Settings' then nab.merchant_category_code\n 729 |         when processor_settings_type = 'Moneris::Settings' then moneris.merchant_category_code\n 730 |         when processor_settings_type = 'CustomActions::Settings' then ca.merchant_category_code \n 731 |         else null end as mcc_code, \n 732 |     from\n 733 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl  b \n 734 |     left join \n 735 |         pypl-edl.braintree_raw_tables.gateway_salem_settings salem\n 736 |     on \n 737 |         b.processor_settings_fk = salem.pk \n 738 |     and \n 739 |         b.processor_settings_type = 'Salem::Settings'\n 740 |     left join \n 741 |         pypl-edl.braintree_raw_tables.gateway_adyen_settings adyen\n 742 |     on \n 743 |         b.processor_settings_fk = adyen.pk \n 744 |     and \n 745 |         b.processor_settings_type = 'Adyen::Settings'\n 746 |     left join \n 747 |         pypl-edl.braintree_raw_tables.gateway_world_pay_settings wp\n 748 |     on \n 749 |         b.processor_settings_fk = wp.pk \n 750 |     and \n 751 |         b.processor_settings_type = 'WorldPay::Settings'\n 752 |     left join \n 753 |         pypl-edl.braintree_raw_tables.gateway_first_data_settings fd\n 754 |     on \n 755 |         b.processor_settings_fk = fd.pk \n 756 |     and \n 757 |         b.processor_settings_type = 'FirstData::Settings'\n 758 |     left join \n 759 |     (\n 760 |         select \n 761 |             i_sub.pk, \n 762 |             amex.merchant_category_code,\n 763 |             amex.acquirer_country\n 764 |         from\n 765 |             pypl-edl.braintree_raw_tables.gateway_integrations_settings i_sub\n 766 |         left join \n 767 |             pypl-edl.braintree_raw_tables.gateway_amex_direct_settings amex\n 768 |         on \n 769 |             i_sub.gateway_amex_direct_settings_fk = amex.pk \n 770 |     ) i\n 771 |     on \n 772 |         b.processor_settings_fk = i.pk \n 773 |     and \n 774 |         b.processor_settings_type = 'Integrations::Settings'\n 775 |     left join \n 776 |     ( select \n 777 |          v.pk, \n 778 |          fd.merchant_category_code,\n 779 |          fd.country_code\n 780 |     from\n 781 |         pypl-edl.braintree_raw_tables.gateway_visa_direct_settings v \n 782 |     inner join \n 783 |         pypl-edl.braintree_raw_tables.gateway_first_data_settings fd\n 784 |     on \n 785 |         v.first_data_settings_fk = fd.pk ) vd\n 786 |     on \n 787 |         b.processor_settings_fk = vd.pk \n 788 |     and \n 789 |         b.processor_settings_type = 'VisaDirect::Settings'\n 790 |         left join \n 791 |     ( select \n 792 |          m.pk, \n 793 |          fd.merchant_category_code,\n 794 |          fd.country_code\n 795 |     from\n 796 |         pypl-edl.braintree_raw_tables.gateway_mastercard_direct_settings m\n 797 |     inner join \n 798 |         pypl-edl.braintree_raw_tables.gateway_first_data_settings fd\n 799 |     on \n 800 |         m.first_data_settings_fk = fd.pk ) md\n 801 |     on \n 802 |         b.processor_settings_fk = md.pk \n 803 |     and \n 804 |         b.processor_settings_type = 'MastercardDirect::Settings'\n 805 |     left join \n 806 |         pypl-edl.braintree_raw_tables.gateway_aib_settings aib\n 807 |     on \n 808 |         b.processor_settings_fk = aib.pk \n 809 |     and \n 810 |         b.processor_settings_type = 'AIB::Settings'\n 811 |     left join \n 812 |         pypl-edl.braintree_raw_tables.gateway_card_processor_settings cp\n 813 |     on \n 814 |         b.processor_settings_fk = cp.pk \n 815 |     and \n 816 |         b.processor_settings_type = 'CardProcessor::Settings'\n 817 |     left join \n 818 |         pypl-edl.braintree_raw_tables.gateway_omnipay_direct_settings od\n 819 |     on \n 820 |         b.processor_settings_fk = od.pk \n 821 |     and \n 822 |         b.processor_settings_type = 'OmnipayDirect::Settings'\n 823 |     left join \n 824 |         pypl-edl.braintree_raw_tables.gateway_amex_direct_settings amex\n 825 |     on \n 826 |         b.processor_settings_fk = amex.pk \n 827 |     and \n 828 |         b.processor_settings_type = 'AmexDirect::Settings'\n 829 |     left join \n 830 |         pypl-edl.braintree_raw_tables.gateway_nab_settings nab\n 831 |     on \n 832 |         b.processor_settings_fk = nab.pk \n 833 |     and \n 834 |         b.processor_settings_type = 'Nab::Settings'\n 835 |     left join \n 836 |         pypl-edl.braintree_raw_tables.gateway_moneris_settings moneris\n 837 |     on \n 838 |         b.processor_settings_fk = moneris.pk \n 839 |     and \n 840 |         b.processor_settings_type = 'Moneris::Settings'\n 841 |     left join \n 842 |         pypl-edl.braintree_raw_tables.gateway_paypal_closed_loop_settings ppcl\n 843 |     on \n 844 |         b.processor_settings_fk = ppcl.pk \n 845 |     and \n 846 |         b.processor_settings_type = 'PayPalClosedLoop::Settings'\n 847 |     left join \n 848 |         pypl-edl.braintree_raw_tables.gateway_tsys_settings tsys\n 849 |     on \n 850 |         b.processor_settings_fk = tsys.pk \n 851 |     and \n 852 |         b.processor_settings_type = 'Tsys::Settings'\n 853 |     left join \n 854 |         pypl-edl.braintree_raw_tables.gateway_custom_actions_settings ca\n 855 |     on \n 856 |         b.processor_settings_fk = ca.pk \n 857 |     and \n 858 |         b.processor_settings_type = 'CustomActions::Settings'\n 859 |     left join \n 860 |         pypl-edl.braintree_raw_tables.gateway_seb_settings seb\n 861 |     on \n 862 |         b.processor_settings_fk = seb.pk \n 863 |     and \n 864 |         b.processor_settings_type = 'Seb::Settings'\n 865 |     left join \n 866 |         pypl-edl.braintree_raw_tables.gateway_fake_processor_settings fp\n 867 |     on \n 868 |         b.processor_settings_fk = fp.pk \n 869 |     and \n 870 |         b.processor_settings_type = 'FakeProcessor::Settings'\n 871 | ) \n 872 | # ## (SKIP) Get BT24 Risk Score\n 873 | -- drop table if exists  pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc_bt24 ;\n 874 | -- create table if not exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc_bt24 as\n 875 | -- (\n 876 | --     select \n 877 | --         b.*, \n 878 | --         -- features to pull BT Risk RADDs\n 879 | --         uds.correlation_id, \n 880 | --         --uds.merchant_fk, \n 881 | --         uds.cc_hash, \n 882 | --         case when uds.cc_bin is not null and uds.cc_last_4 is not null and uds.cc_expiration_date is not null \n 883 | --             then CONCAT(uds.cc_bin,'-', uds.cc_last_4,'-', uds.cc_expiration_date ) else null end as cc_bin_last_exp, \n 884 | --         case when (uds.cc_bin is not null and uds.cc_country_of_issuance_2letters is not null ) then\n 885 | --             CONCAT(uds.cc_bin,'-',uds.cc_country_of_issuance_2letters) else null end as cc_bin_country_of_issuance, \n 886 | --         uds.phone, \n 887 | --         uds.email, \n 888 | --         uds.created_at_utc, \n 889 | --         DATETIME(created_at_utc, \"America/Los_Angeles\") as created_at_pt,\n 890 | --         uds.pit_timestamp,\n 891 | --         -- BT Risk Scores \n 892 | --         uds.bt19_model_score1, \n 893 | --         uds.bt21_model_score1, \n 894 | --         uds.bt23_model_score1, \n 895 | --         uds.bt24_model_score1, \n 896 | --         -- BT UDS Context Features\n 897 | --         uds.mcc_code as mcc_code_uds, \n 898 | --         -- uds.refund_flag,\n 899 | --         -- uds.sender_ip1, \n 900 | --         -- uds.sender_ip2, \n 901 | --         -- uds.sender_ip3,\n 902 | --         -- uds.tenant_numeric_ip4,\n 903 | --         -- uds.tenant_numeric_ip3,\n 904 | --         -- uds.tenant_numeric_ip2,\n 905 | --         -- uds.tenant_numeric_ip1,\n 906 | --         -- uds.tenant_string_ip,\n 907 | --         -- uds.tenant_string_ip1,\n 908 | --         -- uds.tenant_string_ip2,\n 909 | --         -- uds.tenant_string_ip3,\n 910 | --         -- uds.is_refund_or_preauth, \n 911 | --         -- uds.ar_fraud_reason, \n 912 | --         -- uds.cc_segment,\n 913 | --         -- uds.has_legal_restriction, \n 914 | --         -- uds.legal_scenario, \n 915 | --         -- uds.cc_trust, \n 916 | --         -- uds.fraud_status, \n 917 | --         -- label related features \n 918 | --         --uds.amount_submitted_for_settlement, \n 919 | --         --uds.send_receipt_on_submit_for_settlement,\n 920 | --         --uds.has_partial_settlement_transactions, \n 921 | --         --uds.disputed_at, \n 922 | --         --uds.is_cc_bad, \n 923 | --     from\n 924 | --         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc  b\n 925 | --     left join \n 926 | --         ( select * \n 927 | --          from pypl-bods.pp_risk_rap_bt_managed_pii_views.bt_txn_uds \n 928 | --          where date(created_at_utc, \"America/Los_Angeles\") >= \"2023-08-01\" \n 929 | --         ) uds\n 930 | --     on\n 931 | --         b.primary_txn_id = uds.pk \n 932 | -- ) \n 933 | # # Filter NA RADDs to simulate ground-truth missing rate\n 934 | with sub as ( select *\n 935 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered\n 936 | where idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null \n 937 |  ) \n 938 | select \n 939 | sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d is null then 1 else 0 end) / count(*), \n 940 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d is null then 1 else 0 end) / count(*), \n 941 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d is null then 1 else 0 end) / count(*), \n 942 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d is null then 1 else 0 end) / count(*), \n 943 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 944 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 945 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 946 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 947 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 948 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 949 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 950 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 951 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 952 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 953 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 954 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 955 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 956 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 957 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 958 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 959 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 960 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 961 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 962 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 963 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 964 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 965 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 966 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 967 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 968 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 969 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 970 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 971 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 972 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 973 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 974 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 975 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 976 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 977 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 978 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 979 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 980 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 981 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 982 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 983 |   from sub\n 984 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered;\n 985 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered as\n 986 | (\n 987 |     select * \n 988 |     from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc_bt24\n 989 |     where idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null\n 990 | ) \n 991 | # # Deduplicate\n 992 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup;\n 993 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup as\n 994 | (\n 995 | with sub as (\n 996 |     select * \n 997 |     from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered\n 998 | ) \n 999 | SELECT *\n1000 | FROM sub\n1001 | WHERE TRUE\n1002 | QUALIFY ROW_NUMBER() OVER (PARTITION BY primary_txn_id ORDER BY dt DESC) = 1\n1003 | ) \n1004 | select count(*), count(distinct primary_txn_id)\n1005 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n1006 | # # 5. Train-Val-Test Split\n1007 | # - we want a random sample across all time period, because we want the model to learn patterns from the entire history up to model training date \n1008 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3;\n1009 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3 as\n1010 | (\n1011 |     select\n1012 |         *\n1013 |     from\n1014 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n1015 |     where\n1016 |         retry_order = 1\n1017 |     and\n1018 |         abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) < 900  -- train downsampling factor\n1019 | );\n1020 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3;\n1021 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3 as\n1022 | (\n1023 |     select\n1024 |         *\n1025 |     from\n1026 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n1027 |     where\n1028 |         retry_order = 1\n1029 |     and\n1030 |         abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) >= 900  -- validation downsampling factor\n1031 |     and\n1032 |         abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) < 950\n1033 | );\n1034 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3;\n1035 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3 as\n1036 | (\n1037 |     select\n1038 |         *\n1039 |     from\n1040 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n1041 |     where\n1042 |         retry_order = 1\n1043 |     and\n1044 |         abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) >= 950  -- OOT downsampling factor\n1045 | );\n1046 | select\n1047 |     retry_is_success,\n1048 |     count(*) as n,\n1049 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1050 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3\n1051 | group by 1\n1052 | select\n1053 |     primary_response_type,\n1054 |     count(*) as n,\n1055 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1056 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3\n1057 | group by 1\n1058 | order by 2 desc\n1059 | select\n1060 |     retry_strategy_type,\n1061 |     count(*) as n,\n1062 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1063 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3\n1064 | group by 1\n1065 | order by 2 desc\n1066 | select count(*), min(dt), max(dt) \n1067 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3\n1068 | select count(*), min(dt), max(dt) \n1069 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3\n1070 | select\n1071 |     retry_is_success,\n1072 |     count(*) as n,\n1073 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1074 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3\n1075 | group by 1\n1076 | order by 2 desc\n1077 | select\n1078 |     primary_response_type,\n1079 |     count(*) as n,\n1080 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1081 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3\n1082 | group by 1\n1083 | order by 2 desc\n1084 | select\n1085 |     retry_strategy_type,\n1086 |     count(*) as n,\n1087 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1088 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3\n1089 | group by 1\n1090 | order by 2 desc\n1091 | select count(*), min(dt), max(dt) \n1092 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1093 | select\n1094 |     retry_is_success,\n1095 |     count(*) as n,\n1096 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1097 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1098 | group by 1\n1099 | order by 2 desc\n1100 | select\n1101 |     primary_response_type,\n1102 |     count(*) as n,\n1103 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1104 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1105 | group by 1\n1106 | order by 2 desc\n1107 | select\n1108 |     retry_strategy_type,\n1109 |     count(*) as n,\n1110 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1111 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1112 | group by 1\n1113 | order by 2 desc\n1114 | select *\n1115 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1116 | limit 3\n1117 | # ## Copy to pp_scratch for QPull purposes\n1118 | drop table if exists pypl-edw.pp_scratch.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3;\n1119 | create table pypl-edw.pp_scratch.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3 as\n1120 | (\n1121 |     select\n1122 |         *\n1123 |     from\n1124 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1125 | ) ",
    "rmr_agent/repos/bt-retry-v2/etl/02_bq_to_dataproc.py": "   1 | # %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n   2 | # %config PPMagics.autolimit=0\n   3 | # %%url --dataproc --cluster dnaomi-bt-retry --project ccg24-hrzana-gds-pacman\n   4 | # %%configure -f\n   5 | {\n   6 |     \"conf\": {\n   7 |         \"spark.jars\": \"gs://spark-lib/bigquery/spark-bigquery-with-dependencies_2.12-0.18.1.jar\",\n   8 |         \"spark.executor.extraClassPath\": \"spark-bigquery-with-dependencies_2.12-0.18.1.jar\",\n   9 |         \"spark.driver.extraClassPath\": \"spark-bigquery-with-dependencies_2.12-0.18.1.jar\"\n  10 |     }\n  11 | }\n  12 | spark.conf.set(\"viewsEnabled\", \"true\")\n  13 | spark.conf.set(\"materializationProject\", \"pypl-edw\")\n  14 | spark.conf.set(\"materializationDataset\", \"pp_scratch\")\n  15 | # try also pypl-bods.rsh_row_gds_pacman\n  16 | spark.conf.set('temporaryGcsBucket', \"pypl-bkt-rsh-row-std-gds-pacman\")\n  17 | def create_bigquery_table(source_table_name, target_table_name):\n  18 |     df = spark.read.format('bigquery') \\\n  19 |         .option('table', source_table_name) \\\n  20 |         .load()\n  21 |     df.write.format('bigquery').mode('overwrite') \\\n  22 |     .option('table', target_table_name) \\\n  23 |     .save()\n  24 | def create_gcs_table(source_table_name, target_path):\n  25 |     df = spark.read.format('bigquery') \\\n  26 |         .option('table', source_table_name) \\\n  27 |         .load()\n  28 |     df.write.mode('overwrite') \\\n  29 |     .parquet(target_path)\n  30 | source_table_name = \"pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train\"\n  31 | target_gcs_path = \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_2\"\n  32 | create_gcs_table(source_table_name, target_gcs_path)\n  33 | source_table_name = \"pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid\"\n  34 | target_gcs_path = \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_2\"\n  35 | create_gcs_table(source_table_name, target_gcs_path)\n  36 | source_table_name = \"pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test\"\n  37 | target_gcs_path = \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_2\"\n  38 | create_gcs_table(source_table_name, target_gcs_path)\n  39 | # #!gsutil -m cp -r gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_control_train data/\n  40 | # ##!gsutil -m cp -r gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3 data/",
    "rmr_agent/repos/bt-retry-v2/model-dev/train.py": "   1 | # %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n   2 | # %config PPMagics.autolimit=0\n   3 | # %config Completer.use_jedi = False\n   4 | # %load_ext autoreload\n   5 | # %autoreload 2\n   6 | import os\n   7 | import json\n   8 | from functools import partial\n   9 | import joblib\n  10 | import numpy as np\n  11 | import pandas as pd\n  12 | from pathlib import Path\n  13 | import lightgbm as lgb\n  14 | from lightgbm import LGBMClassifier\n  15 | import optuna\n  16 | import mlflow\n  17 | import mlflow.lightgbm\n  18 | # !pip install optuna\n  19 | pd.set_option('display.max_rows', 1000)\n  20 | pd.set_option('display.max_colwidth', 1000)\n  21 | pd.options.display.float_format = '{:.6f}'.format\n  22 | # ## Helper functions\n  23 | def list_to_txt(lst, folder, path):\n  24 |     \"\"\"Save a list to text file\n  25 |     \"\"\"\n  26 |     with open(folder + path, mode=\"w\") as f:\n  27 |         f.write(\"\\n\".join(lst))\n  28 | def list_from_txt(path):\n  29 |     \"\"\"Return a list with each element containing a line\n  30 |         of the file in the given path\n  31 |     \"\"\"\n  32 |     with open(path, mode=\"r\") as f:\n  33 |         lst = [line.rstrip() for line in f.readlines()]\n  34 |     return lst\n  35 | def write_dict_to_json(folder, output_path, dictionary):\n  36 |     \"\"\"\n  37 |     Write dictionary into JSON\n  38 |     \"\"\"\n  39 |     with open(folder + output_path, \"w\") as outfile:\n  40 |         json.dump(dictionary, outfile)\n  41 | def read_dict_from_json(folder, input_path):\n  42 |     \"\"\"\n  43 |     Read JSON from given path as dictionary\n  44 |     \"\"\"\n  45 |     with open(folder + input_path) as json_file:\n  46 |         data = json.load(json_file)\n  47 |     return data\n  48 | def convert_column_types(df, numerical_columns, integer_columns, categorical_columns):\n  49 |     \"\"\"Convert numerical, integer and categorical columns of provided\n  50 |     pandas.DataFrame\n  51 |         Specificaly, convert categorical columns to pandas.Categorical,\n  52 |         numerical columns to numpy.float32 and\n  53 |         integer columns to numpy.int64\n  54 |     \"\"\"\n  55 |     for col in categorical_columns:\n  56 |         df[col] = pd.Categorical(df[col])\n  57 |     for col in numerical_columns:\n  58 |         df[col] = df[col].astype(np.float32)\n  59 |     for col in integer_columns:\n  60 |         df[col] = df[col].astype(np.int64)\n  61 |     return df\n  62 | \"\"\"\n  63 | BT Retry Global\n  64 | Useful metrics functions.\n  65 | \"\"\"\n  66 | import numpy as np\n  67 | from sklearn.metrics import precision_recall_curve, auc\n  68 | def precision_at_recall(y_true, y_score, recall_value):\n  69 |     \"\"\"Precision at the given recall value\n  70 |     \"\"\"\n  71 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  72 |     if np.sum(recalls >= recall_value) == 0:\n  73 |         return 0.\n  74 |     idx = np.argmin(recalls[recalls >= recall_value])\n  75 |     precision_value = precisions[idx]\n  76 |     return precision_value\n  77 | def threshold_at_recall(y_true, y_score, recall_value):\n  78 |     \"\"\"Threshold at the given recall value\n  79 |     \"\"\"\n  80 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  81 |     if np.sum(recalls >= recall_value) == 0:\n  82 |         return 0.\n  83 |     idx = np.argmin(recalls[recalls >= recall_value])\n  84 |     threshold = thresholds[idx - 1]\n  85 |     return threshold\n  86 | def savings_at_recall(y_true, y_score, recall_value):\n  87 |     \"\"\"Positive prediction rate savings at the given recall value\n  88 |     \"\"\"\n  89 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  90 |     if np.sum(recalls >= recall_value) == 0:\n  91 |         return 0.\n  92 |     idx = np.argmin(recalls[recalls >= recall_value])\n  93 |     precision_value = precisions[idx]\n  94 |     min_ratio = y_true.mean()\n  95 |     try:\n  96 |         savings = 1 - recall_value * min_ratio / precision_value\n  97 |     except ValueError as e:\n  98 |         savings = 0.\n  99 |     return savings\n 100 | # def precision_at_recall(precisions, recalls, recall_value):\n 101 | #     \"\"\"Precision at the given recall value\n 102 | #     \"\"\"\n 103 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 104 | #     precision_value = precisions[idx]\n 105 | #     return precision_value\n 106 | # def threshold_at_recall(thresholds, recalls, recall_value):\n 107 | #     \"\"\"Threshold at the given recall value\n 108 | #     \"\"\"\n 109 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 110 | #     threshold = thresholds[idx - 1]\n 111 | #     return threshold\n 112 | # def savings_at_recall(precisions, recalls, recall_value, min_ratio):\n 113 | #     \"\"\"Positive prediction rate savings at the given recall value\n 114 | #     \"\"\"\n 115 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 116 | #     precision_value = precisions[idx]\n 117 | #     return 1 - recall_value * min_ratio / precision_value\n 118 | def partial_aucpr(y_true, y_score, recall_lb, recall_ub):\n 119 |     \"\"\"Partial Area Under the PR Curve between the given recall levels\n 120 |     \"\"\"\n 121 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n 122 |     if np.sum(recalls >= recall_lb) == 0:\n 123 |         return 0.\n 124 |     idx_right = np.argmin(recalls[recalls >= recall_lb])\n 125 |     if np.sum(recalls >= recall_ub) == 0:\n 126 |         # get max recall possible\n 127 |         idx_left = np.argmax(recalls[recalls >= recall_lb])\n 128 |     else:\n 129 |         idx_left = np.argmin(recalls[recalls >= recall_ub])\n 130 |     try:\n 131 |         p_aucpr = auc(recalls[idx_left:idx_right], precisions[idx_left:idx_right])\n 132 |     except ValueError as e:\n 133 |         p_aucpr = 0.\n 134 |     return p_aucpr\n 135 | def evaluate_metrics(y_true, y_score, metric_functions):\n 136 |     \"\"\"Evaluate a list of metrics (callables) on y_true and y_score\n 137 |     \"\"\"\n 138 |     return [score(y_true, y_score) for score in metric_functions]\n 139 | def get_features_and_target(df, features, target_col):\n 140 |     \"\"\"Return feature matrix and 1-D label vector\n 141 |     \"\"\"\n 142 |     return df[features], df[target_col]\n 143 | partial_aucpr_geq90 = partial(partial_aucpr, recall_lb=0.9, recall_ub=1.)\n 144 | precision_at_95 = partial(precision_at_recall, recall_value=0.95)\n 145 | precision_at_99 = partial(precision_at_recall, recall_value=0.99)\n 146 | savings_at_95 = partial(savings_at_recall, recall_value=0.95)\n 147 | savings_at_99 = partial(savings_at_recall, recall_value=0.99)\n 148 | EARLY_STOPPING_PARAMS = {\"stopping_rounds\": 10}\n 149 | EARLY_STOPPING_METRIC = \"average_precision\"\n 150 | METRIC_FUNCTIONS = [precision_at_95, precision_at_99, savings_at_95, savings_at_99, partial_aucpr_geq90]\n 151 | METRIC_NAMES = [\"precision_at_95\", \"precision_at_99\", \"savings_at_95\", \"savings_at_99\", \"partial_aucpr_geq90\"]\n 152 | OBJECTIVE_METRIC_NAME = \"partial_aucpr_geq90\"\n 153 | # ## Data\n 154 | V1_FEATURES_PATH = Path(\n 155 |     \"/projects/dnaomi/bt-retry-global-v2/metadata/v1_features.txt\"\n 156 | )\n 157 | V1_LATEST_FEATURES_PATH = Path(\n 158 |     \"/projects/dnaomi/bt-retry-global-v2/metadata/v0_features_latest.txt\"\n 159 | )\n 160 | V2_FEATURES_PATH = Path(\n 161 |     \"/projects/dnaomi/bt-retry-global-v2/metadata/v2_features.txt\"\n 162 | )\n 163 | TRAIN_PARQUET_PATH = Path(\n 164 |     \"/projects/dnaomi/bt-retry-global-v2/data/pypl-bods.gds_pacman_prod.bt_retry_global_v2_driverset_cc_renamed_radd_subset_filtered_full_train_3/\"\n 165 | )\n 166 | VAL_PARQUET_PATH = Path(\n 167 |     \"/projects/dnaomi/bt-retry-global-v2/data/pypl-bods.gds_pacman_prod.bt_retry_global_v2_driverset_cc_renamed_radd_subset_filtered_full_valid_3/\"\n 168 | )\n 169 | FEATURES = list_from_txt(V2_FEATURES_PATH)\n 170 | V1_FEATURES = list_from_txt(V1_LATEST_FEATURES_PATH)\n 171 | train_df = pd.read_parquet(TRAIN_PARQUET_PATH)\n 172 | val_df = pd.read_parquet(VAL_PARQUET_PATH)\n 173 | train_df['retry_strategy_type'].unique()\n 174 | val_df['retry_strategy_type'].unique()\n 175 | # load features and types\n 176 | numerical_columns = [\"setec_txn_amt_usd\",\n 177 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d\",\n 178 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d\",\n 179 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d\",\n 180 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d\",\n 181 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d\",\n 182 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n 183 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n 184 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n 185 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n 186 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n 187 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n 188 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n 189 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n 190 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n 191 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d\",\n 192 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n 193 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n 194 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n 195 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n 196 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n 197 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n 198 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n 199 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n 200 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\",\n 201 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d\",\n 202 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n 203 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n 204 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n 205 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n 206 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n 207 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n 208 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n 209 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n 210 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n 211 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d\",\n 212 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n 213 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n 214 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n 215 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n 216 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n 217 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n 218 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n 219 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n 220 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\", \n 221 |                     # \"bt24_model_score1\" \n 222 |                     ]\n 223 | integer_columns = []\n 224 | encoded_columns = []  # no encoded columns in this example\n 225 | categorical_columns = [\"merchant_fk\",\n 226 |                        \"setec_currency_code\",\n 227 |                        \"primary_response_type\",\n 228 |                        \"processor_settings_type\", # renamed from primary_processor_settings_type\n 229 |                        \"retry_strategy_type\",\n 230 |                        \"card_type\",\n 231 |                        \"fi_usage\", \n 232 |                        \"issuer\", # renamed from cc_issuing_bank\n 233 |                        \"bin\",  # renamed from cc_bin\n 234 |                        # \"cc_postal_code\",  # REMOVED\n 235 |                        # \"cc_country_name\",  # REMOVED\n 236 |                        \"issuer_cntry_code\", # renamed from issuer_country\n 237 |                        #\"debit\", # REMOVED\n 238 |                         # \"cc_prepaid\",  # REMOVED\n 239 |                        #\"pan_guid\", # renamed from cc_pan_guid\n 240 |                        \"is_recurring_txn\", # renamed from recurring \n 241 |                        # from the latest model config file \n 242 |                        \"payment_method_token\", #  # REMOVED\n 243 |                       \"original_payment_method_fk\",  # REMOVED\n 244 |                        \"payment_instrument_type\", \n 245 |                        \"is_cvv_present\", \n 246 |                        \"enrollment_id\", \n 247 |                        \"enrollment_status\", \n 248 |                        \"token_status\", \n 249 |                       \"original_processor_settings_fk\", \n 250 |                        \"vaulted_credential_type\", \n 251 |                       \"shard\",\n 252 |                        \"mcc_code\", #NEW\n 253 |                        \"liability_shift_possible\", #NEW\n 254 |                        \"success_3ds\", #NEW\n 255 |                        \"verifications_txn\", #NEW\n 256 |                        \"fastlane_txn\" #NEW\n 257 |                       ]\n 258 | target_col = \"retry_is_success\"\n 259 | features = numerical_columns + integer_columns + encoded_columns + categorical_columns\n 260 | list_to_txt(features, \"/projects/dnaomi/bt-retry-global-v2/metadata/\", \"v2_features_final.txt\")\n 261 | train_df[features].isnull().mean() * 100\n 262 | # train_df['bt24_model_score1'] = pd.to_numeric(train_df['bt24_model_score1'])\n 263 | # train_df['bt23_model_score1'] = pd.to_numeric(train_df['bt23_model_score1'])\n 264 | val_df['issuer_cntry_code'] = val_df['issuer_country']\n 265 | # convert data types\n 266 | train = convert_column_types(train_df,\n 267 |                              numerical_columns=numerical_columns,\n 268 |                              integer_columns=integer_columns + [target_col],\n 269 |                              categorical_columns=categorical_columns)\n 270 | valid = convert_column_types(val_df,\n 271 |                              numerical_columns=numerical_columns,\n 272 |                              integer_columns=integer_columns + [target_col],\n 273 |                              categorical_columns=categorical_columns)\n 274 | # get features and target\n 275 | train_feat, y_train = get_features_and_target(train, features=features, target_col=target_col)\n 276 | valid_feat, y_valid = get_features_and_target(valid, features=features, target_col=target_col)\n 277 | # best param for model with subset of strategies (all txns)\n 278 | best_params = { \n 279 | 'colsample_bytree': 0.5837239684404587,\n 280 | 'learning_rate': 0.0598927112458938,\n 281 | 'min_child_samples':61,\n 282 | 'min_data_in_bin':25,\n 283 | 'num_leaves':217,\n 284 | 'num_trees':141,\n 285 | 'n_estimators':141,\n 286 | 'n_jobs':8,\n 287 | 'reg_alpha':4.784258485091152e-08,\n 288 | 'reg_lambda':0.0002699654851946926,\n 289 | 'subsample':0.6899589770039457,\n 290 | 'subsample_freq':5,\n 291 | }\n 292 | train_ = train_feat[features]\n 293 | valid_ = valid_feat[features]\n 294 | #model = LGBMClassifier(**best_params)\n 295 | model = LGBMClassifier()\n 296 | model.fit(train_, y_train)\n 297 | pred_probas = model.predict_proba(valid_)\n 298 | predictions = pred_probas[:, -1]\n 299 | metric_values = evaluate_metrics(y_valid, predictions, METRIC_FUNCTIONS)\n 300 | model.booster_.save_model('/projects/dnaomi/bt-retry-global-v2/models/final/bt_retry_v2.txt')\n 301 | pd.DataFrame(index=METRIC_NAMES, data=metric_values, columns=[\"value\"])\n 302 | metric_values\n 303 | lgb.plot_importance(model, figsize=(10,10), importance_type='gain', max_num_features=15)\n 304 | lgb.plot_importance(model, figsize=(10,10), importance_type='split', max_num_features=15)\n 305 | model\n 306 | features = model.feature_name()\n 307 | importances = model.feature_importance(importance_type='gain')\n 308 | feature_importance = pd.DataFrame({'importance':importances, 'feature':features}).sort_values('importance', ascending=False).reset_index(drop=True)\n 309 | feature_importance\n 310 | # ## Hyperparameter Tuning with Optuna\n 311 | # !pwd\n 312 | TRACKING_URL = \"https://mlflow.apps.cosmos-onprem.dp.lvs.paypalinc.com\"\n 313 | EXPERIMENT_NAME = \"bt_retry_global_v2_full_fts_strategy_subset_model_all_strat_valid_control\"  \n 314 | STUDY_NAME = \"bt-retry-global-v1-full-fts-strategy-subset-model-all-strat-valid-control\" \n 315 | STUDIES_DIR = \"../reports/studies/\"\n 316 | STUDY_DIR = os.path.join(STUDIES_DIR, STUDY_NAME)\n 317 | if not os.path.exists(STUDY_DIR):\n 318 |     os.mkdir(STUDY_DIR)\n 319 | N_TRIALS = 250\n 320 | OPTUNA_STUDY_PATH = os.path.join(STUDY_DIR, STUDY_NAME + \".pkl\")\n 321 | STDOUT_PATH = os.path.join(STUDY_DIR, STUDY_NAME + \"-stdout.txt\")\n 322 | STDERR_PATH = os.path.join(STUDY_DIR, STUDY_NAME + \"-stdout.txt\")\n 323 | os.environ['MLFLOW_TRACKING_URL'] = TRACKING_URL\n 324 | mlflow.set_tracking_uri(os.environ['MLFLOW_TRACKING_URL'])\n 325 | mlflow.set_experiment(EXPERIMENT_NAME, os.environ['USER'])\n 326 | OBJECTIVE_METRIC_NAME\n 327 | def objective(trial, objective_metric_name=OBJECTIVE_METRIC_NAME):\n 328 |     with mlflow.start_run():\n 329 |         param = {\n 330 |             \"n_jobs\": 8,\n 331 |             \"n_estimators\": trial.suggest_int(\"n_estimators\", 1, 150, 5),\n 332 |             \"min_data_in_bin\": 25,\n 333 |             \"learning_rate\": trial.suggest_loguniform(\"learning_rate\", 1e-5, 1.),\n 334 |             \"reg_alpha\": trial.suggest_loguniform(\"reg_alpha\", 1e-8, 10.0),\n 335 |             \"reg_lambda\": trial.suggest_loguniform(\"reg_lambda\", 1e-8, 10.0),\n 336 |             \"num_leaves\": trial.suggest_int(\"num_leaves\", 2, 256),\n 337 |             \"colsample_bytree\": trial.suggest_uniform(\"colsample_bytree\", 0.5, 1.0),\n 338 |             \"subsample\": trial.suggest_uniform(\"subsample\", 0.4, 0.9),\n 339 |             \"subsample_freq\": trial.suggest_int(\"subsample_freq\", 2, 5),\n 340 |             \"min_child_samples\": trial.suggest_int(\"min_child_samples\", 5, 100),\n 341 |         }\n 342 |         model = LGBMClassifier(**param)\n 343 |         model.fit(train_, y_train)                 \n 344 |         # 7.\n 345 |         pred_probas = model.predict_proba(valid_)\n 346 |         predictions = pred_probas[:, -1]\n 347 |         metric_values = evaluate_metrics(y_valid, predictions, METRIC_FUNCTIONS)\n 348 |         metrics = {name: value for name, value in zip(METRIC_NAMES, metric_values)}\n 349 |         # 8.\n 350 |         mlflow.log_params(param)\n 351 |         mlflow.log_param(\"num_trees\", model.booster_.num_trees())\n 352 |         mlflow.log_metrics(metrics)\n 353 |         mlflow.lightgbm.log_model(model.booster_, \"lgbm_booster\")\n 354 |     return metrics[objective_metric_name]\n 355 | # %%capture capt\n 356 | optuna.logging.set_verbosity(optuna.logging.WARNING)\n 357 | if os.path.exists(OPTUNA_STUDY_PATH):\n 358 |     study = joblib.load(OPTUNA_STUDY_PATH)\n 359 |     n_trials_completed = len(study.trials)\n 360 | else:\n 361 |     study = optuna.create_study(study_name=STUDY_NAME,\n 362 |                                 direction=\"maximize\")\n 363 |     n_trials_completed = 0\n 364 | study.optimize(objective, n_trials=N_TRIALS - n_trials_completed)\n 365 | with open(STDOUT_PATH, \"w\") as f:\n 366 |     f.write(capt.stdout)\n 367 | joblib.dump(study, OPTUNA_STUDY_PATH)",
    "rmr_agent/repos/bt-retry-v2/model-dev/evaluate.py": "   1 | # %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n   2 | # %config PPMagics.autolimit=0\n   3 | # %config Completer.use_jedi = False\n   4 | # %load_ext autoreload\n   5 | # %autoreload 2\n   6 | from functools import partial\n   7 | import numpy as np\n   8 | import pandas as pd\n   9 | from pathlib import Path\n  10 | import matplotlib.pyplot as plt\n  11 | from sklearn.metrics import precision_recall_curve, precision_score, recall_score\n  12 | import lightgbm as lgb\n  13 | plt.style.use('ggplot')\n  14 | plt.rcParams['figure.figsize'] = (9, 6)\n  15 | plt.rcParams['font.size'] = 12\n  16 | # %matplotlib inline\n  17 | colours = [\"#E24A33\", \"#348ABD\", \"#988ED5\", \"#777777\", \"#FBC15E\", \"#8EBA42\", \"#FFB5B8\"]\n  18 | def list_to_txt(lst, folder, path):\n  19 |     \"\"\"Save a list to text file\n  20 |     \"\"\"\n  21 |     with open(folder + path, mode=\"w\") as f:\n  22 |         f.write(\"\\n\".join(lst))\n  23 | def list_from_txt(path):\n  24 |     \"\"\"Return a list with each element containing a line\n  25 |         of the file in the given path\n  26 |     \"\"\"\n  27 |     with open(path, mode=\"r\") as f:\n  28 |         lst = [line.rstrip() for line in f.readlines()]\n  29 |     return lst\n  30 | def write_dict_to_json(folder, output_path, dictionary):\n  31 |     \"\"\"\n  32 |     Write dictionary into JSON\n  33 |     \"\"\"\n  34 |     with open(folder + output_path, \"w\") as outfile:\n  35 |         json.dump(dictionary, outfile)\n  36 | def read_dict_from_json(folder, input_path):\n  37 |     \"\"\"\n  38 |     Read JSON from given path as dictionary\n  39 |     \"\"\"\n  40 |     with open(folder + input_path) as json_file:\n  41 |         data = json.load(json_file)\n  42 |     return data\n  43 | def convert_column_types(df, numerical_columns, integer_columns, categorical_columns):\n  44 |     \"\"\"Convert numerical, integer and categorical columns of provided\n  45 |     pandas.DataFrame\n  46 |         Specificaly, convert categorical columns to pandas.Categorical,\n  47 |         numerical columns to numpy.float32 and\n  48 |         integer columns to numpy.int64\n  49 |     \"\"\"\n  50 |     for col in categorical_columns:\n  51 |         df[col] = pd.Categorical(df[col])\n  52 |     for col in numerical_columns:\n  53 |         df[col] = df[col].astype(np.float32)\n  54 |     for col in integer_columns:\n  55 |         df[col] = df[col].astype(np.int64)\n  56 |     return df\n  57 | \"\"\"\n  58 | BT Retry Global\n  59 | Useful metrics functions.\n  60 | \"\"\"\n  61 | import numpy as np\n  62 | from sklearn.metrics import precision_recall_curve, auc\n  63 | def precision_at_recall(y_true, y_score, recall_value):\n  64 |     \"\"\"Precision at the given recall value\n  65 |     \"\"\"\n  66 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  67 |     if np.sum(recalls >= recall_value) == 0:\n  68 |         return 0.\n  69 |     idx = np.argmin(recalls[recalls >= recall_value])\n  70 |     precision_value = precisions[idx]\n  71 |     return precision_value\n  72 | def threshold_at_recall(y_true, y_score, recall_value):\n  73 |     \"\"\"Threshold at the given recall value\n  74 |     \"\"\"\n  75 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  76 |     if np.sum(recalls >= recall_value) == 0:\n  77 |         return 0.\n  78 |     idx = np.argmin(recalls[recalls >= recall_value])\n  79 |     threshold = thresholds[idx - 1]\n  80 |     return threshold\n  81 | def savings_at_recall(y_true, y_score, recall_value):\n  82 |     \"\"\"Positive prediction rate savings at the given recall value\n  83 |     \"\"\"\n  84 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  85 |     if np.sum(recalls >= recall_value) == 0:\n  86 |         return 0.\n  87 |     idx = np.argmin(recalls[recalls >= recall_value])\n  88 |     precision_value = precisions[idx]\n  89 |     treshold_value = thresholds[idx]\n  90 |     min_ratio = y_true.mean()\n  91 |     try:\n  92 |         savings = 1 - recall_value * min_ratio / precision_value\n  93 |     except ValueError as e:\n  94 |         savings = 0.\n  95 |     return savings\n  96 | def retry_success_rate_at_recall(y_true, y_score, recall_value):\n  97 |     \"\"\" retry success rate = # of successful retries / # retries\n  98 |         = TP / # retries \n  99 |     \"\"\"\n 100 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n 101 |     if np.sum(recalls >= recall_value) == 0:\n 102 |         return 0.\n 103 |     idx = np.argmin(recalls[recalls >= recall_value])\n 104 |     treshold_value = thresholds[idx]\n 105 |     y_pred = np.where(y_score > treshold_value, 1, 0) \n 106 |     tp = np.sum((y_pred==1) & (y_true == 1))\n 107 |     return tp / len(y_pred) \n 108 | # def precision_at_recall(precisions, recalls, recall_value):\n 109 | #     \"\"\"Precision at the given recall value\n 110 | #     \"\"\"\n 111 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 112 | #     precision_value = precisions[idx]\n 113 | #     return precision_value\n 114 | # def threshold_at_recall(thresholds, recalls, recall_value):\n 115 | #     \"\"\"Threshold at the given recall value\n 116 | #     \"\"\"\n 117 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 118 | #     threshold = thresholds[idx - 1]\n 119 | #     return threshold\n 120 | # def savings_at_recall(precisions, recalls, recall_value, min_ratio):\n 121 | #     \"\"\"Positive prediction rate savings at the given recall value\n 122 | #     \"\"\"\n 123 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 124 | #     precision_value = precisions[idx]\n 125 | #     return 1 - recall_value * min_ratio / precision_value\n 126 | def partial_aucpr(y_true, y_score, recall_lb, recall_ub):\n 127 |     \"\"\"Partial Area Under the PR Curve between the given recall levels\n 128 |     \"\"\"\n 129 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n 130 |     if np.sum(recalls >= recall_lb) == 0:\n 131 |         return 0.\n 132 |     idx_right = np.argmin(recalls[recalls >= recall_lb])\n 133 |     if np.sum(recalls >= recall_ub) == 0:\n 134 |         # get max recall possible\n 135 |         idx_left = np.argmax(recalls[recalls >= recall_lb])\n 136 |     else:\n 137 |         idx_left = np.argmin(recalls[recalls >= recall_ub])\n 138 |     try:\n 139 |         p_aucpr = auc(recalls[idx_left:idx_right], precisions[idx_left:idx_right])\n 140 |     except ValueError as e:\n 141 |         p_aucpr = 0.\n 142 |     return p_aucpr\n 143 | def evaluate_metrics(y_true, y_score, metric_functions):\n 144 |     \"\"\"Evaluate a list of metrics (callables) on y_true and y_score\n 145 |     \"\"\"\n 146 |     return [score(y_true, y_score) for score in metric_functions]\n 147 | def get_features_and_target(df, features, target_col):\n 148 |     \"\"\"Return feature matrix and 1-D label vector\n 149 |     \"\"\"\n 150 |     return df[features], df[target_col]\n 151 | # partial area-under-the-curve refers to the area under the precision-recall curve\n 152 | # but only for a specific interval of recall values\n 153 | partial_aucpr_geq90 = partial(partial_aucpr, recall_lb=0.9, recall_ub=1.)\n 154 | precision_at_95 = partial(precision_at_recall, recall_value=0.95)\n 155 | precision_at_99 = partial(precision_at_recall, recall_value=0.99)\n 156 | precision_at_995 = partial(precision_at_recall, recall_value=0.99)\n 157 | # savings refers to the percentage of records that are not predicted as positive:\n 158 | #      savings = 1 - (TP + FP) / (TP + FP + TN + FN)\n 159 | # or, alternatively:\n 160 | #      savings = 1 - minority_ratio * recall / precision\n 161 | savings_at_95 = partial(savings_at_recall, recall_value=0.95)\n 162 | savings_at_99 = partial(savings_at_recall, recall_value=0.99)\n 163 | savings_at_995 = partial(savings_at_recall, recall_value=0.995)\n 164 | METRIC_FUNCTIONS = [precision_at_95, precision_at_99, precision_at_995, savings_at_95, savings_at_99, savings_at_995, partial_aucpr_geq90]\n 165 | METRIC_NAMES = [\"precision_at_95\", \"precision_at_99\", \"precision_at_995\", \"savings_at_95\", \"savings_at_99\", \"savings_at_995\", \"partial_aucpr_geq90\"]\n 166 | DATA_PATH = Path(\n 167 |     \"/projects/dnaomi/bt-retry-global-refresh/data/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3/\"\n 168 | )\n 169 | V1_FEATURES_PATH = Path(\"/projects/dnaomi/bt-retry-global-refresh/metadata/features_original.txt\") \n 170 | V1_MODEL_PATH = Path( \"/projects/dnaomi/bt-retry-global/models/lgbm/original_lgbm/original_model.txt\")\n 171 | V2_FEATURES_PATH = Path(\"/projects/dnaomi/bt-retry-global-refresh/metadata/v2_features_final_2.txt\") \n 172 | V2_MODEL_PATH = Path(\"/projects/dnaomi/bt-retry-global-refresh/models/final/bt_retry_v2.txt\")\n 173 | # V2_CONTROL_MODEL_PATH = Path(\"/projects/dnaomi/bt-retry-global-refresh/models/bt_retry_v2_subset_strat_control.txt\")\n 174 | data = pd.read_parquet(DATA_PATH)\n 175 | data['retry_strategy_type'].unique()\n 176 | # load features and types\n 177 | numerical_columns = [\"setec_txn_amt_usd\",\n 178 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d\",\n 179 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d\",\n 180 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d\",\n 181 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d\",\n 182 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d\",\n 183 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n 184 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n 185 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n 186 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n 187 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n 188 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n 189 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n 190 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n 191 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n 192 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d\",\n 193 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n 194 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n 195 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n 196 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n 197 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n 198 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n 199 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n 200 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n 201 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\",\n 202 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d\",\n 203 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n 204 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n 205 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n 206 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n 207 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n 208 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n 209 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n 210 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n 211 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n 212 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d\",\n 213 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n 214 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n 215 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n 216 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n 217 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n 218 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n 219 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n 220 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n 221 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\", \n 222 |                     # \"bt24_model_score1\" \n 223 |                     ]\n 224 | integer_columns = []\n 225 | encoded_columns = []  # no encoded columns in this example\n 226 | categorical_columns = [\"merchant_fk\",\n 227 |                        \"setec_currency_code\",\n 228 |                        \"primary_response_type\",\n 229 |                        \"processor_settings_type\",\n 230 |                        \"retry_strategy_type\",\n 231 |                        \"card_type\",\n 232 |                        \"fi_usage\", \n 233 |                        \"issuer\", \n 234 |                        \"bin\",  \n 235 |                        \"issuer_cntry_code\", \n 236 |                       # \"pan_guid\",\n 237 |                        \"is_recurring_txn\", \n 238 |                        \"payment_instrument_type\", \n 239 |                        \"is_cvv_present\", \n 240 |                        \"enrollment_status\", \n 241 |                        \"token_status\", \n 242 |                        \"vaulted_credential_type\", \n 243 |                        \"mcc_code\", \n 244 |                        \"liability_shift_possible\", \n 245 |                        \"success_3ds\", \n 246 |                        \"verifications_txn\", \n 247 |                        \"fastlane_txn\" \n 248 |                       ]\n 249 | target_col = \"retry_is_success\"\n 250 | data['issuer_cntry_code'] = data['issuer_country']\n 251 | data = convert_column_types(data,\n 252 |                             numerical_columns=numerical_columns,\n 253 |                             integer_columns=integer_columns + [target_col],\n 254 |                             categorical_columns=categorical_columns)\n 255 | data['primary_processor_settings_type'] = data['processor_settings_type']\n 256 | V1_FEATURES = list_from_txt(V1_FEATURES_PATH)\n 257 | v1_model = lgb.Booster(model_file=V1_MODEL_PATH)\n 258 | V2_FEATURES = list_from_txt(V2_FEATURES_PATH)\n 259 | v2_model = lgb.Booster(model_file=V2_MODEL_PATH)\n 260 | #v2_ctrl_model = lgb.Booster(model_file=V2_CONTROL_MODEL_PATH)\n 261 | X_1, y_1 = data[V1_FEATURES], data[target_col]\n 262 | v1_scores = v1_model.predict(X_1)\n 263 | v1_metrics = evaluate_metrics(y_1, v1_scores, METRIC_FUNCTIONS)\n 264 | data[\"v1_score\"] = v1_scores\n 265 | X_2, y_2 = data[V2_FEATURES], data[target_col]\n 266 | v2_scores = v2_model.predict(X_2)\n 267 | v2_metrics = evaluate_metrics(y_2, v2_scores, METRIC_FUNCTIONS)\n 268 | retry_success_rate_at_recall(y_1, v1_scores, 0.95) * 100 \n 269 | retry_success_rate_at_recall(y_2, v2_scores, 0.98) * 100 \n 270 | savings_at_recall(y_2, v2_scores, 0.98) * 100 \n 271 | precision = precision_score(y_2, v2_scores > 0.018447025070137058)\n 272 | recall = recall_score(y_2, v2_scores > 0.018447025070137058)\n 273 | ( 6.111412524741035 - 5.924284896163004) / 5.924284896163004 \n 274 | data[\"v2_score\"] = v2_scores\n 275 | # v2_ctrl_scores = v2_ctrl_model.predict(X_2)\n 276 | # v2_ctrl_metrics = evaluate_metrics(y_2, v2_ctrl_scores, METRIC_FUNCTIONS)\n 277 | # data[\"v2_ctrl_score\"] = v2_ctrl_scores\n 278 | data[target_col].mean() * 100 # retry success rate\n 279 | 5.924284896163004 / 6.2359968251097655 * 100 \n 280 | precision, recall, _ = precision_recall_curve(data[target_col], data['v1_score'])\n 281 | auc_score = auc(recall, precision)\n 282 | auc_score\n 283 | precision, recall, _ = precision_recall_curve(data[target_col], data['v2_score'])\n 284 | auc_score = auc(recall, precision)\n 285 | auc_score\n 286 | pd.DataFrame(index=METRIC_NAMES, data=v1_metrics, columns=[\"value\"])\n 287 | pd.DataFrame(index=METRIC_NAMES, data=v2_metrics, columns=[\"value\"])\n 288 | pd.DataFrame(index=METRIC_NAMES, data=v2_ctrl_metrics, columns=[\"value\"])\n 289 | # to evaluate by segment\n 290 | def evaluate_metrics_by_segment(data, segment_col, target_col, scores_col):\n 291 |     \"\"\"Evaluate metrics by segment\n 292 |     \"\"\"\n 293 |     by_segment = data.groupby(segment_col).apply(lambda df: evaluate_metrics(df[target_col],\n 294 |                                                                              df[scores_col],\n 295 |                                                                              METRIC_FUNCTIONS))\n 296 |     return pd.DataFrame(by_segment.to_list(),\n 297 |                         index=by_segment.index,\n 298 |                         columns=METRIC_NAMES)\n 299 | # this might give some numeric problems due from dividing by zero\n 300 | evaluate_metrics_by_segment(data, \"primary_response_type\", target_col, \"v1_score\")\n 301 | evaluate_metrics_by_segment(data, \"primary_response_type\", target_col, \"v2_score\")\n 302 | evaluate_metrics_by_segment(data, \"primary_response_type\", target_col, \"v2_ctrl_score\")\n 303 | # this might give some numeric problems due from dividing by zero\n 304 | evaluate_metrics_by_segment(data, \"retry_strategy_type\", target_col, \"v1_score\")\n 305 | # this might give some numeric problems due from dividing by zero\n 306 | evaluate_metrics_by_segment(data, \"retry_strategy_type\", target_col, \"v2_score\")\n 307 | # this might give some numeric problems due from dividing by zero\n 308 | evaluate_metrics_by_segment(data, \"retry_strategy_type\", target_col, \"v2_ctrl_score\")\n 309 | fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 310 | precisions, recalls, _ = precision_recall_curve(data[target_col], v1_scores)\n 311 | ax.plot(recalls, precisions, label='V1')\n 312 | precisions, recalls, _ = precision_recall_curve(data[target_col], v2_scores)\n 313 | ax.plot(recalls, precisions, label='V2')\n 314 | # precisions, recalls, _ = precision_recall_curve(data[target_col], v2_ctrl_scores)\n 315 | # ax.plot(recalls, precisions, label='V2 Control')\n 316 | ax.set_xlabel(\"Recall\")\n 317 | ax.set_ylabel(\"Precision\")\n 318 | plt.title(\"Precision Recall Curves of V1 vs. V2\")\n 319 | plt.legend()\n 320 | data['primary_response_type'].unique()\n 321 | data['retry_strategy_type'].unique()\n 322 | #retry_strategies = ['ACQUIRER_RETRY', 'ACQUIRER_MIGRATION_RETRY', 'PROCESSOR_RETRY', 'ALT_MERCHANT_ACCOUNT', 'PINLESS_DEBIT_AS_CREDIT', 'NO_AVS', 'PAN', 'NETWORK_TOKENIZATION', 'ABU']\n 323 | retry_strategies = ['NO_AVS', 'PAN', 'NETWORK_TOKENIZATION', 'ABU']\n 324 | primary_response_types = ['NSF', 'SOFT OTHER', 'NO HONOR', 'HARD OTHER', 'INVALID CC']\n 325 | fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 326 | for cat in retry_strategies:\n 327 |     temp = data[ data['retry_strategy_type']== cat ] \n 328 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n 329 |     ax.plot(recalls, precisions, label=cat)\n 330 | ax.set_xlabel(\"Recall\")\n 331 | ax.set_ylabel(\"Precision\")\n 332 | plt.title(\"Precision Recall Curves by Retry Strategy\")\n 333 | plt.legend()\n 334 | fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 335 | for cat in primary_response_types:\n 336 |     temp = data[ data['primary_response_type']== cat ] \n 337 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n 338 |     ax.plot(recalls, precisions, label=cat)\n 339 | ax.set_xlabel(\"Recall\")\n 340 | ax.set_ylabel(\"Precision\")\n 341 | plt.title(\"Precision Recall Curves by Decline Type\")\n 342 | plt.legend()\n 343 | fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 344 | for cat in primary_response_types:\n 345 |     temp = data[ data['primary_response_type']== cat ] \n 346 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_ctrl_score'])\n 347 |     ax.plot(recalls, precisions, label=cat)\n 348 | ax.set_xlabel(\"Recall\")\n 349 | ax.set_ylabel(\"Precision\")\n 350 | plt.title(\"Precision Recall Curves by Decline Type\")\n 351 | plt.legend()\n 352 | for cat in retry_strategies:\n 353 |     fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 354 |     temp = data[ data['retry_strategy_type']== cat ] \n 355 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v1_score'])\n 356 |     ax.plot(recalls, precisions, label='V1')\n 357 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n 358 |     ax.plot(recalls, precisions, label='V2')\n 359 |     # precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_ctrl_score'])\n 360 |     # ax.plot(recalls, precisions, label='V2 Control')\n 361 |     ax.set_xlabel(\"Recall\")\n 362 |     ax.set_ylabel(\"Precision\")\n 363 |     plt.title(\"Precision Recall Curves of \" + cat)\n 364 |     plt.legend()\n 365 | for cat in primary_response_types:\n 366 |     fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 367 |     temp = data[ data['primary_response_type']== cat ] \n 368 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v1_score'])\n 369 |     ax.plot(recalls, precisions, label='V1')\n 370 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n 371 |     ax.plot(recalls, precisions, label='V2')\n 372 |     # precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_ctrl_score'])\n 373 |     # ax.plot(recalls, precisions, label='V2 Control')\n 374 |     ax.set_xlabel(\"Recall\")\n 375 |     ax.set_ylabel(\"Precision\")\n 376 |     plt.title(\"Precision Recall Curves of \" + cat)\n 377 |     plt.legend()\n 378 | # ## Export some test obs as model validation data\n 379 | valid_data = data[:50000][V2_FEATURES + ['v2_score']]\n 380 | dict(valid_data.dtypes)\n 381 | import csv\n 382 | valid_data_filtered = valid_data.dropna(subset=['mcc_code'])\n 383 | valid_data_filtered.to_csv('/projects/dnaomi/bt-retry-global-refresh/deployment/valid_data_filtered_final.csv', quoting=csv.QUOTE_NONE, sep='\\x07')",
    "rmr_agent/repos/bt-retry-v2/deployment/01_export_to_ume.py": "   1 | # ### BT Retry\n   2 | # # Model Saving\n   3 | import json\n   4 | import lightgbm\n   5 | def list_from_txt(path):\n   6 |     \"\"\"Return a list with each element containing a line\n   7 |         of the file in the given path\n   8 |     \"\"\"\n   9 |     with open(path, mode=\"r\") as f:\n  10 |         lst = [line.rstrip() for line in f.readlines()]\n  11 |     return lst\n  12 | # ## Features\n  13 | FULL_FEATURES_PATH = \"/projects/dnaomi/bt-retry-global-v2/metadata/v2_features_final_2.txt\"\n  14 | FEATURES = list_from_txt(FULL_FEATURES_PATH)\n  15 | categorical_columns = [\"merchant_fk\",\n  16 |                        \"setec_currency_code\",\n  17 |                        \"primary_response_type\",\n  18 |                        \"processor_settings_type\",\n  19 |                        \"retry_strategy_type\",\n  20 |                        \"card_type\",\n  21 |                        \"fi_usage\", \n  22 |                        \"issuer\", \n  23 |                        \"bin\",  \n  24 |                        \"issuer_cntry_code\", \n  25 |                        \"is_recurring_txn\", \n  26 |                        \"payment_instrument_type\", \n  27 |                        \"is_cvv_present\", \n  28 |                        \"enrollment_status\", \n  29 |                        \"token_status\", \n  30 |                        \"vaulted_credential_type\", \n  31 |                        \"mcc_code\", \n  32 |                        \"liability_shift_possible\", \n  33 |                        \"success_3ds\", \n  34 |                        \"verifications_txn\", \n  35 |                        \"fastlane_txn\" \n  36 |                       ]\n  37 | # ## Models\n  38 | # model can be loaded in different ways: from txt file, from pickle, from Mlflow...\n  39 | model = lightgbm.Booster(model_file=\"/projects/dnaomi/bt-retry-global-v2/models/bt_retry_v2_small.txt\")\n  40 | # ## Export\n  41 | # name for model files\n  42 | name = \"bt_retry_v2\"\n  43 | # get JSON\n  44 | model_json = model.dump_model()\n  45 | # no mapping file\n  46 | model_json_with_pd_path = f\"/projects/dnaomi/bt-retry-global-v2/models/{name}_model_idi.json\"\n  47 | model_json[\"categorical_feature_name\"] = [feat for feat in categorical_columns]\n  48 | with open(model_json_with_pd_path, \"w\") as f:\n  49 |     json.dump(model_json, f)\n  50 | # ## Transform to UME\n  51 | from pyScoring.lightgbm import LightGBMTransformer\n  52 | lgb_transformer = LightGBMTransformer(path_to_json='/projects/dnaomi/bt-retry-global-v2/models/bt_retry_v2_model_idi.json')\n  53 | binary_spec = lgb_transformer.create_model_spec(model_name='bt_retry_v2', tree_nodes_only=False, output_name='bt_retry_v2_score')\n  54 | binary_spec\n  55 | output_path = \"/projects/dnaomi/bt-retry-global-v2/models/ume/\"\n  56 | binary_spec.save(output_path)\n  57 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-v2/models/ume/bt_retry_v2.m -tgt bt-retry-v2/bt_retry_v2_final.m\n  58 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-v2/models/ume/bt_retry_v2.m -tgt bt-retry-v2/bt_retry_v2.m\n  59 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-v2/models/bt_retry_v2_model_idi.m -tgt bt-retry-v2/bt_retry_v2_model_idi.m\n  60 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-v2/models/bt_retry_v2_model_idi.json -tgt bt-retry-v2/bt_retry_v2_model_idi.json",
    "rmr_agent/repos/bt-retry-v2/deployment/02_pyscoring_validation.py": "   1 | # %config Completer.use_jedi = False\n   2 | import pyScoring\n   3 | from pyScoring import UMEModel\n   4 | from semi_auto_trans.model_builder import start_semi_trans\n   5 | from semi_auto_trans.validater import validate_model\n   6 | import pandas as pd\n   7 | import os\n   8 | import numpy as np\n   9 | pyScoring.__version__\n  10 | # ## (SKIP) Export to UME via pyScoring\n  11 | # load features and types\n  12 | numerical_columns = [\"setec_txn_amt_usd\",\n  13 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d\",\n  14 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d\",\n  15 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d\",\n  16 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d\",\n  17 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d\",\n  18 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n  19 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n  20 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n  21 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n  22 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n  23 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n  24 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n  25 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n  26 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n  27 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d\",\n  28 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n  29 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n  30 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n  31 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n  32 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n  33 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n  34 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n  35 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n  36 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\",\n  37 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d\",\n  38 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n  39 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n  40 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n  41 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n  42 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n  43 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n  44 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n  45 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n  46 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n  47 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d\",\n  48 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n  49 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n  50 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n  51 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n  52 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n  53 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n  54 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n  55 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n  56 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\", \n  57 |                     # \"bt24_model_score1\" \n  58 |                     ]\n  59 | integer_columns = []\n  60 | encoded_columns = []  # no encoded columns in this example\n  61 | categorical_columns = [\"merchant_fk\",\n  62 |                        \"setec_currency_code\",\n  63 |                        \"primary_response_type\",\n  64 |                        \"processor_settings_type\",\n  65 |                        \"retry_strategy_type\",\n  66 |                        \"card_type\",\n  67 |                        \"fi_usage\", \n  68 |                        \"issuer\", \n  69 |                        \"bin\",  \n  70 |                        \"issuer_cntry_code\", \n  71 |                        #\"pan_guid\",\n  72 |                        \"is_recurring_txn\", \n  73 |                        \"payment_instrument_type\", \n  74 |                        \"is_cvv_present\", \n  75 |                        \"enrollment_status\", \n  76 |                        \"token_status\", \n  77 |                        \"vaulted_credential_type\", \n  78 |                        \"mcc_code\", \n  79 |                        \"liability_shift_possible\", \n  80 |                        \"success_3ds\", \n  81 |                        \"verifications_txn\", \n  82 |                        \"fastlane_txn\" \n  83 |                       ]\n  84 | target_col = \"retry_is_success\"\n  85 | def convert_column_types(df, numerical_columns, integer_columns, categorical_columns):\n  86 |     \"\"\"Convert numerical, integer and categorical columns of provided\n  87 |     pandas.DataFrame\n  88 |         Specificaly, convert categorical columns to pandas.Categorical,\n  89 |         numerical columns to numpy.float32 and\n  90 |         integer columns to numpy.int64\n  91 |     \"\"\"\n  92 |     for col in categorical_columns:\n  93 |         df[col] = pd.Categorical(df[col])\n  94 |     for col in numerical_columns:\n  95 |         df[col] = df[col].astype(np.float64)\n  96 |     for col in integer_columns:\n  97 |         df[col] = df[col].astype(np.int64)\n  98 |     return df\n  99 | MODELS_DIR = \"/home/dnaomi/bt-retry-global-refresh/models/ume/\"\n 100 | MODEL_DIR = os.path.join(MODELS_DIR)\n 101 | MODEL_UME_NAME = \"bt_retry_v2\"\n 102 | # ### With mapping file\n 103 | start_semi_trans(MODEL_DIR, MODEL_UME_NAME)\n 104 | # ## Validate with LightGBM predictions\n 105 | VALID_SAMPLE_PATH = \"/home/dnaomi/bt-retry-global-refresh/deployment/valid_data_filtered_final.csv\"\n 106 | if os.path.exists(VALID_SAMPLE_PATH):\n 107 |     valid_sample = pd.read_csv(VALID_SAMPLE_PATH,sep='\\x07', dtype=str, index_col=0, keep_default_na=False )\n 108 | valid_sample = convert_column_types(valid_sample,\n 109 |                             numerical_columns=numerical_columns,\n 110 |                             integer_columns=integer_columns,\n 111 |                             categorical_columns=categorical_columns)\n 112 | # ### Feature List\n 113 | def list_from_txt(path):\n 114 |     \"\"\"Return a list with each element containing a line\n 115 |         of the file in the given path\n 116 |     \"\"\"\n 117 |     with open(path, mode=\"r\") as f:\n 118 |         lst = [line.rstrip() for line in f.readlines()]\n 119 |     return lst \n 120 | features = list_from_txt(\"/projects/dnaomi/bt-retry-global-refresh/metadata/v2_features_final_2.txt\")\n 121 | # ### Predict with UME model (with mapping)\n 122 | model_file = os.path.join(MODEL_DIR, \"ume/bt_retry_v2.m\")\n 123 | ume_model = UMEModel(model_file)\n 124 | # #### DataFrame\n 125 | ume_predictions_valid = ume_model.predict(valid_sample)\n 126 | ume_predictions_valid\n 127 | ume_preds_filtered = ume_predictions_valid.dropna(subset=['mcc_code'])\n 128 | ume_preds_filtered \n 129 | import csv\n 130 | ume_preds_filtered[:5000].to_csv('/projects/dnaomi/bt-retry-global-refresh/deployment/cosmos_ai_valid_data.csv', quoting=csv.QUOTE_NONE, sep='\\x07', index=False)\n 131 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-refresh/deployment/cosmos_ai_valid_data.csv -tgt bt-retry-v2/cosmos_ai_valid_data_5000_2.csv\n 132 | # #### Sample by sample\n 133 | for i in range(10):\n 134 |     single_example_dict = valid_sample[features].iloc[i, :].to_dict()\n 135 | # #### Validate\n 136 | valid_mismatches = validate_model(model_file, VALID_SAMPLE_PATH, \"v2_score\", delta=1e-6)\n 137 | # ***\n 138 | # ***\n 139 | # ***\n 140 | # ***"
  }
}