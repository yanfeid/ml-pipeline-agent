{
  "edited_notebooks": {
    "driver_creation": "# %%\n## gsutil authentication\n%ppauth\n# %%                    \nfrom rmr_config.simple_config import Config\nfrom rmr_config.state_manager import StateManager\nimport os, sys, ast, json\nfrom datetime import datetime\n\nif \"working_path\" not in globals():\n    from pathlib import Path\n    path = Path(os.getcwd())\n    working_path = path.parent.absolute()\n\nfolder = os.getcwd()\nusername = os.environ['NB_USER']\nparams_path = os.path.join(working_path, 'config')\nconfig = Config(params_path)\nlocal_base_path = config.get(\"general\",\"local_output_base_path\")\nos.makedirs(local_base_path, exist_ok=True)\n\n# set working directory\nos.chdir(working_path)\n# %%\nif not config:\n    raise ValueError('config is not correctly setup')\n                \nprint(f'username={username}, working_path={working_path}')\n                    \n# %%\nsection_name = \"driver_creation\"\n\n# %%\n# General Parameters \nmo_name = config.get('general', 'mo_name')\ndriver_dataset = config.get('general', 'driver_dataset')\ndataproc_project_name = config.get('general', 'dataproc_project_name')\ndataproc_storage_bucket = config.get('general', 'dataproc_storage_bucket')\ngcs_base_path = config.get('general', 'gcs_base_path')\nqueue_name = config.get('general', 'queue_name')\ncheck_point = config.get('general', 'check_point')\nstate_file = config.get('general', 'state_file')\n\n# Section-Specific Parameters (from solution.ini)\nstrategy_type_list = config.get(section_name, 'strategy_type_list')\ndate_range_start = config.get(section_name, 'date_range_start')\ndate_range_end = config.get(section_name, 'date_range_end')\nrandom_sampling_factor = config.get(section_name, 'random_sampling_factor')\ntrain_downsampling_factor = config.get(section_name, 'train_downsampling_factor')\nvalidation_downsampling_factor_start = config.get(section_name, 'validation_downsampling_factor_start')\nvalidation_downsampling_factor_end = config.get(section_name, 'validation_downsampling_factor_end')\noot_downsampling_factor = config.get(section_name, 'oot_downsampling_factor')\ntrain_dataset_path = config.get(section_name, 'train_dataset_path')\nvalidation_dataset_path = config.get(section_name, 'validation_dataset_path')\ntest_dataset_path = config.get(section_name, 'test_dataset_path')\n\n# Dependencies from Previous Sections=====\n\n# %%\n# %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n# %config PPMagics.autolimit=0\n# %% [markdown]\n# # 1. Pull Base Transactions\n# %%\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions as\n(\n    select *\n    from pypl-edl.braintree_raw_tables.gateway_transactions\n    where retried_transaction_fk is not null\n    and strategy_type in strategy_type_list -- the set of available strategies may change in the future \n    and created_at between date_range_start and date_range_end  -- date range\n    and abs(mod(farm_fingerprint(cast(retried_transaction_fk as string)), 1000)) < random_sampling_factor  -- random sampling factor\n);\n# %%\nselect count(*), min(created_at), max(created_at)\nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions\n# %% [markdown]\n# # 2. Categorize Decline Codes, Pull Primary Retry Transactions\n# %%\ncreate temp function IsHardDecline(code STRING)\n    returns STRING\n    as (IF(code in ('2004','2005','2006','2007','2008','2009','2010','2011','2012','2013','2014','2015',\n                    '2017','2018','2019','2020','2021','2022','2023','2024','2027','2028','2029','2030',\n                    '2031','2032','2033','2036','2037','2039','2041','2043','2044','2045','2047','2049',\n                    '2050','2051','2052','2053','2054','2055','2056','2058','2059','2060','2061','2063',\n                    '2064','2065','2066','2067','2068','2069','2070','2071','2072','2073','2074','2075',\n                    '2076','2077','2079','2081','2082','2083','2084','2085','2086','2087','2088','2089',\n                    '2090','2091','2093','2094','2095','2096','2097','2098','2100', '2107', '2108'), -- ADDED '2107', '2108'\n           'Y', 'N'));\ncreate temp function IsSoftDecline(code STRING)\n    returns STRING\n    as (IF((code in ('2002','2003','2016','2025', -- DELETED '2000','2001'\n                     '2026','2034','2035','2038','2040','2042',\n                     '2046','2048','2057','2062','2092','2099',\n                     '2101', '2102','2103','2104','2105','2106','3000')) -- ADDED ,'2101', '2102','2103','2104','2105','2106','3000'\n           or ((code >= '2109') and (code < '3000')), -- CHANGED > '2100' to >= '2109'\n           'Y', 'N'));\ncreate temp function IsDecline(code STRING)\n    returns STRING\n    as (IF((code >= '2000') and (code < '3000'), 'Y', 'N'));\ncreate temp function IsSuccess(code STRING)\n    returns STRING\n    as (IF(code in ('1000','1001','1002','1003'), 'Y', 'N'));\ncreate temp function IsNoHonor(code STRING)\n    returns STRING\n    as (IF(code = '2000', 'Y', 'N'));\ncreate temp function IsNSF(code STRING)\n    returns STRING\n    as (IF(code = '2001', 'Y', 'N'));\ncreate temp function IsInvalidCC(code STRING)\n    returns STRING\n    as (IF(code = '2005', 'Y', 'N'));\ncreate temp function IsNetworkUnavailable(code STRING)\n    returns STRING\n    as (IF(code = '3000', 'Y', 'N'));\ncreate temp function IsRetry(retried_transaction_fk INT64)\n    returns STRING\n    as (IF(retried_transaction_fk is null, 'N', 'Y'));\ncreate temp function ResponseType(code STRING)\n    returns STRING\n    as\n        (case\n            when code is null then 'NULL'\n            when IsSuccess(code) = 'Y' then 'SUCCESS'\n            when IsNoHonor(code) = 'Y' then 'NO HONOR'\n            when IsNSF(code) = 'Y' then 'NSF'\n            when IsInvalidCC(code) = 'Y' then 'INVALID CC'\n            when (IsSoftDecline(code) = 'Y' and IsNSF(code) = 'N' and IsNoHonor(code) = 'N') then 'SOFT OTHER'\n            when (IsHardDecline(code) = 'Y' and IsInvalidCC(code) = 'N') then 'HARD OTHER'\n            else 'OTHER'\n        end);\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions as\n(\n    select\n        date(pri.created_at) as dt,\n        -- other\n        case when pri.cvv_response_code='M' then 1 else 0 end  as is_cvv_present,\n        pri.recurring as recurring,\n        pri.vaulted_credential_type as vaulted_credential_type,\n        -- amount fields\n        pri.currency_iso_code as currency_iso_code,\n        pri.amount_requested as amount_requested,\n        pri.amount_authorized as amount_authorized,\n        pri.amount_submitted_for_settlement as amount_submitted_for_settlement,\n        pri.cdc_shard,\n        -- pmt method fields\n        pri.cdc_original_payment_method_fk as cdc_original_payment_method_fk,\n        pri.payment_instrument_detail_fk as payment_instrument_detail_fk,\n        pri.payment_method_fk as payment_method_fk,\n        pmt.token as payment_method_token, -- ADDED\n        pmt.payment_instrument_type, -- ADDED \n        -- customer fields\n        pri.cdc_original_customer_fk as cdc_original_customer_fk,\n        -- merchant fields\n        pri.cdc_original_merchant_account_fk as cdc_original_merchant_account_fk,\n        pri.merchant_account_fk as merchant_account_fk,\n        pri.merchant_fk as merchant_fk,\n        merc.company_name as company_name,\n        merc.country_name as merchant_country, -- ADDED \n        -- merchant acc fields (ADDED) \n        -- merc_acc.token as merchant_account_token, \n        -- merc_acc.kind as merchant_account_kind, \n        -- primary fields\n        ---- ids and strategy\n        pri.pk as primary_txn_id,\n        pri.public_id as primary_public_id,\n        pri.strategy_type as primary_strategy_type,\n        ---- NT fields\n        pri.created_using_token as primary_created_using_token,\n        nte.enrollment_id,  -- ADDED \n        nte.enrollment_status, -- ADDED \n        nte.token_status, -- ADDED \n        ---- processor fields\n        pri.cdc_original_processor_settings_fk as cdc_original_processor_settings_fk,\n        pri.processor_response_code as primary_processor_response_code,\n        pri.processor_settings_fk as primary_processor_settings_fk,\n        pri.processor_settings_type as primary_processor_settings_type,\n        -- status fields\n        ResponseType(pri.processor_response_code) as primary_response_type,\n        -- retry fields\n        ---- ids and strategy\n        ---- NEW STUFF -----------------------\n        rank() over (partition by retry.retried_transaction_fk order by retry.created_at asc) as retry_order,\n        --------------------------------------\n        retry.pk as retry_txn_id,\n        retry.public_id as retry_public_id,\n        retry.strategy_type as retry_strategy_type,\n        ---- NT fields\n        retry.created_using_token as retry_created_using_token,\n        ---- processor fields\n        retry.cdc_original_processor_settings_fk as retry_cdc_original_processor_settings_fk,\n        retry.processor_response_code as retry_processor_response_code,\n        retry.processor_settings_fk as retry_processor_settings_fk,\n        retry.processor_settings_type as retry_processor_settings_type,\n        -- status fields\n        ResponseType(retry.processor_response_code) as retry_response_type,\n        -- add binary & string label directly\n        if(ResponseType(retry.processor_response_code) = 'SUCCESS', 'Y', 'N') as retry_is_success_y_n,\n        if(ResponseType(retry.processor_response_code) = 'SUCCESS', 1, 0) as retry_is_success\n    from\n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions retry\n    -- trying inner join directly with gateway txns\n    inner join\n        -- date range\n        (select * from pypl-edl.braintree_raw_tables.gateway_transactions where created_at between '2023-01-01' and date_range_end) pri\n    on\n        retry.retried_transaction_fk = pri.pk\n    -- trying join directly with authy merchants\n    left join\n        pypl-edl.braintree_raw_tables.authy_merchants merc\n    on\n        retry.merchant_fk = merc.pk\n    -- to get payment method fields\n    left join \n        pypl-edl.braintree_raw_tables.gateway_payment_methods pmt\n    on \n        retry.payment_method_fk = pmt.pk\n    and \n        pmt.payment_instrument_type='CreditCard'\n    -- to get NT enrollment fields\n    left join \n        pypl-edl.braintree_raw_tables.gateway_credit_cards cd\n    on \n        pmt.payment_instrument_fk = cd.pk -- CHECK THIS LOGIC\n    left join \n        pypl-edl.braintree_raw_tables.gateway_network_tokenization_enrollments nte\n    on \n        nte.pk = cd.enrollment_fk\n);\n# %%\nselect count(*), min(dt), max(dt)\nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions\n# %%\nselect \n    primary_response_type,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions\ngroup by 1\n# %% [markdown]\n# # 3. Get CC RADD Features\n# %%\n/* 1. Add FX info for amount in USD */\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset as\n(\n    select\n        retry.dt as dt,\n        retry.is_cvv_present as is_cvv_present,\n        retry.recurring as recurring,\n        retry.vaulted_credential_type as vaulted_credential_type,\n        retry.currency_iso_code as setec_currency_code,\n        retry.amount_requested as amount_requested,\n        retry.amount_authorized as amount_authorized,\n        retry.amount_submitted_for_settlement as amount_submitted_for_settlement,\n        round(retry.amount_authorized * fx.site_exchng_rate / 100, 2) as setec_txn_amt_usd,\n        retry.cdc_shard as cdc_shard,\n        retry.cdc_original_payment_method_fk as cdc_original_payment_method_fk,\n        retry.payment_instrument_detail_fk as payment_instrument_detail_fk,\n        retry.payment_method_fk as payment_method_fk,\n        retry.cdc_original_customer_fk as cdc_original_customer_fk,\n        retry.cdc_original_merchant_account_fk as cdc_original_merchant_account_fk,\n        retry.merchant_account_fk as merchant_account_fk,\n        retry.merchant_fk as merchant_fk,\n        retry.merchant_country as merchant_country,\n        retry.company_name as company_name,\n        retry.primary_txn_id as primary_txn_id,\n        retry.primary_public_id as primary_public_id,\n        retry.primary_strategy_type as primary_strategy_type,\n        retry.primary_created_using_token as primary_created_using_token,\n        retry.payment_method_token, \n        retry.payment_instrument_type, \n        retry.token_status, \n        retry.enrollment_status, \n        retry.enrollment_id,\n        retry.cdc_original_processor_settings_fk as primary_cdc_original_processor_settings_fk,\n        retry.primary_processor_response_code as primary_processor_response_code,\n        retry.primary_processor_settings_fk as primary_processor_settings_fk,\n        retry.primary_processor_settings_type as primary_processor_settings_type,\n        retry.primary_response_type as primary_response_type,\n        retry.retry_order as retry_order,\n        retry.retry_txn_id as retry_txn_id,\n        retry.retry_public_id as retry_public_id,\n        retry.retry_strategy_type as retry_strategy_type,\n        retry.retry_created_using_token as retry_created_using_token,\n        retry.retry_cdc_original_processor_settings_fk as retry_cdc_original_processor_settings_fk,\n        retry.retry_processor_response_code as retry_processor_response_code,\n        retry.retry_processor_settings_fk as retry_processor_settings_fk,\n        retry.retry_processor_settings_type as retry_processor_settings_type,\n        retry.retry_response_type as retry_response_type,\n        retry.retry_is_success_y_n as retry_is_success_y_n,\n        retry.retry_is_success as retry_is_success\n    from\n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions retry\n    left join\n        (select exchng_rate_dt, from_curr_code, site_exchng_rate from pypl-edw.pp_access_views.dim_curr_exchng_rate_dly where to_curr_code = 'USD') fx\n    on\n        retry.dt - 1 = fx.exchng_rate_dt\n    and\n        retry.currency_iso_code = fx.from_curr_code\n);\n# %%\n/* 2. Join with CC details table for CC features */\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc as\n(\n    select\n        retry.dt,\n        retry.is_cvv_present, -- RENAMED\n        retry.recurring,\n        retry.vaulted_credential_type,\n        retry.setec_currency_code,\n        retry.amount_requested,\n        retry.amount_authorized,\n        retry.amount_submitted_for_settlement,\n        retry.setec_txn_amt_usd,\n        retry.cdc_shard,\n        retry.cdc_original_payment_method_fk,\n        retry.payment_instrument_detail_fk,\n        retry.payment_method_fk,\n        retry.cdc_original_customer_fk,\n        retry.cdc_original_merchant_account_fk,\n        retry.merchant_account_fk,\n        retry.merchant_fk,\n        retry.merchant_country, \n        retry.company_name,\n        retry.primary_txn_id,\n        retry.primary_public_id,\n        retry.primary_strategy_type,\n        retry.primary_created_using_token,\n        retry.payment_method_token, \n        retry.payment_instrument_type, \n        retry.token_status, \n        retry.enrollment_status, \n        retry.enrollment_id,\n        retry.primary_cdc_original_processor_settings_fk,\n        retry.primary_processor_response_code,\n        retry.primary_processor_settings_fk,\n        retry.primary_processor_settings_type,\n        retry.primary_response_type,\n        retry.retry_order,\n        retry.retry_txn_id,\n        retry.retry_public_id,\n        retry.retry_strategy_type,\n        retry.retry_created_using_token,\n        retry.retry_cdc_original_processor_settings_fk,\n        retry.retry_processor_response_code,\n        retry.retry_processor_settings_fk,\n        retry.retry_processor_settings_type,\n        retry.retry_response_type,\n        -- CC context attributes\n        cc.pk as cc_pk,\n        cc.type as cc_type,\n        cc.issuing_bank as cc_issuing_bank,\n        cc.bin as cc_bin,\n        cc.postal_code as cc_postal_code,\n        cc.country_name as cc_country_name,\n        cc.country_of_issuance as cc_country_of_issuance,\n        cc.expiration_date as cc_exp_date,        \n        cc.debit as cc_debit,\n        cc.prepaid as cc_prepaid,\n        cc.pan_guid as cc_pan_guid,\n        cc.created_at as cc_created_at,\n        -- binary target\n        retry.retry_is_success_y_n,\n        retry.retry_is_success\n    from\n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset retry\n    left join\n        (select\n             pk,\n             type,\n             issuing_bank,\n             bin,\n             postal_code,\n             country_name,\n             country_of_issuance,\n             expiration_date,\n             debit,\n             prepaid,\n             pan_guid,\n             created_at\n         from\n             pypl-edl.braintree_raw_tables.gateway_credit_card_details where pk is not null) cc\n    on\n        retry.payment_instrument_detail_fk = cc.pk\n);\n# %%\n/* 3. Rename features to match model variable names */\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed as\n(\n    select\n        dt,\n        is_cvv_present, -- RENAMED\n        recurring as is_recurring_txn, -- RENAMED\n        vaulted_credential_type,\n        setec_currency_code,\n        amount_requested,\n        amount_authorized,\n        amount_submitted_for_settlement,\n        setec_txn_amt_usd,\n        cdc_shard as shard, -- RENAMED\n        cdc_original_payment_method_fk as original_payment_method_fk, -- RENAMED\n        payment_instrument_detail_fk,\n        payment_method_fk,\n        cdc_original_customer_fk,\n        cdc_original_merchant_account_fk as original_merchant_account_fk, -- RENAMED\n        merchant_account_fk,\n        merchant_fk,\n        company_name,\n        merchant_country, -- ADDED\n        primary_txn_id,\n        primary_public_id,\n        primary_strategy_type,\n        primary_created_using_token,\n        payment_method_token, \n        payment_instrument_type, \n        token_status, \n        enrollment_status, \n        enrollment_id,\n        primary_cdc_original_processor_settings_fk as original_processor_settings_fk, -- RENAMED\n        primary_processor_response_code,\n        primary_processor_settings_fk as processor_settings_fk, -- RENAMED\n        primary_processor_settings_type as processor_settings_type, -- RENAMED\n        primary_response_type,\n        retry_order,\n        retry_txn_id,\n        retry_public_id,\n        retry_strategy_type,\n        retry_created_using_token,\n        retry_cdc_original_processor_settings_fk,\n        retry_processor_response_code,\n        retry_processor_settings_fk,\n        retry_processor_settings_type,\n        retry_response_type,\n        cc_pk,\n        cc_type as card_type, -- RENAMED\n        cc_issuing_bank as issuer, -- RENAMED\n        cc_bin as bin, -- RENAMED\n        cc_postal_code,\n        cc_country_name,\n        cc_country_of_issuance as issuer_cntry_code, -- RENAMED\n        cc_exp_date,        \n        cc_debit,\n        if(cc_debit is True, 'debit', 'credit') as fi_usage,\n        cc_prepaid,\n        cc_pan_guid as pan_guid, -- RENAMED\n        cc_created_at,\n        retry_is_success_y_n,\n        retry_is_success\n    from\n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc\n);\n# %% [markdown]\n# # 4. Get Bin, Strategy RADD Features\n# %%\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset as\n(\n    select\n        retry.dt,\n        retry.is_cvv_present,\n        retry.is_recurring_txn,\n        retry.vaulted_credential_type,\n        retry.setec_currency_code,\n        retry.amount_requested,\n        retry.amount_authorized,\n        retry.amount_submitted_for_settlement,\n        retry.setec_txn_amt_usd,\n        retry.shard, -- RENAMED\n        retry.original_payment_method_fk, -- RENAMED\n        retry.payment_instrument_detail_fk,\n        retry.payment_method_fk,\n        retry.cdc_original_customer_fk,\n        retry.original_merchant_account_fk, -- RENAMED\n        retry.merchant_account_fk,\n        retry.merchant_fk,\n        retry.merchant_country, -- ADDED\n        retry.company_name,\n        retry.primary_txn_id,\n        retry.primary_public_id,\n        retry.primary_strategy_type,\n        retry.primary_created_using_token,\n        retry.payment_method_token, \n        retry.payment_instrument_type, \n        retry.token_status, \n        retry.enrollment_status, \n        retry.enrollment_id,\n        retry.original_processor_settings_fk, -- RENAMED\n        retry.primary_processor_response_code,\n        retry.processor_settings_fk, -- RENAMED\n        retry.processor_settings_type, -- RENAMED\n        retry.primary_response_type,\n        retry.retry_order,\n        retry.retry_txn_id,\n        retry.retry_public_id,\n        retry.retry_strategy_type,\n        retry.retry_created_using_token,\n        retry.retry_cdc_original_processor_settings_fk,\n        retry.retry_processor_response_code,\n        retry.retry_processor_settings_fk,\n        retry.retry_processor_settings_type,\n        retry.retry_response_type,\n        retry.cc_pk,\n        retry.card_type,\n        retry.issuer, -- RENAMED\n        retry.bin, -- RENAMED\n        retry.cc_postal_code,\n        retry.cc_country_name,\n        retry.issuer_cntry_code,-- RENAMED\n        retry.cc_exp_date,        \n        retry.cc_debit,\n        retry.fi_usage,\n        retry.cc_prepaid,\n        retry.pan_guid, -- RENAMED\n        retry.cc_created_at,\n        retry.retry_is_success_y_n,\n        retry.retry_is_success,\n        -- bin\n        bin.amt_pri_decline_ratio_6m as idi_bt_unbranded_retry_bin_rdd_amt_pri_decline_ratio_6m,\n        bin.amt_pri_success_ratio_21d as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_21d,\n        bin.amt_pri_success_ratio_3m as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_3m,\n        bin.amt_pri_success_ratio_7d as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_7d,\n        bin.amt_pri_success_ratio_nt_7d as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_nt_7d,\n        bin.cnt_pri_decline_ratio_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_decline_ratio_7d,\n        bin.cnt_pri_decline_ratio_nt_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_decline_ratio_nt_7d,\n        bin.cnt_pri_success_ratio_14d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d,\n        bin.cnt_pri_success_ratio_1m as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_1m,\n        bin.cnt_pri_success_ratio_6m as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_6m,\n        bin.cnt_pri_success_ratio_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d,\n        bin.cnt_pri_success_ratio_nt_14d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d,\n        bin.cnt_pri_success_ratio_nt_3m as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_3m,\n        bin.cnt_pri_success_ratio_nt_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d,\n        -- strategy\n        str.amt_retry_decline_ratio_post_nsf_7d as idi_bt_unbranded_retry_strategy_rdd_amt_retry_decline_ratio_post_nsf_7d,\n        str.amt_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_strategy_rdd_amt_retry_success_ratio_post_dnh_7d,\n        str.amt_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_amt_retry_success_ratio_post_hard_14d,\n        str.cnt_first_retry_success_ratio_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d,\n        str.cnt_first_retry_success_ratio_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d,\n        str.cnt_first_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d,\n        str.cnt_first_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d,\n        str.cnt_first_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d,\n        str.cnt_first_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d,\n        str.cnt_first_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d,\n        str.cnt_first_retry_success_ratio_post_nsf_1m as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_1m,\n        str.cnt_first_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d,\n        str.cnt_first_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d,\n        str.cnt_first_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d,\n        str.cnt_retry_decline_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_decline_ratio_post_hard_14d,\n        str.cnt_retry_success_ratio_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d,\n        str.cnt_retry_success_ratio_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d,\n        str.cnt_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d,\n        str.cnt_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d,\n        str.cnt_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d,\n        str.cnt_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d,\n        str.cnt_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d,\n        str.cnt_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d,\n        str.cnt_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d,\n        str.cnt_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d,\n        -- bin strategy\n        bin_str.amt_first_retry_decline_ratio_7d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_first_retry_decline_ratio_7d,\n        bin_str.amt_first_retry_decline_ratio_post_nsf_7d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_first_retry_decline_ratio_post_nsf_7d,\n        bin_str.amt_first_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_first_retry_success_ratio_post_hard_7d,\n        bin_str.amt_retry_decline_ratio_post_nsf_1m as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_decline_ratio_post_nsf_1m,\n        bin_str.amt_retry_decline_ratio_post_soft_1m as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_decline_ratio_post_soft_1m,\n        bin_str.amt_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_success_ratio_post_dnh_14d,\n        bin_str.amt_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_success_ratio_post_nsf_14d,\n        bin_str.cnt_first_retry_success_ratio_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d,\n        bin_str.cnt_first_retry_success_ratio_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d,\n        bin_str.cnt_first_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d,\n        bin_str.cnt_first_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d,\n        bin_str.cnt_first_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d,\n        bin_str.cnt_first_retry_success_ratio_post_hard_1m as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_1m,\n        bin_str.cnt_first_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d,\n        bin_str.cnt_first_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d,\n        bin_str.cnt_first_retry_success_ratio_post_nsf_1m as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_1m,\n        bin_str.cnt_first_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d,\n        bin_str.cnt_first_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d,\n        bin_str.cnt_first_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d,\n        bin_str.cnt_retry_decline_ratio_post_dnh_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_decline_ratio_post_dnh_7d,\n        bin_str.cnt_retry_success_ratio_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d,\n        bin_str.cnt_retry_success_ratio_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d,\n        bin_str.cnt_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d,\n        bin_str.cnt_retry_success_ratio_post_dnh_1m as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_1m,\n        bin_str.cnt_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d,\n        bin_str.cnt_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d,\n        bin_str.cnt_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d,\n        bin_str.cnt_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d,\n        bin_str.cnt_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d,\n        bin_str.cnt_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d,\n        bin_str.cnt_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\n    from\n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed retry\n    left join\n        pypl-edw.pp_cmt_access_views.bt_unbranded_retry_bin bin\n    on\n        retry.bin = bin.bin\n    and\n        retry.dt = date(bin.dt)\n    left join\n        pypl-edw.pp_cmt_access_views.bt_unbranded_retry_strategy str\n    on\n        retry.retry_strategy_type = str.retry_strategy_type\n    and\n        retry.dt = date(str.dt)\n    left join\n        pypl-edw.pp_cmt_access_views.bt_unbranded_retry_bin_strategy bin_str\n    on\n        retry.bin = bin_str.bin\n    and\n        retry.retry_strategy_type = bin_str.retry_strategy_type\n    and\n        retry.dt = date(bin_str.dt)\n);\n# %% [markdown]\n# ## Convert BIGNUMERIC to Numeric\n# %%\nselect column_name, data_type\nfrom pypl-edw.pp_cmt_access_views.INFORMATION_SCHEMA.COLUMNS\nwhere table_name = 'bt_unbranded_retry_bin'\norder by data_type\n# %%\nselect column_name, data_type\nfrom pypl-bods.gds_pacman_prod.INFORMATION_SCHEMA.COLUMNS\nwhere table_name = 'bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast'\norder by data_type\n# %%\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast as\n(\n    select \n    * except (setec_txn_amt_usd),\n    cast(setec_txn_amt_usd as float64) as setec_txn_amt_usd, \n    from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset\n) \n# %%\nselect retry_strategy_type, count (*) \nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\nwhere idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null \ngroup by 1\n# %%\nselect count(*), sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null then 1 else 0 end) \nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\n# %%\nwith sub as ( select *\nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\nwhere idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null \n ) \nselect \nsum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n  from sub\n# %%\nselect dt, sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end), count(*)\nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\ngroup by 1\norder by 2 desc\n# %% [markdown]\n# # 5. Additional features in V1\n# %% [markdown]\n# ## Get 3DS Features from BT 3DS Verifications Table\n# %%\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds as\n(\n    select \n        driver.*, \n        -- 3ds related features\n        tdsv.liability_shifted, \n        tdsv.liability_shift_possible,\n        case when tdsv.report_status = 'exemption_low_value_successful' then 1 \n             when tdsv.report_status = 'data_only_successful' then 1  \n             when tdsv.report_status = 'exemption_tra_successful' then 1 \n             when tdsv.report_status = 'authenticate_successful' then 1 \n             else 0 end as success_3ds\n    from \n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast driver\n    left join \n        pypl-edl.braintree_raw_tables.gateway_three_d_secure_results tdsr\n    on \n        tdsr.requester_fk = driver.primary_txn_id \n    and \n        tdsr.requester_type = 'Transaction'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_three_d_secure_verifications tdsv\n    on \n        tdsr.three_d_secure_verification_public_id = tdsv.public_id\n) \n# %%\nselect \n    success_3ds, \n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds \ngroup by 1 \n# %% [markdown]\n# ## Get Verification Feature from linking verification with payment method, then to transaction\n# %%\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver as\n(\n    select \n        base.*, \n        case when ver.pk is not null then 1 else 0 end as verifications_txn \n        --ver.pk as verification_pmt_method\n    from \n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds base\n    left join \n        pypl-edl.braintree_raw_tables.gateway_verifications ver\n    on \n        base.payment_method_fk = ver.payment_method_fk\n    and \n        base.merchant_fk = ver.merchant_fk \n    and \n        base.dt = date(ver.created_at)\n    and \n        ver.status = 'verified'\n) \n# %%\nselect status, count(*)\nfrom pypl-edl.braintree_raw_tables.gateway_verifications \ngroup by 1\norder by 2 desc \nlimit 10 \n# %%\nselect sum(verifications_txn) / count(*) * 100\nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver\n# %% [markdown]\n# ## Get Fastlane Feature from gateway_vaulted_payment_method_grants table\n#\n# - payment_method_fk found in gateway_vaulted_payment_method_grants denotes Fastlane transaction\n# %%\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl as\n(\n    select \n        base.*, \n        case when fl.pk is not null then 1 else 0 end as fastlane_txn \n    from \n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver base\n    left join \n        pypl-edl.braintree_raw_tables.gateway_vaulted_payment_method_grants fl\n    on \n        base.payment_method_fk = fl.payment_method_fk\n    and \n        base.merchant_fk = fl.merchant_fk \n    and \n        base.dt = date(fl.created_at)\n) \n# %% [markdown]\n# ## Get mcc_code\n# %%\nselect processor_settings_type, count(*)\nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl\ngroup by 1\n# %%\n-- base population of all txns \ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc ;\ncreate table if not exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc as\n(\n    select\n         b.*, \n        case when processor_settings_type = 'Salem::Settings' then salem.mcc\n        when processor_settings_type = 'Adyen::Settings' then adyen.merchant_category_code\n        when processor_settings_type = 'WorldPay::Settings'then wp.merchant_category_code\n        when processor_settings_type = 'FirstData::Settings'then fd.merchant_category_code\n        when processor_settings_type = 'VisaDirect::Settings'then vd.merchant_category_code\n        when processor_settings_type = 'MastercardDirect::Settings'then md.country_code\n        when processor_settings_type = 'Integrations::Settings' then i.merchant_category_code\n        when processor_settings_type = 'AIB::Settings' then aib.merchant_category_code\n        when processor_settings_type = 'CardProcessor::Settings' then cp.merchant_category_code\n        when processor_settings_type = 'OmnipayDirect::Settings' then od.merchant_category_code\n        when processor_settings_type = 'AmexDirect::Settings' then amex.merchant_category_code\n        when processor_settings_type = 'PayPalClosedLoop::Settings' then ppcl.merchant_category_code\n        when processor_settings_type = 'Tsys::Settings' then tsys.merchant_category_code \n        when processor_settings_type = 'Nab::Settings' then nab.merchant_category_code\n        when processor_settings_type = 'Moneris::Settings' then moneris.merchant_category_code\n        when processor_settings_type = 'CustomActions::Settings' then ca.merchant_category_code \n        else null end as mcc_code, \n    from\n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl  b \n    left join \n        pypl-edl.braintree_raw_tables.gateway_salem_settings salem\n    on \n        b.processor_settings_fk = salem.pk \n    and \n        b.processor_settings_type = 'Salem::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_adyen_settings adyen\n    on \n        b.processor_settings_fk = adyen.pk \n    and \n        b.processor_settings_type = 'Adyen::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_world_pay_settings wp\n    on \n        b.processor_settings_fk = wp.pk \n    and \n        b.processor_settings_type = 'WorldPay::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_first_data_settings fd\n    on \n        b.processor_settings_fk = fd.pk \n    and \n        b.processor_settings_type = 'FirstData::Settings'\n    left join \n    (\n        select \n            i_sub.pk, \n            amex.merchant_category_code,\n            amex.acquirer_country\n        from\n            pypl-edl.braintree_raw_tables.gateway_integrations_settings i_sub\n        left join \n            pypl-edl.braintree_raw_tables.gateway_amex_direct_settings amex\n        on \n            i_sub.gateway_amex_direct_settings_fk = amex.pk \n    ) i\n    on \n        b.processor_settings_fk = i.pk \n    and \n        b.processor_settings_type = 'Integrations::Settings'\n    left join \n    ( select \n         v.pk, \n         fd.merchant_category_code,\n         fd.country_code\n    from\n        pypl-edl.braintree_raw_tables.gateway_visa_direct_settings v \n    inner join \n        pypl-edl.braintree_raw_tables.gateway_first_data_settings fd\n    on \n        v.first_data_settings_fk = fd.pk ) vd\n    on \n        b.processor_settings_fk = vd.pk \n    and \n        b.processor_settings_type = 'VisaDirect::Settings'\n        left join \n    ( select \n         m.pk, \n         fd.merchant_category_code,\n         fd.country_code\n    from\n        pypl-edl.braintree_raw_tables.gateway_mastercard_direct_settings m\n    inner join \n        pypl-edl.braintree_raw_tables.gateway_first_data_settings fd\n    on \n        m.first_data_settings_fk = fd.pk ) md\n    on \n        b.processor_settings_fk = md.pk \n    and \n        b.processor_settings_type = 'MastercardDirect::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_aib_settings aib\n    on \n        b.processor_settings_fk = aib.pk \n    and \n        b.processor_settings_type = 'AIB::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_card_processor_settings cp\n    on \n        b.processor_settings_fk = cp.pk \n    and \n        b.processor_settings_type = 'CardProcessor::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_omnipay_direct_settings od\n    on \n        b.processor_settings_fk = od.pk \n    and \n        b.processor_settings_type = 'OmnipayDirect::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_amex_direct_settings amex\n    on \n        b.processor_settings_fk = amex.pk \n    and \n        b.processor_settings_type = 'AmexDirect::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_nab_settings nab\n    on \n        b.processor_settings_fk = nab.pk \n    and \n        b.processor_settings_type = 'Nab::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_moneris_settings moneris\n    on \n        b.processor_settings_fk = moneris.pk \n    and \n        b.processor_settings_type = 'Moneris::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_paypal_closed_loop_settings ppcl\n    on \n        b.processor_settings_fk = ppcl.pk \n    and \n        b.processor_settings_type = 'PayPalClosedLoop::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_tsys_settings tsys\n    on \n        b.processor_settings_fk = tsys.pk \n    and \n        b.processor_settings_type = 'Tsys::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_custom_actions_settings ca\n    on \n        b.processor_settings_fk = ca.pk \n    and \n        b.processor_settings_type = 'CustomActions::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_seb_settings seb\n    on \n        b.processor_settings_fk = seb.pk \n    and \n        b.processor_settings_type = 'Seb::Settings'\n    left join \n        pypl-edl.braintree_raw_tables.gateway_fake_processor_settings fp\n    on \n        b.processor_settings_fk = fp.pk \n    and \n        b.processor_settings_type = 'FakeProcessor::Settings'\n) \n# %% [markdown]\n# ## (SKIP) Get BT24 Risk Score\n# %%\n-- drop table if exists  pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc_bt24 ;\n-- create table if not exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc_bt24 as\n-- (\n--     select \n--         b.*, \n--         -- features to pull BT Risk RADDs\n--         uds.correlation_id, \n--         --uds.merchant_fk, \n--         uds.cc_hash, \n--         case when uds.cc_bin is not null and uds.cc_last_4 is not null and uds.cc_expiration_date is not null \n--             then CONCAT(uds.cc_bin,'-', uds.cc_last_4,'-', uds.cc_expiration_date ) else null end as cc_bin_last_exp, \n--         case when (uds.cc_bin is not null and uds.cc_country_of_issuance_2letters is not null ) then\n--             CONCAT(uds.cc_bin,'-',uds.cc_country_of_issuance_2letters) else null end as cc_bin_country_of_issuance, \n--         uds.phone, \n--         uds.email, \n--         uds.created_at_utc, \n--         DATETIME(created_at_utc, \"America/Los_Angeles\") as created_at_pt,\n--         uds.pit_timestamp,\n--         -- BT Risk Scores \n--         uds.bt19_model_score1, \n--         uds.bt21_model_score1, \n--         uds.bt23_model_score1, \n--         uds.bt24_model_score1, \n--         -- BT UDS Context Features\n--         uds.mcc_code as mcc_code_uds, \n--         -- uds.refund_flag,\n--         -- uds.sender_ip1, \n--         -- uds.sender_ip2, \n--         -- uds.sender_ip3,\n--         -- uds.tenant_numeric_ip4,\n--         -- uds.tenant_numeric_ip3,\n--         -- uds.tenant_numeric_ip2,\n--         -- uds.tenant_numeric_ip1,\n--         -- uds.tenant_string_ip,\n--         -- uds.tenant_string_ip1,\n--         -- uds.tenant_string_ip2,\n--         -- uds.tenant_string_ip3,\n--         -- uds.is_refund_or_preauth, \n--         -- uds.ar_fraud_reason, \n--         -- uds.cc_segment,\n--         -- uds.has_legal_restriction, \n--         -- uds.legal_scenario, \n--         -- uds.cc_trust, \n--         -- uds.fraud_status, \n--         -- label related features \n--         --uds.amount_submitted_for_settlement, \n--         --uds.send_receipt_on_submit_for_settlement,\n--         --uds.has_partial_settlement_transactions, \n--         --uds.disputed_at, \n--         --uds.is_cc_bad, \n--     from\n--         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc  b\n--     left join \n--         ( select * \n--          from pypl-bods.pp_risk_rap_bt_managed_pii_views.bt_txn_uds \n--          where date(created_at_utc, \"America/Los_Angeles\") >= \"2023-08-01\" \n--         ) uds\n--     on\n--         b.primary_txn_id = uds.pk \n-- ) \n# %% [markdown]\n# # Filter NA RADDs to simulate ground-truth missing rate\n# %%\nwith sub as ( select *\nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered\nwhere idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null \n ) \nselect \nsum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n  from sub\n# %%\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered as\n(\n    select * \n    from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc_bt24\n    where idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null\n) \n# %% [markdown]\n# # Deduplicate\n# %%\ndrop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup;\ncreate table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup as\n(\nwith sub as (\n    select * \n    from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered\n) \nSELECT *\nFROM sub\nWHERE TRUE\nQUALIFY ROW_NUMBER() OVER (PARTITION BY primary_txn_id ORDER BY dt DESC) = 1\n) \n# %%\nselect count(*), count(distinct primary_txn_id)\nfrom pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n# %% [markdown]\n# # 5. Train-Val-Test Split\n# %% [markdown]\n# - we want a random sample across all time period, because we want the model to learn patterns from the entire history up to model training date \n# %%\ndrop table if exists train_dataset_path;\ncreate table train_dataset_path as\n(\n    select\n        *\n    from\n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n    where\n        retry_order = 1\n    and\n        abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) < train_downsampling_factor  -- train downsampling factor\n);\ndrop table if exists validation_dataset_path;\ncreate table validation_dataset_path as\n(\n    select\n        *\n    from\n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n    where\n        retry_order = 1\n    and\n        abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) >= validation_downsampling_factor_start  -- validation downsampling factor\n    and\n        abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) < validation_downsampling_factor_end\n);\ndrop table if exists test_dataset_path;\ncreate table test_dataset_path as\n(\n    select\n        *\n    from\n        pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n    where\n        retry_order = 1\n    and\n        abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) >= oot_downsampling_factor  -- OOT downsampling factor\n);\n# %%\nselect\n    retry_is_success,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom train_dataset_path\ngroup by 1\n# %%\nselect\n    primary_response_type,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom train_dataset_path\ngroup by 1\norder by 2 desc\n# %%\nselect\n    retry_strategy_type,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom train_dataset_path\ngroup by 1\norder by 2 desc\n# %%\nselect count(*), min(dt), max(dt) \nfrom train_dataset_path\n# %%\nselect count(*), min(dt), max(dt) \nfrom validation_dataset_path\n# %%\nselect\n    retry_is_success,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom validation_dataset_path\ngroup by 1\norder by 2 desc\n# %%\nselect\n    primary_response_type,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom validation_dataset_path\ngroup by 1\norder by 2 desc\n# %%\nselect\n    retry_strategy_type,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom validation_dataset_path\ngroup by 1\norder by 2 desc\n# %%\nselect count(*), min(dt), max(dt) \nfrom test_dataset_path\n# %%\nselect\n    retry_is_success,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom test_dataset_path\ngroup by 1\norder by 2 desc\n# %%\nselect\n    primary_response_type,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom test_dataset_path\ngroup by 1\norder by 2 desc\n# %%\nselect\n    retry_strategy_type,\n    count(*) as n,\n    count(*) / sum(count(*)) over() * 100 as n_perc, \nfrom test_dataset_path\ngroup by 1\norder by 2 desc\n# %%\nselect *\nfrom test_dataset_path\nlimit 3\n# %% [markdown]\n# ## Copy to pp_scratch for QPull purposes\n# %%\ndrop table if exists pypl-edw.pp_scratch.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3;\ncreate table pypl-edw.pp_scratch.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3 as\n(\n    select\n        *\n    from\n        test_dataset_path\n) \n# %%\n",
    "driver_creation_2": "# %%\n## gsutil authentication\n%ppauth\n# %%                    \nfrom rmr_config.simple_config import Config\nfrom rmr_config.state_manager import StateManager\nimport os, sys, ast, json\nfrom datetime import datetime\n\nif \"working_path\" not in globals():\n    from pathlib import Path\n    path = Path(os.getcwd())\n    working_path = path.parent.absolute()\n\nfolder = os.getcwd()\nusername = os.environ['NB_USER']\nparams_path = os.path.join(working_path, 'config')\nconfig = Config(params_path)\nlocal_base_path = config.get(\"general\",\"local_output_base_path\")\nos.makedirs(local_base_path, exist_ok=True)\n\n# set working directory\nos.chdir(working_path)\n# %%\nif not config:\n    raise ValueError('config is not correctly setup')\n                \nprint(f'username={username}, working_path={working_path}')\n                    \n# %%\nsection_name = \"driver_creation_2\"\n\n# %%\n# General Parameters \nmo_name = config.get('general', 'mo_name')\ndriver_dataset = config.get('general', 'driver_dataset')\ndataproc_project_name = config.get('general', 'dataproc_project_name')\ndataproc_storage_bucket = config.get('general', 'dataproc_storage_bucket')\ngcs_base_path = config.get('general', 'gcs_base_path')\nqueue_name = config.get('general', 'queue_name')\ncheck_point = config.get('general', 'check_point')\nstate_file = config.get('general', 'state_file')\n\n# Section-Specific Parameters (from solution.ini)\ntrain_source_table_name = config.get(section_name, 'train_source_table_name')\nvalidation_source_table_name = config.get(section_name, 'validation_source_table_name')\ntest_source_table_name = config.get(section_name, 'test_source_table_name')\ntemporary_gcs_bucket = config.get(section_name, 'temporary_gcs_bucket')\ntrain_target_gcs_path = config.get(section_name, 'train_target_gcs_path')\nvalidation_target_gcs_path = config.get(section_name, 'validation_target_gcs_path')\ntest_target_gcs_path = config.get(section_name, 'test_target_gcs_path')\n\n# Dependencies from Previous Sections=====\n# Previous section: driver_creation\n# Edge Attributes from DAG\ntrain_dataset_path = config.get('driver_creation', 'train_dataset_path')\nvalidation_dataset_path = config.get('driver_creation', 'validation_dataset_path')\ntest_dataset_path = config.get('driver_creation', 'test_dataset_path')\n\n# %%\n# %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n# %config PPMagics.autolimit=0\n# %%\n# %%url --dataproc --cluster dnaomi-bt-retry --project ccg24-hrzana-gds-pacman\n# %%\n# %%configure -f\n{\n    \"conf\": {\n        \"spark.jars\": \"gs://spark-lib/bigquery/spark-bigquery-with-dependencies_2.12-0.18.1.jar\",\n        \"spark.executor.extraClassPath\": \"spark-bigquery-with-dependencies_2.12-0.18.1.jar\",\n        \"spark.driver.extraClassPath\": \"spark-bigquery-with-dependencies_2.12-0.18.1.jar\"\n    }\n}\n# %%\nspark.conf.set(\"viewsEnabled\", \"true\")\nspark.conf.set(\"materializationProject\", \"pypl-edw\")\nspark.conf.set(\"materializationDataset\", \"pp_scratch\")\n# try also pypl-bods.rsh_row_gds_pacman\nspark.conf.set('temporaryGcsBucket', \"pypl-bkt-rsh-row-std-gds-pacman\")\n# %%\ndef create_bigquery_table(source_table_name, target_table_name):\n    df = spark.read.format('bigquery') \\\n        .option('table', source_table_name) \\\n        .load()\n    df.write.format('bigquery').mode('overwrite') \\\n    .option('table', target_table_name) \\\n    .save()\ndef create_gcs_table(source_table_name, target_path):\n    df = spark.read.format('bigquery') \\\n        .option('table', source_table_name) \\\n        .load()\n    df.write.mode('overwrite') \\\n    .parquet(target_path)\n# %%\n# %%\ncreate_gcs_table(train_source_table_name, train_target_gcs_path)\n# %%\n# %%\ncreate_gcs_table(validation_source_table_name, validation_target_gcs_path)\n# %%\n# %%\ncreate_gcs_table(test_source_table_name, test_target_gcs_path)\n# %%\n# #!gsutil -m cp -r gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_control_train data/\n# %%\n# ##!gsutil -m cp -r gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/train_dataset_path data/\n",
    "model_training": "# %%\n## gsutil authentication\n%ppauth\n# %%                    \nfrom rmr_config.simple_config import Config\nfrom rmr_config.state_manager import StateManager\nimport os, sys, ast, json\nfrom datetime import datetime\n\nif \"working_path\" not in globals():\n    from pathlib import Path\n    path = Path(os.getcwd())\n    working_path = path.parent.absolute()\n\nfolder = os.getcwd()\nusername = os.environ['NB_USER']\nparams_path = os.path.join(working_path, 'config')\nconfig = Config(params_path)\nlocal_base_path = config.get(\"general\",\"local_output_base_path\")\nos.makedirs(local_base_path, exist_ok=True)\n\n# set working directory\nos.chdir(working_path)\n# %%\nif not config:\n    raise ValueError('config is not correctly setup')\n                \nprint(f'username={username}, working_path={working_path}')\n                    \n# %%\nsection_name = \"model_training\"\n\n# %%\n# General Parameters \nmo_name = config.get('general', 'mo_name')\ndriver_dataset = config.get('general', 'driver_dataset')\ndataproc_project_name = config.get('general', 'dataproc_project_name')\ndataproc_storage_bucket = config.get('general', 'dataproc_storage_bucket')\ngcs_base_path = config.get('general', 'gcs_base_path')\nqueue_name = config.get('general', 'queue_name')\ncheck_point = config.get('general', 'check_point')\nstate_file = config.get('general', 'state_file')\n\n# Section-Specific Parameters (from solution.ini)\ntrain_parquet_path = config.get(section_name, 'train_parquet_path')\nval_parquet_path = config.get(section_name, 'val_parquet_path')\nfeatures_path = config.get(section_name, 'features_path')\ntarget_column = config.get(section_name, 'target_column')\nmodel_artifact_path = config.get(section_name, 'model_artifact_path')\nmetric_values = config.get(section_name, 'metric_values')\n\n# Dependencies from Previous Sections=====\n# Previous section: driver_creation_2\n# Edge Attributes from DAG\ntrain_target_gcs_path = config.get('driver_creation_2', 'train_target_gcs_path')\nvalidation_target_gcs_path = config.get('driver_creation_2', 'validation_target_gcs_path')\n\n# %%\n# %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n# %config PPMagics.autolimit=0\n# %%\n# %config Completer.use_jedi = False\n# %load_ext autoreload\n# %autoreload 2\n# %%\nimport os\nimport json\nfrom functools import partial\nimport joblib\nimport numpy as np\nimport pandas as pd\nfrom pathlib import Path\nimport lightgbm as lgb\nfrom lightgbm import LGBMClassifier\nimport optuna\nimport mlflow\nimport mlflow.lightgbm\n# %%\n# !pip install optuna\n# %%\npd.set_option('display.max_rows', 1000)\npd.set_option('display.max_colwidth', 1000)\npd.options.display.float_format = '{:.6f}'.format\n# %% [markdown]\n# ## Helper functions\n# %%\ndef list_to_txt(lst, folder, path):\n    \"\"\"Save a list to text file\n    \"\"\"\n    with open(folder + path, mode=\"w\") as f:\n        f.write(\"\\n\".join(lst))\ndef list_from_txt(path):\n    \"\"\"Return a list with each element containing a line\n        of the file in the given path\n    \"\"\"\n    with open(path, mode=\"r\") as f:\n        lst = [line.rstrip() for line in f.readlines()]\n    return lst\ndef write_dict_to_json(folder, output_path, dictionary):\n    \"\"\"\n    Write dictionary into JSON\n    \"\"\"\n    with open(folder + output_path, \"w\") as outfile:\n        json.dump(dictionary, outfile)\ndef read_dict_from_json(folder, input_path):\n    \"\"\"\n    Read JSON from given path as dictionary\n    \"\"\"\n    with open(folder + input_path) as json_file:\n        data = json.load(json_file)\n    return data\ndef convert_column_types(df, numerical_columns, integer_columns, categorical_columns):\n    \"\"\"Convert numerical, integer and categorical columns of provided\n    pandas.DataFrame\n        Specificaly, convert categorical columns to pandas.Categorical,\n        numerical columns to numpy.float32 and\n        integer columns to numpy.int64\n    \"\"\"\n    for col in categorical_columns:\n        df[col] = pd.Categorical(df[col])\n    for col in numerical_columns:\n        df[col] = df[col].astype(np.float32)\n    for col in integer_columns:\n        df[col] = df[col].astype(np.int64)\n    return df\n# %%\n\"\"\"\nBT Retry Global\nUseful metrics functions.\n\"\"\"\nimport numpy as np\nfrom sklearn.metrics import precision_recall_curve, auc\ndef precision_at_recall(y_true, y_score, recall_value):\n    \"\"\"Precision at the given recall value\n    \"\"\"\n    precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n    if np.sum(recalls >= recall_value) == 0:\n        return 0.\n    idx = np.argmin(recalls[recalls >= recall_value])\n    precision_value = precisions[idx]\n    return precision_value\ndef threshold_at_recall(y_true, y_score, recall_value):\n    \"\"\"Threshold at the given recall value\n    \"\"\"\n    precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n    if np.sum(recalls >= recall_value) == 0:\n        return 0.\n    idx = np.argmin(recalls[recalls >= recall_value])\n    threshold = thresholds[idx - 1]\n    return threshold\ndef savings_at_recall(y_true, y_score, recall_value):\n    \"\"\"Positive prediction rate savings at the given recall value\n    \"\"\"\n    precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n    if np.sum(recalls >= recall_value) == 0:\n        return 0.\n    idx = np.argmin(recalls[recalls >= recall_value])\n    precision_value = precisions[idx]\n    min_ratio = y_true.mean()\n    try:\n        savings = 1 - recall_value * min_ratio / precision_value\n    except ValueError as e:\n        savings = 0.\n    return savings\n# def precision_at_recall(precisions, recalls, recall_value):\n#     \"\"\"Precision at the given recall value\n#     \"\"\"\n#     idx = np.argmin(recalls[recalls >= recall_value])\n#     precision_value = precisions[idx]\n#     return precision_value\n# def threshold_at_recall(thresholds, recalls, recall_value):\n#     \"\"\"Threshold at the given recall value\n#     \"\"\"\n#     idx = np.argmin(recalls[recalls >= recall_value])\n#     threshold = thresholds[idx - 1]\n#     return threshold\n# def savings_at_recall(precisions, recalls, recall_value, min_ratio):\n#     \"\"\"Positive prediction rate savings at the given recall value\n#     \"\"\"\n#     idx = np.argmin(recalls[recalls >= recall_value])\n#     precision_value = precisions[idx]\n#     return 1 - recall_value * min_ratio / precision_value\ndef partial_aucpr(y_true, y_score, recall_lb, recall_ub):\n    \"\"\"Partial Area Under the PR Curve between the given recall levels\n    \"\"\"\n    precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n    if np.sum(recalls >= recall_lb) == 0:\n        return 0.\n    idx_right = np.argmin(recalls[recalls >= recall_lb])\n    if np.sum(recalls >= recall_ub) == 0:\n        # get max recall possible\n        idx_left = np.argmax(recalls[recalls >= recall_lb])\n    else:\n        idx_left = np.argmin(recalls[recalls >= recall_ub])\n    try:\n        p_aucpr = auc(recalls[idx_left:idx_right], precisions[idx_left:idx_right])\n    except ValueError as e:\n        p_aucpr = 0.\n    return p_aucpr\ndef evaluate_metrics(y_true, y_score, metric_functions):\n    \"\"\"Evaluate a list of metrics (callables) on y_true and y_score\n    \"\"\"\n    return [score(y_true, y_score) for score in metric_functions]\ndef get_features_and_target(df, features, target_col):\n    \"\"\"Return feature matrix and 1-D label vector\n    \"\"\"\n    return df[features], df[target_col]\n# %%\npartial_aucpr_geq90 = partial(partial_aucpr, recall_lb=0.9, recall_ub=1.)\nprecision_at_95 = partial(precision_at_recall, recall_value=0.95)\nprecision_at_99 = partial(precision_at_recall, recall_value=0.99)\nsavings_at_95 = partial(savings_at_recall, recall_value=0.95)\nsavings_at_99 = partial(savings_at_recall, recall_value=0.99)\nEARLY_STOPPING_PARAMS = {\"stopping_rounds\": 10}\nEARLY_STOPPING_METRIC = \"average_precision\"\nMETRIC_FUNCTIONS = [precision_at_95, precision_at_99, savings_at_95, savings_at_99, partial_aucpr_geq90]\nMETRIC_NAMES = [\"precision_at_95\", \"precision_at_99\", \"savings_at_95\", \"savings_at_99\", \"partial_aucpr_geq90\"]\nOBJECTIVE_METRIC_NAME = \"partial_aucpr_geq90\"\n# %% [markdown]\n# ## Data\n# %%\nV1_FEATURES_PATH = Path(\n    \"/projects/dnaomi/bt-retry-global-v2/metadata/v1_features.txt\"\n)\nV1_LATEST_FEATURES_PATH = Path(\n    \"/projects/dnaomi/bt-retry-global-v2/metadata/v0_features_latest.txt\"\n)\nV2_FEATURES_PATH = Path(\n    \"/projects/dnaomi/bt-retry-global-v2/metadata/v2_features.txt\"\n)\n# %%\n# %%\nFEATURES = list_from_txt(V2_FEATURES_PATH)\nV1_FEATURES = list_from_txt(V1_LATEST_FEATURES_PATH)\n# %%\ntrain_df = pd.read_parquet(TRAIN_PARQUET_PATH)\n# %%\nval_df = pd.read_parquet(VAL_PARQUET_PATH)\n# %%\n# %%\ntrain_df['retry_strategy_type'].unique()\n# %%\nval_df['retry_strategy_type'].unique()\n# %%\n# load features and types\nnumerical_columns = [\"setec_txn_amt_usd\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\", \n                    # \"bt24_model_score1\" \n                    ]\ninteger_columns = []\nencoded_columns = []  # no encoded columns in this example\ncategorical_columns = [\"merchant_fk\",\n                       \"setec_currency_code\",\n                       \"primary_response_type\",\n                       \"processor_settings_type\", # renamed from primary_processor_settings_type\n                       \"retry_strategy_type\",\n                       \"card_type\",\n                       \"fi_usage\", \n                       \"issuer\", # renamed from cc_issuing_bank\n                       \"bin\",  # renamed from cc_bin\n                       # \"cc_postal_code\",  # REMOVED\n                       # \"cc_country_name\",  # REMOVED\n                       \"issuer_cntry_code\", # renamed from issuer_country\n                       #\"debit\", # REMOVED\n                        # \"cc_prepaid\",  # REMOVED\n                       #\"pan_guid\", # renamed from cc_pan_guid\n                       \"is_recurring_txn\", # renamed from recurring \n                       # from the latest model config file \n                       \"payment_method_token\", #  # REMOVED\n                      \"original_payment_method_fk\",  # REMOVED\n                       \"payment_instrument_type\", \n                       \"is_cvv_present\", \n                       \"enrollment_id\", \n                       \"enrollment_status\", \n                       \"token_status\", \n                      \"original_processor_settings_fk\", \n                       \"vaulted_credential_type\", \n                      \"shard\",\n                       \"mcc_code\", #NEW\n                       \"liability_shift_possible\", #NEW\n                       \"success_3ds\", #NEW\n                       \"verifications_txn\", #NEW\n                       \"fastlane_txn\" #NEW\n                      ]\ntarget_col = \"retry_is_success\"\n# %%\nfeatures = numerical_columns + integer_columns + encoded_columns + categorical_columns\n# %%\nlist_to_txt(features, \"/projects/dnaomi/bt-retry-global-v2/metadata/\", \"v2_features_final.txt\")\n# %%\ntrain_df[features].isnull().mean() * 100\n# %%\n# train_df['bt24_model_score1'] = pd.to_numeric(train_df['bt24_model_score1'])\n# %%\n# train_df['bt23_model_score1'] = pd.to_numeric(train_df['bt23_model_score1'])\n# %%\nval_df['issuer_cntry_code'] = val_df['issuer_country']\n# %%\n# convert data types\ntrain = convert_column_types(train_df,\n                             numerical_columns=numerical_columns,\n                             integer_columns=integer_columns + [target_col],\n                             categorical_columns=categorical_columns)\nvalid = convert_column_types(val_df,\n                             numerical_columns=numerical_columns,\n                             integer_columns=integer_columns + [target_col],\n                             categorical_columns=categorical_columns)\n# %%\n# get features and target\ntrain_feat, y_train = get_features_and_target(train, features=features, target_col=target_col)\nvalid_feat, y_valid = get_features_and_target(valid, features=features, target_col=target_col)\n# %%\n# best param for model with subset of strategies (all txns)\nbest_params = { \n'colsample_bytree': 0.5837239684404587,\n'learning_rate': 0.0598927112458938,\n'min_child_samples':61,\n'min_data_in_bin':25,\n'num_leaves':217,\n'num_trees':141,\n'n_estimators':141,\n'n_jobs':8,\n'reg_alpha':4.784258485091152e-08,\n'reg_lambda':0.0002699654851946926,\n'subsample':0.6899589770039457,\n'subsample_freq':5,\n}\n# %%\ntrain_ = train_feat[features]\nvalid_ = valid_feat[features]\n# %%\n#model = LGBMClassifier(**best_params)\nmodel = LGBMClassifier()\nmodel.fit(train_, y_train)\n# %%\npred_probas = model.predict_proba(valid_)\npredictions = pred_probas[:, -1]\n# %%\nmodel.booster_.save_model(model_artifact_path)\n# %%\npd.DataFrame(index=METRIC_NAMES, data=metric_values, columns=[\"value\"])\n# %%\nmetric_values\n# %%\nlgb.plot_importance(model, figsize=(10,10), importance_type='gain', max_num_features=15)\n# %%\nlgb.plot_importance(model, figsize=(10,10), importance_type='split', max_num_features=15)\n# %%\nmodel\n# %%\nfeatures = model.feature_name()\nimportances = model.feature_importance(importance_type='gain')\nfeature_importance = pd.DataFrame({'importance':importances, 'feature':features}).sort_values('importance', ascending=False).reset_index(drop=True)\nfeature_importance\n# %% [markdown]\n# ## Hyperparameter Tuning with Optuna\n# %%\n# !pwd\n# %%\nTRACKING_URL = \"https://mlflow.apps.cosmos-onprem.dp.lvs.paypalinc.com\"\nEXPERIMENT_NAME = \"bt_retry_global_v2_full_fts_strategy_subset_model_all_strat_valid_control\"  \nSTUDY_NAME = \"bt-retry-global-v1-full-fts-strategy-subset-model-all-strat-valid-control\" \nSTUDIES_DIR = \"../reports/studies/\"\nSTUDY_DIR = os.path.join(STUDIES_DIR, STUDY_NAME)\nif not os.path.exists(STUDY_DIR):\n    os.mkdir(STUDY_DIR)\nN_TRIALS = 250\nOPTUNA_STUDY_PATH = os.path.join(STUDY_DIR, STUDY_NAME + \".pkl\")\nSTDOUT_PATH = os.path.join(STUDY_DIR, STUDY_NAME + \"-stdout.txt\")\nSTDERR_PATH = os.path.join(STUDY_DIR, STUDY_NAME + \"-stdout.txt\")\nos.environ['MLFLOW_TRACKING_URL'] = TRACKING_URL\nmlflow.set_tracking_uri(os.environ['MLFLOW_TRACKING_URL'])\nmlflow.set_experiment(EXPERIMENT_NAME, os.environ['USER'])\n# %%\nOBJECTIVE_METRIC_NAME\n# %%\ndef objective(trial, objective_metric_name=OBJECTIVE_METRIC_NAME):\n    with mlflow.start_run():\n        param = {\n            \"n_jobs\": 8,\n            \"n_estimators\": trial.suggest_int(\"n_estimators\", 1, 150, 5),\n            \"min_data_in_bin\": 25,\n            \"learning_rate\": trial.suggest_loguniform(\"learning_rate\", 1e-5, 1.),\n            \"reg_alpha\": trial.suggest_loguniform(\"reg_alpha\", 1e-8, 10.0),\n            \"reg_lambda\": trial.suggest_loguniform(\"reg_lambda\", 1e-8, 10.0),\n            \"num_leaves\": trial.suggest_int(\"num_leaves\", 2, 256),\n            \"colsample_bytree\": trial.suggest_uniform(\"colsample_bytree\", 0.5, 1.0),\n            \"subsample\": trial.suggest_uniform(\"subsample\", 0.4, 0.9),\n            \"subsample_freq\": trial.suggest_int(\"subsample_freq\", 2, 5),\n            \"min_child_samples\": trial.suggest_int(\"min_child_samples\", 5, 100),\n        }\n        model = LGBMClassifier(**param)\n        model.fit(train_, y_train)                 \n        # 7.\n        pred_probas = model.predict_proba(valid_)\n        predictions = pred_probas[:, -1]\n        metrics = {name: value for name, value in zip(METRIC_NAMES, metric_values)}\n        # 8.\n        mlflow.log_params(param)\n        mlflow.log_param(\"num_trees\", model.booster_.num_trees())\n        mlflow.log_metrics(metrics)\n        mlflow.lightgbm.log_model(model.booster_, \"lgbm_booster\")\n    return metrics[objective_metric_name]\n# %%\n# %%capture capt\noptuna.logging.set_verbosity(optuna.logging.WARNING)\nif os.path.exists(OPTUNA_STUDY_PATH):\n    study = joblib.load(OPTUNA_STUDY_PATH)\n    n_trials_completed = len(study.trials)\nelse:\n    study = optuna.create_study(study_name=STUDY_NAME,\n                                direction=\"maximize\")\n    n_trials_completed = 0\nstudy.optimize(objective, n_trials=N_TRIALS - n_trials_completed)\n# %%\nwith open(STDOUT_PATH, \"w\") as f:\n    f.write(capt.stdout)\n# %%\njoblib.dump(study, OPTUNA_STUDY_PATH)\n# %%\n",
    "model_evaluation": "# %%\n## gsutil authentication\n%ppauth\n# %%                    \nfrom rmr_config.simple_config import Config\nfrom rmr_config.state_manager import StateManager\nimport os, sys, ast, json\nfrom datetime import datetime\n\nif \"working_path\" not in globals():\n    from pathlib import Path\n    path = Path(os.getcwd())\n    working_path = path.parent.absolute()\n\nfolder = os.getcwd()\nusername = os.environ['NB_USER']\nparams_path = os.path.join(working_path, 'config')\nconfig = Config(params_path)\nlocal_base_path = config.get(\"general\",\"local_output_base_path\")\nos.makedirs(local_base_path, exist_ok=True)\n\n# set working directory\nos.chdir(working_path)\n# %%\nif not config:\n    raise ValueError('config is not correctly setup')\n                \nprint(f'username={username}, working_path={working_path}')\n                    \n# %%\nsection_name = \"model_evaluation\"\n\n# %%\n# General Parameters \nmo_name = config.get('general', 'mo_name')\ndriver_dataset = config.get('general', 'driver_dataset')\ndataproc_project_name = config.get('general', 'dataproc_project_name')\ndataproc_storage_bucket = config.get('general', 'dataproc_storage_bucket')\ngcs_base_path = config.get('general', 'gcs_base_path')\nqueue_name = config.get('general', 'queue_name')\ncheck_point = config.get('general', 'check_point')\nstate_file = config.get('general', 'state_file')\n\n# Section-Specific Parameters (from solution.ini)\ndata_path = config.get(section_name, 'data_path')\nv1_features_path = config.get(section_name, 'v1_features_path')\nv1_model_path = config.get(section_name, 'v1_model_path')\nv2_features_path = config.get(section_name, 'v2_features_path')\nv2_model_path = config.get(section_name, 'v2_model_path')\ntarget_column = config.get(section_name, 'target_column')\nv2_score_threshold = config.get(section_name, 'v2_score_threshold')\nv1_metrics = config.get(section_name, 'v1_metrics')\nv2_metrics = config.get(section_name, 'v2_metrics')\nvalid_data_filtered_path = config.get(section_name, 'valid_data_filtered_path')\n\n# Dependencies from Previous Sections=====\n# Previous section: model_training\n# Edge Attributes from DAG\nmodel_artifact_path = config.get('model_training', 'model_artifact_path')\n\n# %%\n# %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n# %config PPMagics.autolimit=0\n# %%\n# %config Completer.use_jedi = False\n# %load_ext autoreload\n# %autoreload 2\nfrom functools import partial\nimport numpy as np\nimport pandas as pd\nfrom pathlib import Path\nimport matplotlib.pyplot as plt\nfrom sklearn.metrics import precision_recall_curve, precision_score, recall_score\nimport lightgbm as lgb\nplt.style.use('ggplot')\nplt.rcParams['figure.figsize'] = (9, 6)\nplt.rcParams['font.size'] = 12\n# %matplotlib inline\n# %%\ncolours = [\"#E24A33\", \"#348ABD\", \"#988ED5\", \"#777777\", \"#FBC15E\", \"#8EBA42\", \"#FFB5B8\"]\n# %%\ndef list_to_txt(lst, folder, path):\n    \"\"\"Save a list to text file\n    \"\"\"\n    with open(folder + path, mode=\"w\") as f:\n        f.write(\"\\n\".join(lst))\ndef list_from_txt(path):\n    \"\"\"Return a list with each element containing a line\n        of the file in the given path\n    \"\"\"\n    with open(path, mode=\"r\") as f:\n        lst = [line.rstrip() for line in f.readlines()]\n    return lst\ndef write_dict_to_json(folder, output_path, dictionary):\n    \"\"\"\n    Write dictionary into JSON\n    \"\"\"\n    with open(folder + output_path, \"w\") as outfile:\n        json.dump(dictionary, outfile)\ndef read_dict_from_json(folder, input_path):\n    \"\"\"\n    Read JSON from given path as dictionary\n    \"\"\"\n    with open(folder + input_path) as json_file:\n        data = json.load(json_file)\n    return data\ndef convert_column_types(df, numerical_columns, integer_columns, categorical_columns):\n    \"\"\"Convert numerical, integer and categorical columns of provided\n    pandas.DataFrame\n        Specificaly, convert categorical columns to pandas.Categorical,\n        numerical columns to numpy.float32 and\n        integer columns to numpy.int64\n    \"\"\"\n    for col in categorical_columns:\n        df[col] = pd.Categorical(df[col])\n    for col in numerical_columns:\n        df[col] = df[col].astype(np.float32)\n    for col in integer_columns:\n        df[col] = df[col].astype(np.int64)\n    return df\n# %%\n\"\"\"\nBT Retry Global\nUseful metrics functions.\n\"\"\"\nimport numpy as np\nfrom sklearn.metrics import precision_recall_curve, auc\ndef precision_at_recall(y_true, y_score, recall_value):\n    \"\"\"Precision at the given recall value\n    \"\"\"\n    precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n    if np.sum(recalls >= recall_value) == 0:\n        return 0.\n    idx = np.argmin(recalls[recalls >= recall_value])\n    precision_value = precisions[idx]\n    return precision_value\ndef threshold_at_recall(y_true, y_score, recall_value):\n    \"\"\"Threshold at the given recall value\n    \"\"\"\n    precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n    if np.sum(recalls >= recall_value) == 0:\n        return 0.\n    idx = np.argmin(recalls[recalls >= recall_value])\n    threshold = thresholds[idx - 1]\n    return threshold\ndef savings_at_recall(y_true, y_score, recall_value):\n    \"\"\"Positive prediction rate savings at the given recall value\n    \"\"\"\n    precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n    if np.sum(recalls >= recall_value) == 0:\n        return 0.\n    idx = np.argmin(recalls[recalls >= recall_value])\n    precision_value = precisions[idx]\n    treshold_value = thresholds[idx]\n    min_ratio = y_true.mean()\n    try:\n        savings = 1 - recall_value * min_ratio / precision_value\n    except ValueError as e:\n        savings = 0.\n    return savings\ndef retry_success_rate_at_recall(y_true, y_score, recall_value):\n    \"\"\" retry success rate = # of successful retries / # retries\n        = TP / # retries \n    \"\"\"\n    precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n    if np.sum(recalls >= recall_value) == 0:\n        return 0.\n    idx = np.argmin(recalls[recalls >= recall_value])\n    treshold_value = thresholds[idx]\n    y_pred = np.where(y_score > treshold_value, 1, 0) \n    tp = np.sum((y_pred==1) & (y_true == 1))\n    return tp / len(y_pred) \n# def precision_at_recall(precisions, recalls, recall_value):\n#     \"\"\"Precision at the given recall value\n#     \"\"\"\n#     idx = np.argmin(recalls[recalls >= recall_value])\n#     precision_value = precisions[idx]\n#     return precision_value\n# def threshold_at_recall(thresholds, recalls, recall_value):\n#     \"\"\"Threshold at the given recall value\n#     \"\"\"\n#     idx = np.argmin(recalls[recalls >= recall_value])\n#     threshold = thresholds[idx - 1]\n#     return threshold\n# def savings_at_recall(precisions, recalls, recall_value, min_ratio):\n#     \"\"\"Positive prediction rate savings at the given recall value\n#     \"\"\"\n#     idx = np.argmin(recalls[recalls >= recall_value])\n#     precision_value = precisions[idx]\n#     return 1 - recall_value * min_ratio / precision_value\ndef partial_aucpr(y_true, y_score, recall_lb, recall_ub):\n    \"\"\"Partial Area Under the PR Curve between the given recall levels\n    \"\"\"\n    precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n    if np.sum(recalls >= recall_lb) == 0:\n        return 0.\n    idx_right = np.argmin(recalls[recalls >= recall_lb])\n    if np.sum(recalls >= recall_ub) == 0:\n        # get max recall possible\n        idx_left = np.argmax(recalls[recalls >= recall_lb])\n    else:\n        idx_left = np.argmin(recalls[recalls >= recall_ub])\n    try:\n        p_aucpr = auc(recalls[idx_left:idx_right], precisions[idx_left:idx_right])\n    except ValueError as e:\n        p_aucpr = 0.\n    return p_aucpr\ndef evaluate_metrics(y_true, y_score, metric_functions):\n    \"\"\"Evaluate a list of metrics (callables) on y_true and y_score\n    \"\"\"\n    return [score(y_true, y_score) for score in metric_functions]\ndef get_features_and_target(df, features, target_col):\n    \"\"\"Return feature matrix and 1-D label vector\n    \"\"\"\n    return df[features], df[target_col]\n# %%\n# partial area-under-the-curve refers to the area under the precision-recall curve\n# but only for a specific interval of recall values\npartial_aucpr_geq90 = partial(partial_aucpr, recall_lb=0.9, recall_ub=1.)\nprecision_at_95 = partial(precision_at_recall, recall_value=0.95)\nprecision_at_99 = partial(precision_at_recall, recall_value=0.99)\nprecision_at_995 = partial(precision_at_recall, recall_value=0.99)\n# savings refers to the percentage of records that are not predicted as positive:\n#      savings = 1 - (TP + FP) / (TP + FP + TN + FN)\n# or, alternatively:\n#      savings = 1 - minority_ratio * recall / precision\nsavings_at_95 = partial(savings_at_recall, recall_value=0.95)\nsavings_at_99 = partial(savings_at_recall, recall_value=0.99)\nsavings_at_995 = partial(savings_at_recall, recall_value=0.995)\nMETRIC_FUNCTIONS = [precision_at_95, precision_at_99, precision_at_995, savings_at_95, savings_at_99, savings_at_995, partial_aucpr_geq90]\nMETRIC_NAMES = [\"precision_at_95\", \"precision_at_99\", \"precision_at_995\", \"savings_at_95\", \"savings_at_99\", \"savings_at_995\", \"partial_aucpr_geq90\"]\n# %%\n# %%\n# V2_CONTROL_MODEL_PATH = Path(\"/projects/dnaomi/bt-retry-global-refresh/models/bt_retry_v2_subset_strat_control.txt\")\n# %%\ndata = pd.read_parquet(DATA_PATH)\n# %%\ndata['retry_strategy_type'].unique()\n# %%\n# load features and types\nnumerical_columns = [\"setec_txn_amt_usd\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\", \n                    # \"bt24_model_score1\" \n                    ]\ninteger_columns = []\nencoded_columns = []  # no encoded columns in this example\ncategorical_columns = [\"merchant_fk\",\n                       \"setec_currency_code\",\n                       \"primary_response_type\",\n                       \"processor_settings_type\",\n                       \"retry_strategy_type\",\n                       \"card_type\",\n                       \"fi_usage\", \n                       \"issuer\", \n                       \"bin\",  \n                       \"issuer_cntry_code\", \n                      # \"pan_guid\",\n                       \"is_recurring_txn\", \n                       \"payment_instrument_type\", \n                       \"is_cvv_present\", \n                       \"enrollment_status\", \n                       \"token_status\", \n                       \"vaulted_credential_type\", \n                       \"mcc_code\", \n                       \"liability_shift_possible\", \n                       \"success_3ds\", \n                       \"verifications_txn\", \n                       \"fastlane_txn\" \n                      ]\ntarget_col = \"retry_is_success\"\n# %%\ndata['issuer_cntry_code'] = data['issuer_country']\n# %%\ndata = convert_column_types(data,\n                            numerical_columns=numerical_columns,\n                            integer_columns=integer_columns + [target_col],\n                            categorical_columns=categorical_columns)\n# %%\ndata['primary_processor_settings_type'] = data['processor_settings_type']\n# %%\nV1_FEATURES = list_from_txt(V1_FEATURES_PATH)\nv1_model = lgb.Booster(model_file=V1_MODEL_PATH)\n# %%\nV2_FEATURES = list_from_txt(V2_FEATURES_PATH)\nv2_model = lgb.Booster(model_file=V2_MODEL_PATH)\n#v2_ctrl_model = lgb.Booster(model_file=V2_CONTROL_MODEL_PATH)\n# %%\nX_1, y_1 = data[V1_FEATURES], data[target_col]\nv1_scores = v1_model.predict(X_1)\n# %%\ndata[\"v1_score\"] = v1_scores\n# %%\nX_2, y_2 = data[V2_FEATURES], data[target_col]\nv2_scores = v2_model.predict(X_2)\n# %%\nretry_success_rate_at_recall(y_1, v1_scores, 0.95) * 100 \n# %%\nretry_success_rate_at_recall(y_2, v2_scores, 0.98) * 100 \n# %%\nsavings_at_recall(y_2, v2_scores, 0.98) * 100 \n# %%\nprecision = precision_score(y_2, v2_scores > v2_score_threshold)\nrecall = recall_score(y_2, v2_scores > v2_score_threshold)\n# %%\n( 6.111412524741035 - 5.924284896163004) / 5.924284896163004 \n# %%\ndata[\"v2_score\"] = v2_scores\n# %%\n# v2_ctrl_scores = v2_ctrl_model.predict(X_2)\n# v2_ctrl_metrics = evaluate_metrics(y_2, v2_ctrl_scores, METRIC_FUNCTIONS)\n# data[\"v2_ctrl_score\"] = v2_ctrl_scores\n# %%\ndata[target_col].mean() * 100 # retry success rate\n# %%\n5.924284896163004 / 6.2359968251097655 * 100 \n# %%\nprecision, recall, _ = precision_recall_curve(data[target_col], data['v1_score'])\nauc_score = auc(recall, precision)\nauc_score\n# %%\nprecision, recall, _ = precision_recall_curve(data[target_col], data['v2_score'])\nauc_score = auc(recall, precision)\nauc_score\n# %%\npd.DataFrame(index=METRIC_NAMES, data=v1_metrics, columns=[\"value\"])\n# %%\npd.DataFrame(index=METRIC_NAMES, data=v2_metrics, columns=[\"value\"])\n# %%\npd.DataFrame(index=METRIC_NAMES, data=v2_ctrl_metrics, columns=[\"value\"])\n# %%\n# to evaluate by segment\ndef evaluate_metrics_by_segment(data, segment_col, target_col, scores_col):\n    \"\"\"Evaluate metrics by segment\n    \"\"\"\n    by_segment = data.groupby(segment_col).apply(lambda df: evaluate_metrics(df[target_col],\n                                                                             df[scores_col],\n                                                                             METRIC_FUNCTIONS))\n    return pd.DataFrame(by_segment.to_list(),\n                        index=by_segment.index,\n                        columns=METRIC_NAMES)\n# %%\n# this might give some numeric problems due from dividing by zero\nevaluate_metrics_by_segment(data, \"primary_response_type\", target_col, \"v1_score\")\n# %%\nevaluate_metrics_by_segment(data, \"primary_response_type\", target_col, \"v2_score\")\n# %%\nevaluate_metrics_by_segment(data, \"primary_response_type\", target_col, \"v2_ctrl_score\")\n# %%\n# this might give some numeric problems due from dividing by zero\nevaluate_metrics_by_segment(data, \"retry_strategy_type\", target_col, \"v1_score\")\n# %%\n# this might give some numeric problems due from dividing by zero\nevaluate_metrics_by_segment(data, \"retry_strategy_type\", target_col, \"v2_score\")\n# %%\n# this might give some numeric problems due from dividing by zero\nevaluate_metrics_by_segment(data, \"retry_strategy_type\", target_col, \"v2_ctrl_score\")\n# %%\n# %%\nfig, ax = plt.subplots(1, 1, figsize=(9, 6))\nprecisions, recalls, _ = precision_recall_curve(data[target_col], v1_scores)\nax.plot(recalls, precisions, label='V1')\nprecisions, recalls, _ = precision_recall_curve(data[target_col], v2_scores)\nax.plot(recalls, precisions, label='V2')\n# precisions, recalls, _ = precision_recall_curve(data[target_col], v2_ctrl_scores)\n# ax.plot(recalls, precisions, label='V2 Control')\nax.set_xlabel(\"Recall\")\nax.set_ylabel(\"Precision\")\nplt.title(\"Precision Recall Curves of V1 vs. V2\")\nplt.legend()\n# %%\ndata['primary_response_type'].unique()\n# %%\ndata['retry_strategy_type'].unique()\n# %%\n#retry_strategies = ['ACQUIRER_RETRY', 'ACQUIRER_MIGRATION_RETRY', 'PROCESSOR_RETRY', 'ALT_MERCHANT_ACCOUNT', 'PINLESS_DEBIT_AS_CREDIT', 'NO_AVS', 'PAN', 'NETWORK_TOKENIZATION', 'ABU']\nretry_strategies = ['NO_AVS', 'PAN', 'NETWORK_TOKENIZATION', 'ABU']\nprimary_response_types = ['NSF', 'SOFT OTHER', 'NO HONOR', 'HARD OTHER', 'INVALID CC']\n# %%\n# %%\nfig, ax = plt.subplots(1, 1, figsize=(9, 6))\nfor cat in retry_strategies:\n    temp = data[ data['retry_strategy_type']== cat ] \n    precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n    ax.plot(recalls, precisions, label=cat)\nax.set_xlabel(\"Recall\")\nax.set_ylabel(\"Precision\")\nplt.title(\"Precision Recall Curves by Retry Strategy\")\nplt.legend()\n# %%\nfig, ax = plt.subplots(1, 1, figsize=(9, 6))\nfor cat in primary_response_types:\n    temp = data[ data['primary_response_type']== cat ] \n    precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n    ax.plot(recalls, precisions, label=cat)\nax.set_xlabel(\"Recall\")\nax.set_ylabel(\"Precision\")\nplt.title(\"Precision Recall Curves by Decline Type\")\nplt.legend()\n# %%\nfig, ax = plt.subplots(1, 1, figsize=(9, 6))\nfor cat in primary_response_types:\n    temp = data[ data['primary_response_type']== cat ] \n    precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_ctrl_score'])\n    ax.plot(recalls, precisions, label=cat)\nax.set_xlabel(\"Recall\")\nax.set_ylabel(\"Precision\")\nplt.title(\"Precision Recall Curves by Decline Type\")\nplt.legend()\n# %%\nfor cat in retry_strategies:\n    fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n    temp = data[ data['retry_strategy_type']== cat ] \n    precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v1_score'])\n    ax.plot(recalls, precisions, label='V1')\n    precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n    ax.plot(recalls, precisions, label='V2')\n    # precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_ctrl_score'])\n    # ax.plot(recalls, precisions, label='V2 Control')\n    ax.set_xlabel(\"Recall\")\n    ax.set_ylabel(\"Precision\")\n    plt.title(\"Precision Recall Curves of \" + cat)\n    plt.legend()\n# %%\nfor cat in primary_response_types:\n    fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n    temp = data[ data['primary_response_type']== cat ] \n    precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v1_score'])\n    ax.plot(recalls, precisions, label='V1')\n    precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n    ax.plot(recalls, precisions, label='V2')\n    # precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_ctrl_score'])\n    # ax.plot(recalls, precisions, label='V2 Control')\n    ax.set_xlabel(\"Recall\")\n    ax.set_ylabel(\"Precision\")\n    plt.title(\"Precision Recall Curves of \" + cat)\n    plt.legend()\n# %% [markdown]\n# ## Export some test obs as model validation data\n# %%\nvalid_data = data[:50000][V2_FEATURES + ['v2_score']]\n# %%\n# %%\ndict(valid_data.dtypes)\n# %%\nimport csv\n# %%\nvalid_data_filtered = valid_data.dropna(subset=['mcc_code'])\n# %%\n# %%\nvalid_data_filtered.to_csv(valid_data_filtered_path, quoting=csv.QUOTE_NONE, sep='\\x07')\n# %%\n",
    "model_packaging": "# %%\n## gsutil authentication\n%ppauth\n# %%                    \nfrom rmr_config.simple_config import Config\nfrom rmr_config.state_manager import StateManager\nimport os, sys, ast, json\nfrom datetime import datetime\n\nif \"working_path\" not in globals():\n    from pathlib import Path\n    path = Path(os.getcwd())\n    working_path = path.parent.absolute()\n\nfolder = os.getcwd()\nusername = os.environ['NB_USER']\nparams_path = os.path.join(working_path, 'config')\nconfig = Config(params_path)\nlocal_base_path = config.get(\"general\",\"local_output_base_path\")\nos.makedirs(local_base_path, exist_ok=True)\n\n# set working directory\nos.chdir(working_path)\n# %%\nif not config:\n    raise ValueError('config is not correctly setup')\n                \nprint(f'username={username}, working_path={working_path}')\n                    \n# %%\nsection_name = \"model_packaging\"\n\n# %%\n# General Parameters \nmo_name = config.get('general', 'mo_name')\ndriver_dataset = config.get('general', 'driver_dataset')\ndataproc_project_name = config.get('general', 'dataproc_project_name')\ndataproc_storage_bucket = config.get('general', 'dataproc_storage_bucket')\ngcs_base_path = config.get('general', 'gcs_base_path')\nqueue_name = config.get('general', 'queue_name')\ncheck_point = config.get('general', 'check_point')\nstate_file = config.get('general', 'state_file')\n\n# Section-Specific Parameters (from solution.ini)\nmodel_file_path = config.get(section_name, 'model_file_path')\nmodel_json_path = config.get(section_name, 'model_json_path')\nume_output_path = config.get(section_name, 'ume_output_path')\nmodel_name = config.get(section_name, 'model_name')\ntree_nodes_only = config.get(section_name, 'tree_nodes_only')\noutput_name = config.get(section_name, 'output_name')\nbinary_spec = config.get(section_name, 'binary_spec')\nume_model_path = config.get(section_name, 'ume_model_path')\nfinal_model_json_path = config.get(section_name, 'final_model_json_path')\n\n# Dependencies from Previous Sections=====\n# Previous section: model_evaluation\n# Edge Attributes from DAG\nvalid_data_filtered_path = config.get('model_evaluation', 'valid_data_filtered_path')\n\n# %% [markdown]\n# ### BT Retry\n# # Model Saving\n# %%\nimport json\nimport lightgbm\n# %%\ndef list_from_txt(path):\n    \"\"\"Return a list with each element containing a line\n        of the file in the given path\n    \"\"\"\n    with open(path, mode=\"r\") as f:\n        lst = [line.rstrip() for line in f.readlines()]\n    return lst\n# %% [markdown]\n# ## Features\n# %%\nFULL_FEATURES_PATH = \"/projects/dnaomi/bt-retry-global-v2/metadata/v2_features_final_2.txt\"\nFEATURES = list_from_txt(FULL_FEATURES_PATH)\n# %%\ncategorical_columns = [\"merchant_fk\",\n                       \"setec_currency_code\",\n                       \"primary_response_type\",\n                       \"processor_settings_type\",\n                       \"retry_strategy_type\",\n                       \"card_type\",\n                       \"fi_usage\", \n                       \"issuer\", \n                       \"bin\",  \n                       \"issuer_cntry_code\", \n                       \"is_recurring_txn\", \n                       \"payment_instrument_type\", \n                       \"is_cvv_present\", \n                       \"enrollment_status\", \n                       \"token_status\", \n                       \"vaulted_credential_type\", \n                       \"mcc_code\", \n                       \"liability_shift_possible\", \n                       \"success_3ds\", \n                       \"verifications_txn\", \n                       \"fastlane_txn\" \n                      ]\n# %% [markdown]\n# ## Models\n# %%\n# model can be loaded in different ways: from txt file, from pickle, from Mlflow...\nmodel = lightgbm.Booster(model_file=model_file_path)\n# %% [markdown]\n# ## Export\n# %%\n# name for model files\nname = \"bt_retry_v2\"\n# get JSON\nmodel_json = model.dump_model()\n# no mapping file\nmodel_json_with_pd_path = f\"/projects/dnaomi/bt-retry-global-v2/models/{name}_model_idi.json\"\nmodel_json[\"categorical_feature_name\"] = [feat for feat in categorical_columns]\nwith open(model_json_with_pd_path, \"w\") as f:\n    json.dump(model_json, f)\n# %% [markdown]\n# ## Transform to UME\n# %%\nfrom pyScoring.lightgbm import LightGBMTransformer\nlgb_transformer = LightGBMTransformer(path_to_json=model_json_path)\n# %%\nbinary_spec\n# %%\noutput_path = ume_output_path\nbinary_spec.save(output_path)\n# %%\n# %dropzone --put -src ume_model_path -tgt bt-retry-v2/bt_retry_v2_final.m\n# %%\n# %dropzone --put -src ume_model_path -tgt bt-retry-v2/bt_retry_v2.m\n# %%\n# %dropzone --put -src /projects/dnaomi/bt-retry-global-v2/models/bt_retry_v2_model_idi.m -tgt bt-retry-v2/bt_retry_v2_model_idi.m\n# %%\n# %dropzone --put -src final_model_json_path -tgt bt-retry-v2/bt_retry_v2_model_idi.json\n",
    "model_scoring": "# %%\n## gsutil authentication\n%ppauth\n# %%                    \nfrom rmr_config.simple_config import Config\nfrom rmr_config.state_manager import StateManager\nimport os, sys, ast, json\nfrom datetime import datetime\n\nif \"working_path\" not in globals():\n    from pathlib import Path\n    path = Path(os.getcwd())\n    working_path = path.parent.absolute()\n\nfolder = os.getcwd()\nusername = os.environ['NB_USER']\nparams_path = os.path.join(working_path, 'config')\nconfig = Config(params_path)\nlocal_base_path = config.get(\"general\",\"local_output_base_path\")\nos.makedirs(local_base_path, exist_ok=True)\n\n# set working directory\nos.chdir(working_path)\n# %%\nif not config:\n    raise ValueError('config is not correctly setup')\n                \nprint(f'username={username}, working_path={working_path}')\n                    \n# %%\nsection_name = \"model_scoring\"\n\n# %%\n# General Parameters \nmo_name = config.get('general', 'mo_name')\ndriver_dataset = config.get('general', 'driver_dataset')\ndataproc_project_name = config.get('general', 'dataproc_project_name')\ndataproc_storage_bucket = config.get('general', 'dataproc_storage_bucket')\ngcs_base_path = config.get('general', 'gcs_base_path')\nqueue_name = config.get('general', 'queue_name')\ncheck_point = config.get('general', 'check_point')\nstate_file = config.get('general', 'state_file')\n\n# Section-Specific Parameters (from solution.ini)\nmodel_directory_path = config.get(section_name, 'model_directory_path')\nmodel_name = config.get(section_name, 'model_name')\nvalid_sample_path = config.get(section_name, 'valid_sample_path')\nfeatures_file_path = config.get(section_name, 'features_file_path')\nmodel_file_path = config.get(section_name, 'model_file_path')\nscored_data_path = config.get(section_name, 'scored_data_path')\n\n# Dependencies from Previous Sections=====\n# Previous section: model_packaging\n# Edge Attributes from DAG\nume_model_path = config.get('model_packaging', 'ume_model_path')\nfinal_model_json_path = config.get('model_packaging', 'final_model_json_path')\n\n# %%\n# %config Completer.use_jedi = False\n# %%\nimport pyScoring\nfrom pyScoring import UMEModel\nfrom semi_auto_trans.model_builder import start_semi_trans\nfrom semi_auto_trans.validater import validate_model\nimport pandas as pd\nimport os\nimport numpy as np\n# %%\npyScoring.__version__\n# %% [markdown]\n# ## (SKIP) Export to UME via pyScoring\n# %%\n# load features and types\nnumerical_columns = [\"setec_txn_amt_usd\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n                    \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\", \n                    # \"bt24_model_score1\" \n                    ]\ninteger_columns = []\nencoded_columns = []  # no encoded columns in this example\ncategorical_columns = [\"merchant_fk\",\n                       \"setec_currency_code\",\n                       \"primary_response_type\",\n                       \"processor_settings_type\",\n                       \"retry_strategy_type\",\n                       \"card_type\",\n                       \"fi_usage\", \n                       \"issuer\", \n                       \"bin\",  \n                       \"issuer_cntry_code\", \n                       #\"pan_guid\",\n                       \"is_recurring_txn\", \n                       \"payment_instrument_type\", \n                       \"is_cvv_present\", \n                       \"enrollment_status\", \n                       \"token_status\", \n                       \"vaulted_credential_type\", \n                       \"mcc_code\", \n                       \"liability_shift_possible\", \n                       \"success_3ds\", \n                       \"verifications_txn\", \n                       \"fastlane_txn\" \n                      ]\ntarget_col = \"retry_is_success\"\n# %%\ndef convert_column_types(df, numerical_columns, integer_columns, categorical_columns):\n    \"\"\"Convert numerical, integer and categorical columns of provided\n    pandas.DataFrame\n        Specificaly, convert categorical columns to pandas.Categorical,\n        numerical columns to numpy.float32 and\n        integer columns to numpy.int64\n    \"\"\"\n    for col in categorical_columns:\n        df[col] = pd.Categorical(df[col])\n    for col in numerical_columns:\n        df[col] = df[col].astype(np.float64)\n    for col in integer_columns:\n        df[col] = df[col].astype(np.int64)\n    return df\n# %%\nMODELS_DIR = \"/home/dnaomi/bt-retry-global-refresh/models/ume/\"\nMODEL_DIR = os.path.join(MODELS_DIR)\nMODEL_UME_NAME = \"bt_retry_v2\"\n# %% [markdown]\n# ### With mapping file\n# %%\nstart_semi_trans(MODEL_DIR, MODEL_UME_NAME)\n# %% [markdown]\n# ## Validate with LightGBM predictions\n# %%\nif os.path.exists(VALID_SAMPLE_PATH):\n    valid_sample = pd.read_csv(VALID_SAMPLE_PATH,sep='\\x07', dtype=str, index_col=0, keep_default_na=False )\n# %%\n# %%\nvalid_sample = convert_column_types(valid_sample,\n                            numerical_columns=numerical_columns,\n                            integer_columns=integer_columns,\n                            categorical_columns=categorical_columns)\n# %% [markdown]\n# ### Feature List\n# %%\ndef list_from_txt(path):\n    \"\"\"Return a list with each element containing a line\n        of the file in the given path\n    \"\"\"\n    with open(path, mode=\"r\") as f:\n        lst = [line.rstrip() for line in f.readlines()]\n    return lst \n# %%\nfeatures = list_from_txt(features_file_path)\n# %% [markdown]\n# ### Predict with UME model (with mapping)\n# %%\nmodel_file = os.path.join(MODEL_DIR, \"ume/bt_retry_v2.m\")\nume_model = UMEModel(model_file)\n# %% [markdown]\n# #### DataFrame\n# %%\nume_predictions_valid = ume_model.predict(valid_sample)\n# %%\nume_predictions_valid\n# %%\nume_preds_filtered = ume_predictions_valid.dropna(subset=['mcc_code'])\n# %%\nume_preds_filtered \n# %%\nimport csv\n# %%\nume_preds_filtered[:5000].to_csv(scored_data_path, quoting=csv.QUOTE_NONE, sep='\\x07', index=False)\n# %%\n# %dropzone --put -src scored_data_path -tgt bt-retry-v2/cosmos_ai_valid_data_5000_2.csv\n# %% [markdown]\n# #### Sample by sample\n# %%\nfor i in range(10):\n    single_example_dict = valid_sample[features].iloc[i, :].to_dict()\n# %% [markdown]\n# #### Validate\n# %%\nvalid_mismatches = validate_model(model_file, VALID_SAMPLE_PATH, \"v2_score\", delta=1e-6)\n# %% [markdown]\n# ***\n# ***\n# %% [markdown]\n# ***\n# ***\n"
  }
}