{
  "summaries": {
    "rmr_agent/repos/bt-retry-v2/etl/01_etl.py": "**[Create table for retry transactions] (Lines 7-16):**\n- Drops an existing table if it exists.\n- Creates a new table by filtering transactions with specific retry-related conditions, including strategy type, date range, and random sampling.\n\n**[Count and date range of retry transactions] (Lines 18-19):**\n- Queries the count, minimum, and maximum creation dates of the retry transactions table.\n\n**[Define and categorize decline codes] (Lines 23-74):**\n- Creates temporary functions to classify transaction response codes into categories like hard decline, soft decline, success, and others.\n- Defines a function to determine the response type based on these classifications.\n\n**[Create table for primary retry transactions] (Lines 75-173):**\n- Drops an existing table if it exists.\n- Creates a new table by joining retry transactions with primary transactions and other related tables to enrich the dataset with additional fields like payment method, merchant, and processor details.\n\n**[Count and date range of primary retry transactions] (Lines 175-176):**\n- Queries the count, minimum, and maximum dates of the primary retry transactions table.\n\n**[Aggregate primary response types] (Lines 178-183):**\n- Groups and calculates the count and percentage distribution of primary response types.\n\n**[Create driverset with FX info] (Lines 187-245):**\n- Drops an existing table if it exists.\n- Creates a new table by adding foreign exchange (FX) information to calculate transaction amounts in USD.\n\n**[Join with credit card details] (Lines 247-331):**\n- Drops an existing table if it exists.\n- Joins the driverset with credit card details to add features like card type, issuing bank, and country of issuance.\n\n**[Rename features for modeling] (Lines 333-398):**\n- Drops an existing table if it exists.\n- Renames columns in the dataset to align with model variable naming conventions.\n\n**[Add bin and strategy RADD features] (Lines 402-558):**\n- Drops an existing table if it exists.\n- Joins the dataset with bin, strategy, and bin-strategy tables to add features related to retry success and decline ratios.\n\n**[Convert data types] (Lines 573-579):**\n- Drops an existing table if it exists.\n- Casts a specific column (`setec_txn_amt_usd`) to a float data type.\n\n**[Filter and analyze missing RADDs] (Lines 590-1022):**\n- Calculates the proportion of missing values for various RADD features in the dataset.\n\n**[Filter dataset for non-null RADDs] (Lines 1024-1030):**\n- Drops an existing table if it exists.\n- Filters the dataset to include only rows where a specific RADD feature is not null.\n\n**[Deduplicate dataset] (Lines 1034-1045):**\n- Drops an existing table if it exists.\n- Deduplicates the dataset by retaining the latest record for each primary transaction ID.\n\n**[Train-validation-test split] (Lines 1054-1091):**\n- Drops existing tables if they exist.\n- Splits the deduplicated dataset into training, validation, and test sets based on a random sampling factor.\n\n**[Analyze train, validation, and test splits] (Lines 1093-1171):**\n- Queries the count, date range, and distribution of key features (e.g., success, response type, strategy type) for each split.\n\n**[Copy test set to scratch space] (Lines 1179-1186):**\n- Drops an existing table if it exists.\n- Copies the test dataset to a scratch space for external access or further analysis.",
    "rmr_agent/repos/bt-retry-v2/etl/02_bq_to_dataproc.py": "**[Configure Spark environment for BigQuery integration] (Lines 7-14):**\n- Specifies the BigQuery connector JAR file for Spark.\n- Configures class paths for Spark executors and drivers to include the BigQuery connector.\n\n**[Set Spark configuration for BigQuery and GCS] (Lines 16-20):**\n- Enables BigQuery views in Spark.\n- Sets the project and dataset for materialized views.\n- Configures a temporary Google Cloud Storage (GCS) bucket for intermediate data storage.\n\n**[Define function to copy BigQuery table to another BigQuery table] (Lines 22-28):**\n- Reads a BigQuery table into a Spark DataFrame.\n- Writes the DataFrame back to another BigQuery table, overwriting the target table.\n\n**[Define function to copy BigQuery table to GCS in Parquet format] (Lines 29-34):**\n- Reads a BigQuery table into a Spark DataFrame.\n- Writes the DataFrame to a specified GCS path in Parquet format, overwriting any existing data.\n\n**[Set source and target paths for training data] (Lines 36-37):**\n- Specifies the BigQuery table name for training data.\n- Defines the target GCS path for storing the training data in Parquet format.\n\n**[Copy training data from BigQuery to GCS] (Lines 39):**\n- Invokes the function to copy the specified training data from BigQuery to GCS in Parquet format.\n\n**[Set source and target paths for validation data] (Lines 41-42):**\n- Specifies the BigQuery table name for validation data.\n- Defines the target GCS path for storing the validation data in Parquet format.\n\n**[Copy validation data from BigQuery to GCS] (Lines 44):**\n- Invokes the function to copy the specified validation data from BigQuery to GCS in Parquet format.\n\n**[Set source and target paths for test data] (Lines 46-47):**\n- Specifies the BigQuery table name for test data.\n- Defines the target GCS path for storing the test data in Parquet format.\n\n**[Copy test data from BigQuery to GCS] (Lines 49):**\n- Invokes the function to copy the specified test data from BigQuery to GCS in Parquet format.",
    "rmr_agent/repos/bt-retry-v2/model-dev/train.py": "**[Import necessary libraries and configure settings] (Lines 9-20):**\n- Imports essential libraries for data manipulation, machine learning, and model evaluation, including `pandas`, `numpy`, `lightgbm`, `optuna`, and `mlflow`.\n\n**[Set display options for pandas] (Lines 24-26):**\n- Configures pandas to display more rows, wider column content, and float formatting for better readability.\n\n**[Define helper functions for file I/O and data type conversion] (Lines 30-68):**\n- Provides utility functions to save/load lists and dictionaries to/from files, and to convert column data types in a DataFrame.\n\n**[Define custom metric functions for model evaluation] (Lines 76-150):**\n- Implements functions to calculate precision, thresholds, savings, partial AUC-PR, and other metrics at specific recall levels.\n\n**[Define partial metric functions and constants] (Lines 152-161):**\n- Creates partial functions for specific recall thresholds and defines constants for early stopping, metric names, and the objective metric.\n\n**[Load feature paths and data paths] (Lines 165-179):**\n- Specifies file paths for feature lists and training/validation datasets.\n\n**[Load features and datasets] (Lines 182-187):**\n- Reads feature lists and parquet files for training and validation datasets into pandas DataFrames.\n\n**[Define column types and target variable] (Lines 194-277):**\n- Categorizes columns into numerical, integer, categorical, and encoded types, and specifies the target column for prediction.\n\n**[Combine features and save to file] (Lines 279-281):**\n- Combines all feature columns into a single list and saves it to a text file.\n\n**[Check for missing values in features] (Line 283):**\n- Calculates the percentage of missing values for each feature in the training dataset.\n\n**[Convert data types for training and validation datasets] (Lines 291-299):**\n- Converts columns in the training and validation datasets to their specified data types.\n\n**[Extract features and target variables] (Lines 301-303):**\n- Separates feature columns and target variable into distinct variables for training and validation datasets.\n\n**[Define best model parameters] (Lines 305-319):**\n- Specifies a dictionary of hyperparameters for the LightGBM model.\n\n**[Train LightGBM model] (Lines 324-326):**\n- Initializes and trains a LightGBM classifier using the training dataset.\n\n**[Evaluate model on validation set] (Lines 328-330):**\n- Predicts probabilities on the validation dataset, calculates metrics, and evaluates model performance.\n\n**[Save trained model] (Line 332):**\n- Saves the trained LightGBM model to a file.\n\n**[Display evaluation metrics and feature importance] (Lines 334-347):**\n- Outputs evaluation metrics and plots feature importance based on gain and split criteria.\n\n**[Set up Optuna hyperparameter tuning environment] (Lines 353-366):**\n- Configures MLflow tracking, experiment name, and directories for Optuna study results.\n\n**[Define Optuna objective function] (Lines 370-397):**\n- Implements the objective function for Optuna, which trains a LightGBM model with trial-specific parameters, evaluates metrics, and logs results to MLflow.\n\n**[Run Optuna study for hyperparameter tuning] (Lines 400-408):**\n- Loads or creates an Optuna study and optimizes the objective function for a specified number of trials.\n\n**[Save Optuna study results] (Lines 410-413):**\n- Captures and saves Optuna study output and serialized study object to files.",
    "rmr_agent/repos/bt-retry-v2/model-dev/evaluate.py": "**[Import libraries and configure plotting] (Lines 8-18):**\n- Imports essential libraries for data manipulation, visualization, and machine learning.\n- Configures matplotlib for consistent plotting style and inline display.\n\n**[Define utility functions for file I/O and data type conversion] (Lines 22-60):**\n- Provides functions to save/load lists and dictionaries to/from text and JSON files.\n- Includes a function to convert DataFrame columns to specific data types (categorical, numerical, integer).\n\n**[Define custom metric functions for evaluation] (Lines 68-155):**\n- Implements functions to calculate precision, threshold, savings, and retry success rate at specific recall values.\n- Adds a function to compute partial area under the precision-recall curve (AUC-PR) for a given recall range.\n- Provides a utility to evaluate multiple metrics on given predictions and extract features/target from a DataFrame.\n\n**[Define partial metric functions and metric lists] (Lines 159-171):**\n- Creates partial functions for specific recall thresholds (e.g., 95%, 99%) for precision and savings.\n- Defines a list of metric functions and their corresponding names for evaluation.\n\n**[Load data and feature/model paths] (Lines 173-180):**\n- Specifies paths for data, features, and models (V1 and V2 versions).\n\n**[Load dataset and inspect unique values] (Lines 183-185):**\n- Reads the dataset from a Parquet file and inspects unique values in a specific column.\n\n**[Define column types and target variable] (Lines 187-260):**\n- Categorizes columns into numerical, integer, and categorical types.\n- Specifies the target column for model evaluation.\n\n**[Convert column types and preprocess data] (Lines 262-269):**\n- Converts columns to their respective data types and performs minor preprocessing.\n\n**[Load features and models] (Lines 271-275):**\n- Loads feature lists and initializes LightGBM models (V1 and V2) from saved files.\n\n**[Evaluate V1 model] (Lines 278-280):**\n- Extracts features and target for V1, generates predictions, and evaluates metrics.\n\n**[Evaluate V2 model] (Lines 284-286):**\n- Extracts features and target for V2, generates predictions, and evaluates metrics.\n\n**[Calculate specific metrics for V1 and V2] (Lines 288-314):**\n- Computes retry success rate, savings, precision, recall, and AUC-PR for V1 and V2 models.\n\n**[Display metrics as DataFrames] (Lines 317-319):**\n- Converts V1 and V2 metrics into DataFrames for easier visualization.\n\n**[Define and evaluate metrics by segment] (Lines 323-345):**\n- Implements a function to evaluate metrics by segment (e.g., by column values).\n- Evaluates metrics for specific segments (e.g., \"primary_response_type\" and \"retry_strategy_type\").\n\n**[Plot precision-recall curves for V1 and V2] (Lines 351-361):**\n- Plots precision-recall curves for V1 and V2 models on the entire dataset.\n\n**[Plot precision-recall curves by retry strategy] (Lines 372-380):**\n- Generates precision-recall curves for V2 model, segmented by retry strategy.\n\n**[Plot precision-recall curves by decline type] (Lines 382-399):**\n- Generates precision-recall curves for V2 model, segmented by primary response type.\n\n**[Plot precision-recall curves for V1 and V2 by retry strategy] (Lines 402-415):**\n- Compares precision-recall curves of V1 and V2 models for each retry strategy.\n\n**[Plot precision-recall curves for V1 and V2 by decline type] (Lines 416-428):**\n- Compares precision-recall curves of V1 and V2 models for each primary response type.\n\n**[Export validation data] (Lines 432-442):**\n- Filters and exports a subset of the dataset as validation data to a CSV file.",
    "rmr_agent/repos/bt-retry-v2/deployment/01_export_to_ume.py": "**[Function to read lines from a text file into a list] (Lines 8-14):**\n- Defines a function `list_from_txt` that reads a file from a given path and returns its contents as a list of strings, with each line stripped of trailing whitespace.\n\n**[Load feature names from a text file] (Lines 18-19):**\n- Reads feature names from a specified text file and stores them in the `FEATURES` variable.\n\n**[Define categorical columns] (Lines 21-41):**\n- Specifies a list of categorical feature names relevant to the model, such as merchant attributes, transaction details, and card-related information.\n\n**[Load LightGBM model from a file] (Line 47):**\n- Loads a pre-trained LightGBM model from a specified `.txt` file using the `lightgbm.Booster` class.\n\n**[Export model to JSON format] (Lines 52-59):**\n- Dumps the LightGBM model into JSON format, adds categorical feature names to the JSON structure, and saves the JSON file to a specified path.\n\n**[Transform model to UME format] (Lines 63-66):**\n- Uses the `LightGBMTransformer` class to convert the JSON model into a UME-compatible binary specification, specifying the model name and output score name.\n\n**[Save UME binary specification] (Lines 69-70):**\n- Saves the UME binary specification to a specified directory.",
    "rmr_agent/repos/bt-retry-v2/deployment/02_pyscoring_validation.py": "**Import necessary libraries and modules (Lines 4-10):**\n- Imports libraries and modules for model handling, data processing, and validation, including `pyScoring`, `pandas`, and `numpy`.\n\n**Define feature and column types (Lines 16-89):**\n- Specifies lists of numerical, integer, categorical, and encoded columns for data processing.\n- Defines the target column for the model.\n\n**Function to convert column types (Lines 91-104):**\n- Converts numerical columns to `float64`, integer columns to `int64`, and categorical columns to `pandas.Categorical` for a given DataFrame.\n\n**Set model directory and name (Lines 106-108):**\n- Defines the directory path and name for the UME model.\n\n**Start semi-automatic transformation (Lines 112):**\n- Initiates the semi-automatic transformation process using the specified model directory and name.\n\n**Load and preprocess validation sample (Lines 116-124):**\n- Reads a validation dataset from a CSV file if it exists.\n- Converts the dataset's columns to their specified types using the previously defined function.\n\n**Function to read features from a text file (Lines 128-134):**\n- Reads a list of features from a text file, with each line representing a feature.\n\n**Load feature list (Lines 136):**\n- Loads the feature list from a specified file path.\n\n**Load UME model (Lines 140-141):**\n- Loads the UME model from the specified file path.\n\n**Generate predictions using UME model (Lines 145):**\n- Uses the UME model to generate predictions on the validation dataset.\n\n**Filter predictions (Lines 149):**\n- Filters out rows with missing values in the `mcc_code` column from the predictions.\n\n**Export filtered predictions to CSV (Lines 155):**\n- Saves the first 5000 rows of the filtered predictions to a CSV file with specific formatting.\n\n**Iterate over individual samples (Lines 161-162):**\n- Iterates through the first 10 rows of the validation dataset, converting each row to a dictionary of feature values.\n\n**Validate model predictions (Lines 166):**\n- Validates the UME model's predictions against the validation dataset, checking for mismatches within a specified tolerance (`delta`)."
  },
  "cleaned_code": {
    "rmr_agent/repos/bt-retry-v2/etl/01_etl.py": "   1 | # %%\n   2 | # %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n   3 | # %config PPMagics.autolimit=0\n   4 | # %% [markdown]\n   5 | # # 1. Pull Base Transactions\n   6 | # %%\n   7 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions;\n   8 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions as\n   9 | (\n  10 |     select *\n  11 |     from pypl-edl.braintree_raw_tables.gateway_transactions\n  12 |     where retried_transaction_fk is not null\n  13 |     and strategy_type in ('PAN', 'NO_AVS', 'NETWORK_TOKENIZATION', 'ABU') -- the set of available strategies may change in the future \n  14 |     and created_at between '2023-08-15' and '2025-01-02'  -- date range\n  15 |     and abs(mod(farm_fingerprint(cast(retried_transaction_fk as string)), 1000)) < 15  -- random sampling factor\n  16 | );\n  17 | # %%\n  18 | select count(*), min(created_at), max(created_at)\n  19 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions\n  20 | # %% [markdown]\n  21 | # # 2. Categorize Decline Codes, Pull Primary Retry Transactions\n  22 | # %%\n  23 | create temp function IsHardDecline(code STRING)\n  24 |     returns STRING\n  25 |     as (IF(code in ('2004','2005','2006','2007','2008','2009','2010','2011','2012','2013','2014','2015',\n  26 |                     '2017','2018','2019','2020','2021','2022','2023','2024','2027','2028','2029','2030',\n  27 |                     '2031','2032','2033','2036','2037','2039','2041','2043','2044','2045','2047','2049',\n  28 |                     '2050','2051','2052','2053','2054','2055','2056','2058','2059','2060','2061','2063',\n  29 |                     '2064','2065','2066','2067','2068','2069','2070','2071','2072','2073','2074','2075',\n  30 |                     '2076','2077','2079','2081','2082','2083','2084','2085','2086','2087','2088','2089',\n  31 |                     '2090','2091','2093','2094','2095','2096','2097','2098','2100', '2107', '2108'), -- ADDED '2107', '2108'\n  32 |            'Y', 'N'));\n  33 | create temp function IsSoftDecline(code STRING)\n  34 |     returns STRING\n  35 |     as (IF((code in ('2002','2003','2016','2025', -- DELETED '2000','2001'\n  36 |                      '2026','2034','2035','2038','2040','2042',\n  37 |                      '2046','2048','2057','2062','2092','2099',\n  38 |                      '2101', '2102','2103','2104','2105','2106','3000')) -- ADDED ,'2101', '2102','2103','2104','2105','2106','3000'\n  39 |            or ((code >= '2109') and (code < '3000')), -- CHANGED > '2100' to >= '2109'\n  40 |            'Y', 'N'));\n  41 | create temp function IsDecline(code STRING)\n  42 |     returns STRING\n  43 |     as (IF((code >= '2000') and (code < '3000'), 'Y', 'N'));\n  44 | create temp function IsSuccess(code STRING)\n  45 |     returns STRING\n  46 |     as (IF(code in ('1000','1001','1002','1003'), 'Y', 'N'));\n  47 | create temp function IsNoHonor(code STRING)\n  48 |     returns STRING\n  49 |     as (IF(code = '2000', 'Y', 'N'));\n  50 | create temp function IsNSF(code STRING)\n  51 |     returns STRING\n  52 |     as (IF(code = '2001', 'Y', 'N'));\n  53 | create temp function IsInvalidCC(code STRING)\n  54 |     returns STRING\n  55 |     as (IF(code = '2005', 'Y', 'N'));\n  56 | create temp function IsNetworkUnavailable(code STRING)\n  57 |     returns STRING\n  58 |     as (IF(code = '3000', 'Y', 'N'));\n  59 | create temp function IsRetry(retried_transaction_fk INT64)\n  60 |     returns STRING\n  61 |     as (IF(retried_transaction_fk is null, 'N', 'Y'));\n  62 | create temp function ResponseType(code STRING)\n  63 |     returns STRING\n  64 |     as\n  65 |         (case\n  66 |             when code is null then 'NULL'\n  67 |             when IsSuccess(code) = 'Y' then 'SUCCESS'\n  68 |             when IsNoHonor(code) = 'Y' then 'NO HONOR'\n  69 |             when IsNSF(code) = 'Y' then 'NSF'\n  70 |             when IsInvalidCC(code) = 'Y' then 'INVALID CC'\n  71 |             when (IsSoftDecline(code) = 'Y' and IsNSF(code) = 'N' and IsNoHonor(code) = 'N') then 'SOFT OTHER'\n  72 |             when (IsHardDecline(code) = 'Y' and IsInvalidCC(code) = 'N') then 'HARD OTHER'\n  73 |             else 'OTHER'\n  74 |         end);\n  75 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions;\n  76 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions as\n  77 | (\n  78 |     select\n  79 |         date(pri.created_at) as dt,\n  80 |         -- other\n  81 |         case when pri.cvv_response_code='M' then 1 else 0 end  as is_cvv_present,\n  82 |         pri.recurring as recurring,\n  83 |         pri.vaulted_credential_type as vaulted_credential_type,\n  84 |         -- amount fields\n  85 |         pri.currency_iso_code as currency_iso_code,\n  86 |         pri.amount_requested as amount_requested,\n  87 |         pri.amount_authorized as amount_authorized,\n  88 |         pri.amount_submitted_for_settlement as amount_submitted_for_settlement,\n  89 |         pri.cdc_shard,\n  90 |         -- pmt method fields\n  91 |         pri.cdc_original_payment_method_fk as cdc_original_payment_method_fk,\n  92 |         pri.payment_instrument_detail_fk as payment_instrument_detail_fk,\n  93 |         pri.payment_method_fk as payment_method_fk,\n  94 |         pmt.token as payment_method_token, -- ADDED\n  95 |         pmt.payment_instrument_type, -- ADDED \n  96 |         -- customer fields\n  97 |         pri.cdc_original_customer_fk as cdc_original_customer_fk,\n  98 |         -- merchant fields\n  99 |         pri.cdc_original_merchant_account_fk as cdc_original_merchant_account_fk,\n 100 |         pri.merchant_account_fk as merchant_account_fk,\n 101 |         pri.merchant_fk as merchant_fk,\n 102 |         merc.company_name as company_name,\n 103 |         merc.country_name as merchant_country, -- ADDED \n 104 |         -- merchant acc fields (ADDED) \n 105 |         -- merc_acc.token as merchant_account_token, \n 106 |         -- merc_acc.kind as merchant_account_kind, \n 107 |         -- primary fields\n 108 |         ---- ids and strategy\n 109 |         pri.pk as primary_txn_id,\n 110 |         pri.public_id as primary_public_id,\n 111 |         pri.strategy_type as primary_strategy_type,\n 112 |         ---- NT fields\n 113 |         pri.created_using_token as primary_created_using_token,\n 114 |         nte.enrollment_id,  -- ADDED \n 115 |         nte.enrollment_status, -- ADDED \n 116 |         nte.token_status, -- ADDED \n 117 |         ---- processor fields\n 118 |         pri.cdc_original_processor_settings_fk as cdc_original_processor_settings_fk,\n 119 |         pri.processor_response_code as primary_processor_response_code,\n 120 |         pri.processor_settings_fk as primary_processor_settings_fk,\n 121 |         pri.processor_settings_type as primary_processor_settings_type,\n 122 |         -- status fields\n 123 |         ResponseType(pri.processor_response_code) as primary_response_type,\n 124 |         -- retry fields\n 125 |         ---- ids and strategy\n 126 |         ---- NEW STUFF -----------------------\n 127 |         rank() over (partition by retry.retried_transaction_fk order by retry.created_at asc) as retry_order,\n 128 |         --------------------------------------\n 129 |         retry.pk as retry_txn_id,\n 130 |         retry.public_id as retry_public_id,\n 131 |         retry.strategy_type as retry_strategy_type,\n 132 |         ---- NT fields\n 133 |         retry.created_using_token as retry_created_using_token,\n 134 |         ---- processor fields\n 135 |         retry.cdc_original_processor_settings_fk as retry_cdc_original_processor_settings_fk,\n 136 |         retry.processor_response_code as retry_processor_response_code,\n 137 |         retry.processor_settings_fk as retry_processor_settings_fk,\n 138 |         retry.processor_settings_type as retry_processor_settings_type,\n 139 |         -- status fields\n 140 |         ResponseType(retry.processor_response_code) as retry_response_type,\n 141 |         -- add binary & string label directly\n 142 |         if(ResponseType(retry.processor_response_code) = 'SUCCESS', 'Y', 'N') as retry_is_success_y_n,\n 143 |         if(ResponseType(retry.processor_response_code) = 'SUCCESS', 1, 0) as retry_is_success\n 144 |     from\n 145 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_retry_transactions retry\n 146 |     -- trying inner join directly with gateway txns\n 147 |     inner join\n 148 |         -- date range\n 149 |         (select * from pypl-edl.braintree_raw_tables.gateway_transactions where created_at between '2023-01-01' and '2025-01-02') pri\n 150 |     on\n 151 |         retry.retried_transaction_fk = pri.pk\n 152 |     -- trying join directly with authy merchants\n 153 |     left join\n 154 |         pypl-edl.braintree_raw_tables.authy_merchants merc\n 155 |     on\n 156 |         retry.merchant_fk = merc.pk\n 157 |     -- to get payment method fields\n 158 |     left join \n 159 |         pypl-edl.braintree_raw_tables.gateway_payment_methods pmt\n 160 |     on \n 161 |         retry.payment_method_fk = pmt.pk\n 162 |     and \n 163 |         pmt.payment_instrument_type='CreditCard'\n 164 |     -- to get NT enrollment fields\n 165 |     left join \n 166 |         pypl-edl.braintree_raw_tables.gateway_credit_cards cd\n 167 |     on \n 168 |         pmt.payment_instrument_fk = cd.pk -- CHECK THIS LOGIC\n 169 |     left join \n 170 |         pypl-edl.braintree_raw_tables.gateway_network_tokenization_enrollments nte\n 171 |     on \n 172 |         nte.pk = cd.enrollment_fk\n 173 | );\n 174 | # %%\n 175 | select count(*), min(dt), max(dt)\n 176 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions\n 177 | # %%\n 178 | select \n 179 |     primary_response_type,\n 180 |     count(*) as n,\n 181 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n 182 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions\n 183 | group by 1\n 184 | # %% [markdown]\n 185 | # # 3. Get CC RADD Features\n 186 | # %%\n 187 | /* 1. Add FX info for amount in USD */\n 188 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset;\n 189 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset as\n 190 | (\n 191 |     select\n 192 |         retry.dt as dt,\n 193 |         retry.is_cvv_present as is_cvv_present,\n 194 |         retry.recurring as recurring,\n 195 |         retry.vaulted_credential_type as vaulted_credential_type,\n 196 |         retry.currency_iso_code as setec_currency_code,\n 197 |         retry.amount_requested as amount_requested,\n 198 |         retry.amount_authorized as amount_authorized,\n 199 |         retry.amount_submitted_for_settlement as amount_submitted_for_settlement,\n 200 |         round(retry.amount_authorized * fx.site_exchng_rate / 100, 2) as setec_txn_amt_usd,\n 201 |         retry.cdc_shard as cdc_shard,\n 202 |         retry.cdc_original_payment_method_fk as cdc_original_payment_method_fk,\n 203 |         retry.payment_instrument_detail_fk as payment_instrument_detail_fk,\n 204 |         retry.payment_method_fk as payment_method_fk,\n 205 |         retry.cdc_original_customer_fk as cdc_original_customer_fk,\n 206 |         retry.cdc_original_merchant_account_fk as cdc_original_merchant_account_fk,\n 207 |         retry.merchant_account_fk as merchant_account_fk,\n 208 |         retry.merchant_fk as merchant_fk,\n 209 |         retry.merchant_country as merchant_country,\n 210 |         retry.company_name as company_name,\n 211 |         retry.primary_txn_id as primary_txn_id,\n 212 |         retry.primary_public_id as primary_public_id,\n 213 |         retry.primary_strategy_type as primary_strategy_type,\n 214 |         retry.primary_created_using_token as primary_created_using_token,\n 215 |         retry.payment_method_token, \n 216 |         retry.payment_instrument_type, \n 217 |         retry.token_status, \n 218 |         retry.enrollment_status, \n 219 |         retry.enrollment_id,\n 220 |         retry.cdc_original_processor_settings_fk as primary_cdc_original_processor_settings_fk,\n 221 |         retry.primary_processor_response_code as primary_processor_response_code,\n 222 |         retry.primary_processor_settings_fk as primary_processor_settings_fk,\n 223 |         retry.primary_processor_settings_type as primary_processor_settings_type,\n 224 |         retry.primary_response_type as primary_response_type,\n 225 |         retry.retry_order as retry_order,\n 226 |         retry.retry_txn_id as retry_txn_id,\n 227 |         retry.retry_public_id as retry_public_id,\n 228 |         retry.retry_strategy_type as retry_strategy_type,\n 229 |         retry.retry_created_using_token as retry_created_using_token,\n 230 |         retry.retry_cdc_original_processor_settings_fk as retry_cdc_original_processor_settings_fk,\n 231 |         retry.retry_processor_response_code as retry_processor_response_code,\n 232 |         retry.retry_processor_settings_fk as retry_processor_settings_fk,\n 233 |         retry.retry_processor_settings_type as retry_processor_settings_type,\n 234 |         retry.retry_response_type as retry_response_type,\n 235 |         retry.retry_is_success_y_n as retry_is_success_y_n,\n 236 |         retry.retry_is_success as retry_is_success\n 237 |     from\n 238 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_primary_retry_transactions retry\n 239 |     left join\n 240 |         (select exchng_rate_dt, from_curr_code, site_exchng_rate from pypl-edw.pp_access_views.dim_curr_exchng_rate_dly where to_curr_code = 'USD') fx\n 241 |     on\n 242 |         retry.dt - 1 = fx.exchng_rate_dt\n 243 |     and\n 244 |         retry.currency_iso_code = fx.from_curr_code\n 245 | );\n 246 | # %%\n 247 | /* 2. Join with CC details table for CC features */\n 248 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc;\n 249 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc as\n 250 | (\n 251 |     select\n 252 |         retry.dt,\n 253 |         retry.is_cvv_present, -- RENAMED\n 254 |         retry.recurring,\n 255 |         retry.vaulted_credential_type,\n 256 |         retry.setec_currency_code,\n 257 |         retry.amount_requested,\n 258 |         retry.amount_authorized,\n 259 |         retry.amount_submitted_for_settlement,\n 260 |         retry.setec_txn_amt_usd,\n 261 |         retry.cdc_shard,\n 262 |         retry.cdc_original_payment_method_fk,\n 263 |         retry.payment_instrument_detail_fk,\n 264 |         retry.payment_method_fk,\n 265 |         retry.cdc_original_customer_fk,\n 266 |         retry.cdc_original_merchant_account_fk,\n 267 |         retry.merchant_account_fk,\n 268 |         retry.merchant_fk,\n 269 |         retry.merchant_country, \n 270 |         retry.company_name,\n 271 |         retry.primary_txn_id,\n 272 |         retry.primary_public_id,\n 273 |         retry.primary_strategy_type,\n 274 |         retry.primary_created_using_token,\n 275 |         retry.payment_method_token, \n 276 |         retry.payment_instrument_type, \n 277 |         retry.token_status, \n 278 |         retry.enrollment_status, \n 279 |         retry.enrollment_id,\n 280 |         retry.primary_cdc_original_processor_settings_fk,\n 281 |         retry.primary_processor_response_code,\n 282 |         retry.primary_processor_settings_fk,\n 283 |         retry.primary_processor_settings_type,\n 284 |         retry.primary_response_type,\n 285 |         retry.retry_order,\n 286 |         retry.retry_txn_id,\n 287 |         retry.retry_public_id,\n 288 |         retry.retry_strategy_type,\n 289 |         retry.retry_created_using_token,\n 290 |         retry.retry_cdc_original_processor_settings_fk,\n 291 |         retry.retry_processor_response_code,\n 292 |         retry.retry_processor_settings_fk,\n 293 |         retry.retry_processor_settings_type,\n 294 |         retry.retry_response_type,\n 295 |         -- CC context attributes\n 296 |         cc.pk as cc_pk,\n 297 |         cc.type as cc_type,\n 298 |         cc.issuing_bank as cc_issuing_bank,\n 299 |         cc.bin as cc_bin,\n 300 |         cc.postal_code as cc_postal_code,\n 301 |         cc.country_name as cc_country_name,\n 302 |         cc.country_of_issuance as cc_country_of_issuance,\n 303 |         cc.expiration_date as cc_exp_date,        \n 304 |         cc.debit as cc_debit,\n 305 |         cc.prepaid as cc_prepaid,\n 306 |         cc.pan_guid as cc_pan_guid,\n 307 |         cc.created_at as cc_created_at,\n 308 |         -- binary target\n 309 |         retry.retry_is_success_y_n,\n 310 |         retry.retry_is_success\n 311 |     from\n 312 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset retry\n 313 |     left join\n 314 |         (select\n 315 |              pk,\n 316 |              type,\n 317 |              issuing_bank,\n 318 |              bin,\n 319 |              postal_code,\n 320 |              country_name,\n 321 |              country_of_issuance,\n 322 |              expiration_date,\n 323 |              debit,\n 324 |              prepaid,\n 325 |              pan_guid,\n 326 |              created_at\n 327 |          from\n 328 |              pypl-edl.braintree_raw_tables.gateway_credit_card_details where pk is not null) cc\n 329 |     on\n 330 |         retry.payment_instrument_detail_fk = cc.pk\n 331 | );\n 332 | # %%\n 333 | /* 3. Rename features to match model variable names */\n 334 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed;\n 335 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed as\n 336 | (\n 337 |     select\n 338 |         dt,\n 339 |         is_cvv_present, -- RENAMED\n 340 |         recurring as is_recurring_txn, -- RENAMED\n 341 |         vaulted_credential_type,\n 342 |         setec_currency_code,\n 343 |         amount_requested,\n 344 |         amount_authorized,\n 345 |         amount_submitted_for_settlement,\n 346 |         setec_txn_amt_usd,\n 347 |         cdc_shard as shard, -- RENAMED\n 348 |         cdc_original_payment_method_fk as original_payment_method_fk, -- RENAMED\n 349 |         payment_instrument_detail_fk,\n 350 |         payment_method_fk,\n 351 |         cdc_original_customer_fk,\n 352 |         cdc_original_merchant_account_fk as original_merchant_account_fk, -- RENAMED\n 353 |         merchant_account_fk,\n 354 |         merchant_fk,\n 355 |         company_name,\n 356 |         merchant_country, -- ADDED\n 357 |         primary_txn_id,\n 358 |         primary_public_id,\n 359 |         primary_strategy_type,\n 360 |         primary_created_using_token,\n 361 |         payment_method_token, \n 362 |         payment_instrument_type, \n 363 |         token_status, \n 364 |         enrollment_status, \n 365 |         enrollment_id,\n 366 |         primary_cdc_original_processor_settings_fk as original_processor_settings_fk, -- RENAMED\n 367 |         primary_processor_response_code,\n 368 |         primary_processor_settings_fk as processor_settings_fk, -- RENAMED\n 369 |         primary_processor_settings_type as processor_settings_type, -- RENAMED\n 370 |         primary_response_type,\n 371 |         retry_order,\n 372 |         retry_txn_id,\n 373 |         retry_public_id,\n 374 |         retry_strategy_type,\n 375 |         retry_created_using_token,\n 376 |         retry_cdc_original_processor_settings_fk,\n 377 |         retry_processor_response_code,\n 378 |         retry_processor_settings_fk,\n 379 |         retry_processor_settings_type,\n 380 |         retry_response_type,\n 381 |         cc_pk,\n 382 |         cc_type as card_type, -- RENAMED\n 383 |         cc_issuing_bank as issuer, -- RENAMED\n 384 |         cc_bin as bin, -- RENAMED\n 385 |         cc_postal_code,\n 386 |         cc_country_name,\n 387 |         cc_country_of_issuance as issuer_cntry_code, -- RENAMED\n 388 |         cc_exp_date,        \n 389 |         cc_debit,\n 390 |         if(cc_debit is True, 'debit', 'credit') as fi_usage,\n 391 |         cc_prepaid,\n 392 |         cc_pan_guid as pan_guid, -- RENAMED\n 393 |         cc_created_at,\n 394 |         retry_is_success_y_n,\n 395 |         retry_is_success\n 396 |     from\n 397 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc\n 398 | );\n 399 | # %% [markdown]\n 400 | # # 4. Get Bin, Strategy RADD Features\n 401 | # %%\n 402 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset;\n 403 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset as\n 404 | (\n 405 |     select\n 406 |         retry.dt,\n 407 |         retry.is_cvv_present,\n 408 |         retry.is_recurring_txn,\n 409 |         retry.vaulted_credential_type,\n 410 |         retry.setec_currency_code,\n 411 |         retry.amount_requested,\n 412 |         retry.amount_authorized,\n 413 |         retry.amount_submitted_for_settlement,\n 414 |         retry.setec_txn_amt_usd,\n 415 |         retry.shard, -- RENAMED\n 416 |         retry.original_payment_method_fk, -- RENAMED\n 417 |         retry.payment_instrument_detail_fk,\n 418 |         retry.payment_method_fk,\n 419 |         retry.cdc_original_customer_fk,\n 420 |         retry.original_merchant_account_fk, -- RENAMED\n 421 |         retry.merchant_account_fk,\n 422 |         retry.merchant_fk,\n 423 |         retry.merchant_country, -- ADDED\n 424 |         retry.company_name,\n 425 |         retry.primary_txn_id,\n 426 |         retry.primary_public_id,\n 427 |         retry.primary_strategy_type,\n 428 |         retry.primary_created_using_token,\n 429 |         retry.payment_method_token, \n 430 |         retry.payment_instrument_type, \n 431 |         retry.token_status, \n 432 |         retry.enrollment_status, \n 433 |         retry.enrollment_id,\n 434 |         retry.original_processor_settings_fk, -- RENAMED\n 435 |         retry.primary_processor_response_code,\n 436 |         retry.processor_settings_fk, -- RENAMED\n 437 |         retry.processor_settings_type, -- RENAMED\n 438 |         retry.primary_response_type,\n 439 |         retry.retry_order,\n 440 |         retry.retry_txn_id,\n 441 |         retry.retry_public_id,\n 442 |         retry.retry_strategy_type,\n 443 |         retry.retry_created_using_token,\n 444 |         retry.retry_cdc_original_processor_settings_fk,\n 445 |         retry.retry_processor_response_code,\n 446 |         retry.retry_processor_settings_fk,\n 447 |         retry.retry_processor_settings_type,\n 448 |         retry.retry_response_type,\n 449 |         retry.cc_pk,\n 450 |         retry.card_type,\n 451 |         retry.issuer, -- RENAMED\n 452 |         retry.bin, -- RENAMED\n 453 |         retry.cc_postal_code,\n 454 |         retry.cc_country_name,\n 455 |         retry.issuer_cntry_code,-- RENAMED\n 456 |         retry.cc_exp_date,        \n 457 |         retry.cc_debit,\n 458 |         retry.fi_usage,\n 459 |         retry.cc_prepaid,\n 460 |         retry.pan_guid, -- RENAMED\n 461 |         retry.cc_created_at,\n 462 |         retry.retry_is_success_y_n,\n 463 |         retry.retry_is_success,\n 464 |         -- bin\n 465 |         bin.amt_pri_decline_ratio_6m as idi_bt_unbranded_retry_bin_rdd_amt_pri_decline_ratio_6m,\n 466 |         bin.amt_pri_success_ratio_21d as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_21d,\n 467 |         bin.amt_pri_success_ratio_3m as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_3m,\n 468 |         bin.amt_pri_success_ratio_7d as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_7d,\n 469 |         bin.amt_pri_success_ratio_nt_7d as idi_bt_unbranded_retry_bin_rdd_amt_pri_success_ratio_nt_7d,\n 470 |         bin.cnt_pri_decline_ratio_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_decline_ratio_7d,\n 471 |         bin.cnt_pri_decline_ratio_nt_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_decline_ratio_nt_7d,\n 472 |         bin.cnt_pri_success_ratio_14d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d,\n 473 |         bin.cnt_pri_success_ratio_1m as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_1m,\n 474 |         bin.cnt_pri_success_ratio_6m as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_6m,\n 475 |         bin.cnt_pri_success_ratio_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d,\n 476 |         bin.cnt_pri_success_ratio_nt_14d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d,\n 477 |         bin.cnt_pri_success_ratio_nt_3m as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_3m,\n 478 |         bin.cnt_pri_success_ratio_nt_7d as idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d,\n 479 |         -- strategy\n 480 |         str.amt_retry_decline_ratio_post_nsf_7d as idi_bt_unbranded_retry_strategy_rdd_amt_retry_decline_ratio_post_nsf_7d,\n 481 |         str.amt_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_strategy_rdd_amt_retry_success_ratio_post_dnh_7d,\n 482 |         str.amt_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_amt_retry_success_ratio_post_hard_14d,\n 483 |         str.cnt_first_retry_success_ratio_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d,\n 484 |         str.cnt_first_retry_success_ratio_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d,\n 485 |         str.cnt_first_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d,\n 486 |         str.cnt_first_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d,\n 487 |         str.cnt_first_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d,\n 488 |         str.cnt_first_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d,\n 489 |         str.cnt_first_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d,\n 490 |         str.cnt_first_retry_success_ratio_post_nsf_1m as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_1m,\n 491 |         str.cnt_first_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d,\n 492 |         str.cnt_first_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d,\n 493 |         str.cnt_first_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d,\n 494 |         str.cnt_retry_decline_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_decline_ratio_post_hard_14d,\n 495 |         str.cnt_retry_success_ratio_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d,\n 496 |         str.cnt_retry_success_ratio_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d,\n 497 |         str.cnt_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d,\n 498 |         str.cnt_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d,\n 499 |         str.cnt_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d,\n 500 |         str.cnt_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d,\n 501 |         str.cnt_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d,\n 502 |         str.cnt_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d,\n 503 |         str.cnt_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d,\n 504 |         str.cnt_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d,\n 505 |         -- bin strategy\n 506 |         bin_str.amt_first_retry_decline_ratio_7d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_first_retry_decline_ratio_7d,\n 507 |         bin_str.amt_first_retry_decline_ratio_post_nsf_7d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_first_retry_decline_ratio_post_nsf_7d,\n 508 |         bin_str.amt_first_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_first_retry_success_ratio_post_hard_7d,\n 509 |         bin_str.amt_retry_decline_ratio_post_nsf_1m as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_decline_ratio_post_nsf_1m,\n 510 |         bin_str.amt_retry_decline_ratio_post_soft_1m as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_decline_ratio_post_soft_1m,\n 511 |         bin_str.amt_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_success_ratio_post_dnh_14d,\n 512 |         bin_str.amt_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_bin_strategy_rdd_amt_retry_success_ratio_post_nsf_14d,\n 513 |         bin_str.cnt_first_retry_success_ratio_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d,\n 514 |         bin_str.cnt_first_retry_success_ratio_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d,\n 515 |         bin_str.cnt_first_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d,\n 516 |         bin_str.cnt_first_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d,\n 517 |         bin_str.cnt_first_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d,\n 518 |         bin_str.cnt_first_retry_success_ratio_post_hard_1m as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_1m,\n 519 |         bin_str.cnt_first_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d,\n 520 |         bin_str.cnt_first_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d,\n 521 |         bin_str.cnt_first_retry_success_ratio_post_nsf_1m as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_1m,\n 522 |         bin_str.cnt_first_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d,\n 523 |         bin_str.cnt_first_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d,\n 524 |         bin_str.cnt_first_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d,\n 525 |         bin_str.cnt_retry_decline_ratio_post_dnh_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_decline_ratio_post_dnh_7d,\n 526 |         bin_str.cnt_retry_success_ratio_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d,\n 527 |         bin_str.cnt_retry_success_ratio_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d,\n 528 |         bin_str.cnt_retry_success_ratio_post_dnh_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d,\n 529 |         bin_str.cnt_retry_success_ratio_post_dnh_1m as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_1m,\n 530 |         bin_str.cnt_retry_success_ratio_post_dnh_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d,\n 531 |         bin_str.cnt_retry_success_ratio_post_hard_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d,\n 532 |         bin_str.cnt_retry_success_ratio_post_hard_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d,\n 533 |         bin_str.cnt_retry_success_ratio_post_nsf_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d,\n 534 |         bin_str.cnt_retry_success_ratio_post_nsf_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d,\n 535 |         bin_str.cnt_retry_success_ratio_post_soft_14d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d,\n 536 |         bin_str.cnt_retry_success_ratio_post_soft_7d as idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\n 537 |     from\n 538 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed retry\n 539 |     left join\n 540 |         pypl-edw.pp_cmt_access_views.bt_unbranded_retry_bin bin\n 541 |     on\n 542 |         retry.bin = bin.bin\n 543 |     and\n 544 |         retry.dt = date(bin.dt)\n 545 |     left join\n 546 |         pypl-edw.pp_cmt_access_views.bt_unbranded_retry_strategy str\n 547 |     on\n 548 |         retry.retry_strategy_type = str.retry_strategy_type\n 549 |     and\n 550 |         retry.dt = date(str.dt)\n 551 |     left join\n 552 |         pypl-edw.pp_cmt_access_views.bt_unbranded_retry_bin_strategy bin_str\n 553 |     on\n 554 |         retry.bin = bin_str.bin\n 555 |     and\n 556 |         retry.retry_strategy_type = bin_str.retry_strategy_type\n 557 |     and\n 558 |         retry.dt = date(bin_str.dt)\n 559 | );\n 560 | # %% [markdown]\n 561 | # ## Convert BIGNUMERIC to Numeric\n 562 | # %%\n 563 | select column_name, data_type\n 564 | from pypl-edw.pp_cmt_access_views.INFORMATION_SCHEMA.COLUMNS\n 565 | where table_name = 'bt_unbranded_retry_bin'\n 566 | order by data_type\n 567 | # %%\n 568 | select column_name, data_type\n 569 | from pypl-bods.gds_pacman_prod.INFORMATION_SCHEMA.COLUMNS\n 570 | where table_name = 'bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast'\n 571 | order by data_type\n 572 | # %%\n 573 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast;\n 574 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast as\n 575 | (\n 576 |     select \n 577 |     * except (setec_txn_amt_usd),\n 578 |     cast(setec_txn_amt_usd as float64) as setec_txn_amt_usd, \n 579 |     from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset\n 580 | ) \n 581 | # %%\n 582 | select retry_strategy_type, count (*) \n 583 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\n 584 | where idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null \n 585 | group by 1\n 586 | # %%\n 587 | select count(*), sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null then 1 else 0 end) \n 588 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\n 589 | # %%\n 590 | with sub as ( select *\n 591 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\n 592 | where idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null \n 593 |  ) \n 594 | select \n 595 | sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d is null then 1 else 0 end) / count(*), \n 596 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d is null then 1 else 0 end) / count(*), \n 597 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d is null then 1 else 0 end) / count(*), \n 598 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d is null then 1 else 0 end) / count(*), \n 599 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 600 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 601 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 602 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 603 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 604 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 605 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 606 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 607 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 608 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 609 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 610 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 611 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 612 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 613 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 614 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 615 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 616 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 617 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 618 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 619 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 620 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 621 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 622 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 623 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 624 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 625 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 626 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 627 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 628 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 629 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 630 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 631 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 632 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 633 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 634 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 635 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 636 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 637 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 638 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 639 |   from sub\n 640 | # %%\n 641 | select dt, sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end), count(*)\n 642 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast\n 643 | group by 1\n 644 | order by 2 desc\n 645 | # %% [markdown]\n 646 | # # 5. Additional features in V1\n 647 | # %% [markdown]\n 648 | # ## Get 3DS Features from BT 3DS Verifications Table\n 649 | # %%\n 650 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds;\n 651 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds as\n 652 | (\n 653 |     select \n 654 |         driver.*, \n 655 |         -- 3ds related features\n 656 |         tdsv.liability_shifted, \n 657 |         tdsv.liability_shift_possible,\n 658 |         case when tdsv.report_status = 'exemption_low_value_successful' then 1 \n 659 |              when tdsv.report_status = 'data_only_successful' then 1  \n 660 |              when tdsv.report_status = 'exemption_tra_successful' then 1 \n 661 |              when tdsv.report_status = 'authenticate_successful' then 1 \n 662 |              else 0 end as success_3ds\n 663 |     from \n 664 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast driver\n 665 |     left join \n 666 |         pypl-edl.braintree_raw_tables.gateway_three_d_secure_results tdsr\n 667 |     on \n 668 |         tdsr.requester_fk = driver.primary_txn_id \n 669 |     and \n 670 |         tdsr.requester_type = 'Transaction'\n 671 |     left join \n 672 |         pypl-edl.braintree_raw_tables.gateway_three_d_secure_verifications tdsv\n 673 |     on \n 674 |         tdsr.three_d_secure_verification_public_id = tdsv.public_id\n 675 | ) \n 676 | # %%\n 677 | select \n 678 |     success_3ds, \n 679 |     count(*) as n,\n 680 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n 681 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds \n 682 | group by 1 \n 683 | # %% [markdown]\n 684 | # ## Get Verification Feature from linking verification with payment method, then to transaction\n 685 | # %%\n 686 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver;\n 687 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver as\n 688 | (\n 689 |     select \n 690 |         base.*, \n 691 |         case when ver.pk is not null then 1 else 0 end as verifications_txn \n 692 |         --ver.pk as verification_pmt_method\n 693 |     from \n 694 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds base\n 695 |     left join \n 696 |         pypl-edl.braintree_raw_tables.gateway_verifications ver\n 697 |     on \n 698 |         base.payment_method_fk = ver.payment_method_fk\n 699 |     and \n 700 |         base.merchant_fk = ver.merchant_fk \n 701 |     and \n 702 |         base.dt = date(ver.created_at)\n 703 |     and \n 704 |         ver.status = 'verified'\n 705 | ) \n 706 | # %%\n 707 | select status, count(*)\n 708 | from pypl-edl.braintree_raw_tables.gateway_verifications \n 709 | group by 1\n 710 | order by 2 desc \n 711 | limit 10 \n 712 | # %%\n 713 | select sum(verifications_txn) / count(*) * 100\n 714 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver\n 715 | # %% [markdown]\n 716 | # ## Get Fastlane Feature from gateway_vaulted_payment_method_grants table\n 717 | #\n 718 | # - payment_method_fk found in gateway_vaulted_payment_method_grants denotes Fastlane transaction\n 719 | # %%\n 720 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl;\n 721 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl as\n 722 | (\n 723 |     select \n 724 |         base.*, \n 725 |         case when fl.pk is not null then 1 else 0 end as fastlane_txn \n 726 |     from \n 727 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver base\n 728 |     left join \n 729 |         pypl-edl.braintree_raw_tables.gateway_vaulted_payment_method_grants fl\n 730 |     on \n 731 |         base.payment_method_fk = fl.payment_method_fk\n 732 |     and \n 733 |         base.merchant_fk = fl.merchant_fk \n 734 |     and \n 735 |         base.dt = date(fl.created_at)\n 736 | ) \n 737 | # %% [markdown]\n 738 | # ## Get mcc_code\n 739 | # %%\n 740 | select processor_settings_type, count(*)\n 741 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl\n 742 | group by 1\n 743 | # %%\n 744 | -- base population of all txns \n 745 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc ;\n 746 | create table if not exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc as\n 747 | (\n 748 |     select\n 749 |          b.*, \n 750 |         case when processor_settings_type = 'Salem::Settings' then salem.mcc\n 751 |         when processor_settings_type = 'Adyen::Settings' then adyen.merchant_category_code\n 752 |         when processor_settings_type = 'WorldPay::Settings'then wp.merchant_category_code\n 753 |         when processor_settings_type = 'FirstData::Settings'then fd.merchant_category_code\n 754 |         when processor_settings_type = 'VisaDirect::Settings'then vd.merchant_category_code\n 755 |         when processor_settings_type = 'MastercardDirect::Settings'then md.country_code\n 756 |         when processor_settings_type = 'Integrations::Settings' then i.merchant_category_code\n 757 |         when processor_settings_type = 'AIB::Settings' then aib.merchant_category_code\n 758 |         when processor_settings_type = 'CardProcessor::Settings' then cp.merchant_category_code\n 759 |         when processor_settings_type = 'OmnipayDirect::Settings' then od.merchant_category_code\n 760 |         when processor_settings_type = 'AmexDirect::Settings' then amex.merchant_category_code\n 761 |         when processor_settings_type = 'PayPalClosedLoop::Settings' then ppcl.merchant_category_code\n 762 |         when processor_settings_type = 'Tsys::Settings' then tsys.merchant_category_code \n 763 |         when processor_settings_type = 'Nab::Settings' then nab.merchant_category_code\n 764 |         when processor_settings_type = 'Moneris::Settings' then moneris.merchant_category_code\n 765 |         when processor_settings_type = 'CustomActions::Settings' then ca.merchant_category_code \n 766 |         else null end as mcc_code, \n 767 |     from\n 768 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl  b \n 769 |     left join \n 770 |         pypl-edl.braintree_raw_tables.gateway_salem_settings salem\n 771 |     on \n 772 |         b.processor_settings_fk = salem.pk \n 773 |     and \n 774 |         b.processor_settings_type = 'Salem::Settings'\n 775 |     left join \n 776 |         pypl-edl.braintree_raw_tables.gateway_adyen_settings adyen\n 777 |     on \n 778 |         b.processor_settings_fk = adyen.pk \n 779 |     and \n 780 |         b.processor_settings_type = 'Adyen::Settings'\n 781 |     left join \n 782 |         pypl-edl.braintree_raw_tables.gateway_world_pay_settings wp\n 783 |     on \n 784 |         b.processor_settings_fk = wp.pk \n 785 |     and \n 786 |         b.processor_settings_type = 'WorldPay::Settings'\n 787 |     left join \n 788 |         pypl-edl.braintree_raw_tables.gateway_first_data_settings fd\n 789 |     on \n 790 |         b.processor_settings_fk = fd.pk \n 791 |     and \n 792 |         b.processor_settings_type = 'FirstData::Settings'\n 793 |     left join \n 794 |     (\n 795 |         select \n 796 |             i_sub.pk, \n 797 |             amex.merchant_category_code,\n 798 |             amex.acquirer_country\n 799 |         from\n 800 |             pypl-edl.braintree_raw_tables.gateway_integrations_settings i_sub\n 801 |         left join \n 802 |             pypl-edl.braintree_raw_tables.gateway_amex_direct_settings amex\n 803 |         on \n 804 |             i_sub.gateway_amex_direct_settings_fk = amex.pk \n 805 |     ) i\n 806 |     on \n 807 |         b.processor_settings_fk = i.pk \n 808 |     and \n 809 |         b.processor_settings_type = 'Integrations::Settings'\n 810 |     left join \n 811 |     ( select \n 812 |          v.pk, \n 813 |          fd.merchant_category_code,\n 814 |          fd.country_code\n 815 |     from\n 816 |         pypl-edl.braintree_raw_tables.gateway_visa_direct_settings v \n 817 |     inner join \n 818 |         pypl-edl.braintree_raw_tables.gateway_first_data_settings fd\n 819 |     on \n 820 |         v.first_data_settings_fk = fd.pk ) vd\n 821 |     on \n 822 |         b.processor_settings_fk = vd.pk \n 823 |     and \n 824 |         b.processor_settings_type = 'VisaDirect::Settings'\n 825 |         left join \n 826 |     ( select \n 827 |          m.pk, \n 828 |          fd.merchant_category_code,\n 829 |          fd.country_code\n 830 |     from\n 831 |         pypl-edl.braintree_raw_tables.gateway_mastercard_direct_settings m\n 832 |     inner join \n 833 |         pypl-edl.braintree_raw_tables.gateway_first_data_settings fd\n 834 |     on \n 835 |         m.first_data_settings_fk = fd.pk ) md\n 836 |     on \n 837 |         b.processor_settings_fk = md.pk \n 838 |     and \n 839 |         b.processor_settings_type = 'MastercardDirect::Settings'\n 840 |     left join \n 841 |         pypl-edl.braintree_raw_tables.gateway_aib_settings aib\n 842 |     on \n 843 |         b.processor_settings_fk = aib.pk \n 844 |     and \n 845 |         b.processor_settings_type = 'AIB::Settings'\n 846 |     left join \n 847 |         pypl-edl.braintree_raw_tables.gateway_card_processor_settings cp\n 848 |     on \n 849 |         b.processor_settings_fk = cp.pk \n 850 |     and \n 851 |         b.processor_settings_type = 'CardProcessor::Settings'\n 852 |     left join \n 853 |         pypl-edl.braintree_raw_tables.gateway_omnipay_direct_settings od\n 854 |     on \n 855 |         b.processor_settings_fk = od.pk \n 856 |     and \n 857 |         b.processor_settings_type = 'OmnipayDirect::Settings'\n 858 |     left join \n 859 |         pypl-edl.braintree_raw_tables.gateway_amex_direct_settings amex\n 860 |     on \n 861 |         b.processor_settings_fk = amex.pk \n 862 |     and \n 863 |         b.processor_settings_type = 'AmexDirect::Settings'\n 864 |     left join \n 865 |         pypl-edl.braintree_raw_tables.gateway_nab_settings nab\n 866 |     on \n 867 |         b.processor_settings_fk = nab.pk \n 868 |     and \n 869 |         b.processor_settings_type = 'Nab::Settings'\n 870 |     left join \n 871 |         pypl-edl.braintree_raw_tables.gateway_moneris_settings moneris\n 872 |     on \n 873 |         b.processor_settings_fk = moneris.pk \n 874 |     and \n 875 |         b.processor_settings_type = 'Moneris::Settings'\n 876 |     left join \n 877 |         pypl-edl.braintree_raw_tables.gateway_paypal_closed_loop_settings ppcl\n 878 |     on \n 879 |         b.processor_settings_fk = ppcl.pk \n 880 |     and \n 881 |         b.processor_settings_type = 'PayPalClosedLoop::Settings'\n 882 |     left join \n 883 |         pypl-edl.braintree_raw_tables.gateway_tsys_settings tsys\n 884 |     on \n 885 |         b.processor_settings_fk = tsys.pk \n 886 |     and \n 887 |         b.processor_settings_type = 'Tsys::Settings'\n 888 |     left join \n 889 |         pypl-edl.braintree_raw_tables.gateway_custom_actions_settings ca\n 890 |     on \n 891 |         b.processor_settings_fk = ca.pk \n 892 |     and \n 893 |         b.processor_settings_type = 'CustomActions::Settings'\n 894 |     left join \n 895 |         pypl-edl.braintree_raw_tables.gateway_seb_settings seb\n 896 |     on \n 897 |         b.processor_settings_fk = seb.pk \n 898 |     and \n 899 |         b.processor_settings_type = 'Seb::Settings'\n 900 |     left join \n 901 |         pypl-edl.braintree_raw_tables.gateway_fake_processor_settings fp\n 902 |     on \n 903 |         b.processor_settings_fk = fp.pk \n 904 |     and \n 905 |         b.processor_settings_type = 'FakeProcessor::Settings'\n 906 | ) \n 907 | # %% [markdown]\n 908 | # ## (SKIP) Get BT24 Risk Score\n 909 | # %%\n 910 | -- drop table if exists  pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc_bt24 ;\n 911 | -- create table if not exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc_bt24 as\n 912 | -- (\n 913 | --     select \n 914 | --         b.*, \n 915 | --         -- features to pull BT Risk RADDs\n 916 | --         uds.correlation_id, \n 917 | --         --uds.merchant_fk, \n 918 | --         uds.cc_hash, \n 919 | --         case when uds.cc_bin is not null and uds.cc_last_4 is not null and uds.cc_expiration_date is not null \n 920 | --             then CONCAT(uds.cc_bin,'-', uds.cc_last_4,'-', uds.cc_expiration_date ) else null end as cc_bin_last_exp, \n 921 | --         case when (uds.cc_bin is not null and uds.cc_country_of_issuance_2letters is not null ) then\n 922 | --             CONCAT(uds.cc_bin,'-',uds.cc_country_of_issuance_2letters) else null end as cc_bin_country_of_issuance, \n 923 | --         uds.phone, \n 924 | --         uds.email, \n 925 | --         uds.created_at_utc, \n 926 | --         DATETIME(created_at_utc, \"America/Los_Angeles\") as created_at_pt,\n 927 | --         uds.pit_timestamp,\n 928 | --         -- BT Risk Scores \n 929 | --         uds.bt19_model_score1, \n 930 | --         uds.bt21_model_score1, \n 931 | --         uds.bt23_model_score1, \n 932 | --         uds.bt24_model_score1, \n 933 | --         -- BT UDS Context Features\n 934 | --         uds.mcc_code as mcc_code_uds, \n 935 | --         -- uds.refund_flag,\n 936 | --         -- uds.sender_ip1, \n 937 | --         -- uds.sender_ip2, \n 938 | --         -- uds.sender_ip3,\n 939 | --         -- uds.tenant_numeric_ip4,\n 940 | --         -- uds.tenant_numeric_ip3,\n 941 | --         -- uds.tenant_numeric_ip2,\n 942 | --         -- uds.tenant_numeric_ip1,\n 943 | --         -- uds.tenant_string_ip,\n 944 | --         -- uds.tenant_string_ip1,\n 945 | --         -- uds.tenant_string_ip2,\n 946 | --         -- uds.tenant_string_ip3,\n 947 | --         -- uds.is_refund_or_preauth, \n 948 | --         -- uds.ar_fraud_reason, \n 949 | --         -- uds.cc_segment,\n 950 | --         -- uds.has_legal_restriction, \n 951 | --         -- uds.legal_scenario, \n 952 | --         -- uds.cc_trust, \n 953 | --         -- uds.fraud_status, \n 954 | --         -- label related features \n 955 | --         --uds.amount_submitted_for_settlement, \n 956 | --         --uds.send_receipt_on_submit_for_settlement,\n 957 | --         --uds.has_partial_settlement_transactions, \n 958 | --         --uds.disputed_at, \n 959 | --         --uds.is_cc_bad, \n 960 | --     from\n 961 | --         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc  b\n 962 | --     left join \n 963 | --         ( select * \n 964 | --          from pypl-bods.pp_risk_rap_bt_managed_pii_views.bt_txn_uds \n 965 | --          where date(created_at_utc, \"America/Los_Angeles\") >= \"2023-08-01\" \n 966 | --         ) uds\n 967 | --     on\n 968 | --         b.primary_txn_id = uds.pk \n 969 | -- ) \n 970 | # %% [markdown]\n 971 | # # Filter NA RADDs to simulate ground-truth missing rate\n 972 | # %%\n 973 | with sub as ( select *\n 974 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered\n 975 | where idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null \n 976 |  ) \n 977 | select \n 978 | sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d is null then 1 else 0 end) / count(*), \n 979 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d is null then 1 else 0 end) / count(*), \n 980 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d is null then 1 else 0 end) / count(*), \n 981 |  sum(case when idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d is null then 1 else 0 end) / count(*), \n 982 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 983 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 984 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 985 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 986 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 987 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n 988 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n 989 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n 990 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n 991 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n 992 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 993 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 994 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n 995 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n 996 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n 997 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n 998 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n 999 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n1000 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n1001 |  sum(case when idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n1002 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n1003 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n1004 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n1005 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n1006 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n1007 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d is null then 1 else 0 end) / count(*), \n1008 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d is null then 1 else 0 end) / count(*), \n1009 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d is null then 1 else 0 end) / count(*), \n1010 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is null then 1 else 0 end) / count(*), \n1011 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d is null then 1 else 0 end) / count(*), \n1012 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n1013 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n1014 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n1015 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n1016 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n1017 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d is null then 1 else 0 end) / count(*), \n1018 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d is null then 1 else 0 end) / count(*), \n1019 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d is null then 1 else 0 end) / count(*), \n1020 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d is null then 1 else 0 end) / count(*), \n1021 |  sum(case when idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d is null then 1 else 0 end) / count(*), \n1022 |   from sub\n1023 | # %%\n1024 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered;\n1025 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered as\n1026 | (\n1027 |     select * \n1028 |     from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_3ds_ver_fl_mcc_bt24\n1029 |     where idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d is not null\n1030 | ) \n1031 | # %% [markdown]\n1032 | # # Deduplicate\n1033 | # %%\n1034 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup;\n1035 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup as\n1036 | (\n1037 | with sub as (\n1038 |     select * \n1039 |     from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered\n1040 | ) \n1041 | SELECT *\n1042 | FROM sub\n1043 | WHERE TRUE\n1044 | QUALIFY ROW_NUMBER() OVER (PARTITION BY primary_txn_id ORDER BY dt DESC) = 1\n1045 | ) \n1046 | # %%\n1047 | select count(*), count(distinct primary_txn_id)\n1048 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n1049 | # %% [markdown]\n1050 | # # 5. Train-Val-Test Split\n1051 | # %% [markdown]\n1052 | # - we want a random sample across all time period, because we want the model to learn patterns from the entire history up to model training date \n1053 | # %%\n1054 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3;\n1055 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3 as\n1056 | (\n1057 |     select\n1058 |         *\n1059 |     from\n1060 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n1061 |     where\n1062 |         retry_order = 1\n1063 |     and\n1064 |         abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) < 900  -- train downsampling factor\n1065 | );\n1066 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3;\n1067 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3 as\n1068 | (\n1069 |     select\n1070 |         *\n1071 |     from\n1072 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n1073 |     where\n1074 |         retry_order = 1\n1075 |     and\n1076 |         abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) >= 900  -- validation downsampling factor\n1077 |     and\n1078 |         abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) < 950\n1079 | );\n1080 | drop table if exists pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3;\n1081 | create table pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3 as\n1082 | (\n1083 |     select\n1084 |         *\n1085 |     from\n1086 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_cast_filtered_dedup\n1087 |     where\n1088 |         retry_order = 1\n1089 |     and\n1090 |         abs(mod(farm_fingerprint(cast(retry_txn_id as string)), 1000)) >= 950  -- OOT downsampling factor\n1091 | );\n1092 | # %%\n1093 | select\n1094 |     retry_is_success,\n1095 |     count(*) as n,\n1096 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1097 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3\n1098 | group by 1\n1099 | # %%\n1100 | select\n1101 |     primary_response_type,\n1102 |     count(*) as n,\n1103 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1104 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3\n1105 | group by 1\n1106 | order by 2 desc\n1107 | # %%\n1108 | select\n1109 |     retry_strategy_type,\n1110 |     count(*) as n,\n1111 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1112 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3\n1113 | group by 1\n1114 | order by 2 desc\n1115 | # %%\n1116 | select count(*), min(dt), max(dt) \n1117 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3\n1118 | # %%\n1119 | select count(*), min(dt), max(dt) \n1120 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3\n1121 | # %%\n1122 | select\n1123 |     retry_is_success,\n1124 |     count(*) as n,\n1125 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1126 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3\n1127 | group by 1\n1128 | order by 2 desc\n1129 | # %%\n1130 | select\n1131 |     primary_response_type,\n1132 |     count(*) as n,\n1133 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1134 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3\n1135 | group by 1\n1136 | order by 2 desc\n1137 | # %%\n1138 | select\n1139 |     retry_strategy_type,\n1140 |     count(*) as n,\n1141 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1142 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_3\n1143 | group by 1\n1144 | order by 2 desc\n1145 | # %%\n1146 | select count(*), min(dt), max(dt) \n1147 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1148 | # %%\n1149 | select\n1150 |     retry_is_success,\n1151 |     count(*) as n,\n1152 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1153 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1154 | group by 1\n1155 | order by 2 desc\n1156 | # %%\n1157 | select\n1158 |     primary_response_type,\n1159 |     count(*) as n,\n1160 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1161 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1162 | group by 1\n1163 | order by 2 desc\n1164 | # %%\n1165 | select\n1166 |     retry_strategy_type,\n1167 |     count(*) as n,\n1168 |     count(*) / sum(count(*)) over() * 100 as n_perc, \n1169 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1170 | group by 1\n1171 | order by 2 desc\n1172 | # %%\n1173 | select *\n1174 | from pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1175 | limit 3\n1176 | # %% [markdown]\n1177 | # ## Copy to pp_scratch for QPull purposes\n1178 | # %%\n1179 | drop table if exists pypl-edw.pp_scratch.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3;\n1180 | create table pypl-edw.pp_scratch.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3 as\n1181 | (\n1182 |     select\n1183 |         *\n1184 |     from\n1185 |         pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3\n1186 | ) \n1187 | # %%",
    "rmr_agent/repos/bt-retry-v2/etl/02_bq_to_dataproc.py": "   1 | # %%\n   2 | # %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n   3 | # %config PPMagics.autolimit=0\n   4 | # %%\n   5 | # %%url --dataproc --cluster dnaomi-bt-retry --project ccg24-hrzana-gds-pacman\n   6 | # %%\n   7 | # %%configure -f\n   8 | {\n   9 |     \"conf\": {\n  10 |         \"spark.jars\": \"gs://spark-lib/bigquery/spark-bigquery-with-dependencies_2.12-0.18.1.jar\",\n  11 |         \"spark.executor.extraClassPath\": \"spark-bigquery-with-dependencies_2.12-0.18.1.jar\",\n  12 |         \"spark.driver.extraClassPath\": \"spark-bigquery-with-dependencies_2.12-0.18.1.jar\"\n  13 |     }\n  14 | }\n  15 | # %%\n  16 | spark.conf.set(\"viewsEnabled\", \"true\")\n  17 | spark.conf.set(\"materializationProject\", \"pypl-edw\")\n  18 | spark.conf.set(\"materializationDataset\", \"pp_scratch\")\n  19 | # try also pypl-bods.rsh_row_gds_pacman\n  20 | spark.conf.set('temporaryGcsBucket', \"pypl-bkt-rsh-row-std-gds-pacman\")\n  21 | # %%\n  22 | def create_bigquery_table(source_table_name, target_table_name):\n  23 |     df = spark.read.format('bigquery') \\\n  24 |         .option('table', source_table_name) \\\n  25 |         .load()\n  26 |     df.write.format('bigquery').mode('overwrite') \\\n  27 |     .option('table', target_table_name) \\\n  28 |     .save()\n  29 | def create_gcs_table(source_table_name, target_path):\n  30 |     df = spark.read.format('bigquery') \\\n  31 |         .option('table', source_table_name) \\\n  32 |         .load()\n  33 |     df.write.mode('overwrite') \\\n  34 |     .parquet(target_path)\n  35 | # %%\n  36 | source_table_name = \"pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train\"\n  37 | target_gcs_path = \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_2\"\n  38 | # %%\n  39 | create_gcs_table(source_table_name, target_gcs_path)\n  40 | # %%\n  41 | source_table_name = \"pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid\"\n  42 | target_gcs_path = \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_valid_2\"\n  43 | # %%\n  44 | create_gcs_table(source_table_name, target_gcs_path)\n  45 | # %%\n  46 | source_table_name = \"pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test\"\n  47 | target_gcs_path = \"gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_2\"\n  48 | # %%\n  49 | create_gcs_table(source_table_name, target_gcs_path)\n  50 | # %%\n  51 | # #!gsutil -m cp -r gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_control_train data/\n  52 | # %%\n  53 | # ##!gsutil -m cp -r gs://pypl-bkt-rsh-row-std-gds-pacman/user/dnaomi/bt_retry_refresh/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_train_3 data/",
    "rmr_agent/repos/bt-retry-v2/model-dev/train.py": "   1 | # %%\n   2 | # %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n   3 | # %config PPMagics.autolimit=0\n   4 | # %%\n   5 | # %config Completer.use_jedi = False\n   6 | # %load_ext autoreload\n   7 | # %autoreload 2\n   8 | # %%\n   9 | import os\n  10 | import json\n  11 | from functools import partial\n  12 | import joblib\n  13 | import numpy as np\n  14 | import pandas as pd\n  15 | from pathlib import Path\n  16 | import lightgbm as lgb\n  17 | from lightgbm import LGBMClassifier\n  18 | import optuna\n  19 | import mlflow\n  20 | import mlflow.lightgbm\n  21 | # %%\n  22 | # !pip install optuna\n  23 | # %%\n  24 | pd.set_option('display.max_rows', 1000)\n  25 | pd.set_option('display.max_colwidth', 1000)\n  26 | pd.options.display.float_format = '{:.6f}'.format\n  27 | # %% [markdown]\n  28 | # ## Helper functions\n  29 | # %%\n  30 | def list_to_txt(lst, folder, path):\n  31 |     \"\"\"Save a list to text file\n  32 |     \"\"\"\n  33 |     with open(folder + path, mode=\"w\") as f:\n  34 |         f.write(\"\\n\".join(lst))\n  35 | def list_from_txt(path):\n  36 |     \"\"\"Return a list with each element containing a line\n  37 |         of the file in the given path\n  38 |     \"\"\"\n  39 |     with open(path, mode=\"r\") as f:\n  40 |         lst = [line.rstrip() for line in f.readlines()]\n  41 |     return lst\n  42 | def write_dict_to_json(folder, output_path, dictionary):\n  43 |     \"\"\"\n  44 |     Write dictionary into JSON\n  45 |     \"\"\"\n  46 |     with open(folder + output_path, \"w\") as outfile:\n  47 |         json.dump(dictionary, outfile)\n  48 | def read_dict_from_json(folder, input_path):\n  49 |     \"\"\"\n  50 |     Read JSON from given path as dictionary\n  51 |     \"\"\"\n  52 |     with open(folder + input_path) as json_file:\n  53 |         data = json.load(json_file)\n  54 |     return data\n  55 | def convert_column_types(df, numerical_columns, integer_columns, categorical_columns):\n  56 |     \"\"\"Convert numerical, integer and categorical columns of provided\n  57 |     pandas.DataFrame\n  58 |         Specificaly, convert categorical columns to pandas.Categorical,\n  59 |         numerical columns to numpy.float32 and\n  60 |         integer columns to numpy.int64\n  61 |     \"\"\"\n  62 |     for col in categorical_columns:\n  63 |         df[col] = pd.Categorical(df[col])\n  64 |     for col in numerical_columns:\n  65 |         df[col] = df[col].astype(np.float32)\n  66 |     for col in integer_columns:\n  67 |         df[col] = df[col].astype(np.int64)\n  68 |     return df\n  69 | # %%\n  70 | \"\"\"\n  71 | BT Retry Global\n  72 | Useful metrics functions.\n  73 | \"\"\"\n  74 | import numpy as np\n  75 | from sklearn.metrics import precision_recall_curve, auc\n  76 | def precision_at_recall(y_true, y_score, recall_value):\n  77 |     \"\"\"Precision at the given recall value\n  78 |     \"\"\"\n  79 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  80 |     if np.sum(recalls >= recall_value) == 0:\n  81 |         return 0.\n  82 |     idx = np.argmin(recalls[recalls >= recall_value])\n  83 |     precision_value = precisions[idx]\n  84 |     return precision_value\n  85 | def threshold_at_recall(y_true, y_score, recall_value):\n  86 |     \"\"\"Threshold at the given recall value\n  87 |     \"\"\"\n  88 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  89 |     if np.sum(recalls >= recall_value) == 0:\n  90 |         return 0.\n  91 |     idx = np.argmin(recalls[recalls >= recall_value])\n  92 |     threshold = thresholds[idx - 1]\n  93 |     return threshold\n  94 | def savings_at_recall(y_true, y_score, recall_value):\n  95 |     \"\"\"Positive prediction rate savings at the given recall value\n  96 |     \"\"\"\n  97 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  98 |     if np.sum(recalls >= recall_value) == 0:\n  99 |         return 0.\n 100 |     idx = np.argmin(recalls[recalls >= recall_value])\n 101 |     precision_value = precisions[idx]\n 102 |     min_ratio = y_true.mean()\n 103 |     try:\n 104 |         savings = 1 - recall_value * min_ratio / precision_value\n 105 |     except ValueError as e:\n 106 |         savings = 0.\n 107 |     return savings\n 108 | # def precision_at_recall(precisions, recalls, recall_value):\n 109 | #     \"\"\"Precision at the given recall value\n 110 | #     \"\"\"\n 111 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 112 | #     precision_value = precisions[idx]\n 113 | #     return precision_value\n 114 | # def threshold_at_recall(thresholds, recalls, recall_value):\n 115 | #     \"\"\"Threshold at the given recall value\n 116 | #     \"\"\"\n 117 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 118 | #     threshold = thresholds[idx - 1]\n 119 | #     return threshold\n 120 | # def savings_at_recall(precisions, recalls, recall_value, min_ratio):\n 121 | #     \"\"\"Positive prediction rate savings at the given recall value\n 122 | #     \"\"\"\n 123 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 124 | #     precision_value = precisions[idx]\n 125 | #     return 1 - recall_value * min_ratio / precision_value\n 126 | def partial_aucpr(y_true, y_score, recall_lb, recall_ub):\n 127 |     \"\"\"Partial Area Under the PR Curve between the given recall levels\n 128 |     \"\"\"\n 129 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n 130 |     if np.sum(recalls >= recall_lb) == 0:\n 131 |         return 0.\n 132 |     idx_right = np.argmin(recalls[recalls >= recall_lb])\n 133 |     if np.sum(recalls >= recall_ub) == 0:\n 134 |         # get max recall possible\n 135 |         idx_left = np.argmax(recalls[recalls >= recall_lb])\n 136 |     else:\n 137 |         idx_left = np.argmin(recalls[recalls >= recall_ub])\n 138 |     try:\n 139 |         p_aucpr = auc(recalls[idx_left:idx_right], precisions[idx_left:idx_right])\n 140 |     except ValueError as e:\n 141 |         p_aucpr = 0.\n 142 |     return p_aucpr\n 143 | def evaluate_metrics(y_true, y_score, metric_functions):\n 144 |     \"\"\"Evaluate a list of metrics (callables) on y_true and y_score\n 145 |     \"\"\"\n 146 |     return [score(y_true, y_score) for score in metric_functions]\n 147 | def get_features_and_target(df, features, target_col):\n 148 |     \"\"\"Return feature matrix and 1-D label vector\n 149 |     \"\"\"\n 150 |     return df[features], df[target_col]\n 151 | # %%\n 152 | partial_aucpr_geq90 = partial(partial_aucpr, recall_lb=0.9, recall_ub=1.)\n 153 | precision_at_95 = partial(precision_at_recall, recall_value=0.95)\n 154 | precision_at_99 = partial(precision_at_recall, recall_value=0.99)\n 155 | savings_at_95 = partial(savings_at_recall, recall_value=0.95)\n 156 | savings_at_99 = partial(savings_at_recall, recall_value=0.99)\n 157 | EARLY_STOPPING_PARAMS = {\"stopping_rounds\": 10}\n 158 | EARLY_STOPPING_METRIC = \"average_precision\"\n 159 | METRIC_FUNCTIONS = [precision_at_95, precision_at_99, savings_at_95, savings_at_99, partial_aucpr_geq90]\n 160 | METRIC_NAMES = [\"precision_at_95\", \"precision_at_99\", \"savings_at_95\", \"savings_at_99\", \"partial_aucpr_geq90\"]\n 161 | OBJECTIVE_METRIC_NAME = \"partial_aucpr_geq90\"\n 162 | # %% [markdown]\n 163 | # ## Data\n 164 | # %%\n 165 | V1_FEATURES_PATH = Path(\n 166 |     \"/projects/dnaomi/bt-retry-global-v2/metadata/v1_features.txt\"\n 167 | )\n 168 | V1_LATEST_FEATURES_PATH = Path(\n 169 |     \"/projects/dnaomi/bt-retry-global-v2/metadata/v0_features_latest.txt\"\n 170 | )\n 171 | V2_FEATURES_PATH = Path(\n 172 |     \"/projects/dnaomi/bt-retry-global-v2/metadata/v2_features.txt\"\n 173 | )\n 174 | # %%\n 175 | TRAIN_PARQUET_PATH = Path(\n 176 |     \"/projects/dnaomi/bt-retry-global-v2/data/pypl-bods.gds_pacman_prod.bt_retry_global_v2_driverset_cc_renamed_radd_subset_filtered_full_train_3/\"\n 177 | )\n 178 | VAL_PARQUET_PATH = Path(\n 179 |     \"/projects/dnaomi/bt-retry-global-v2/data/pypl-bods.gds_pacman_prod.bt_retry_global_v2_driverset_cc_renamed_radd_subset_filtered_full_valid_3/\"\n 180 | )\n 181 | # %%\n 182 | FEATURES = list_from_txt(V2_FEATURES_PATH)\n 183 | V1_FEATURES = list_from_txt(V1_LATEST_FEATURES_PATH)\n 184 | # %%\n 185 | train_df = pd.read_parquet(TRAIN_PARQUET_PATH)\n 186 | # %%\n 187 | val_df = pd.read_parquet(VAL_PARQUET_PATH)\n 188 | # %%\n 189 | # %%\n 190 | train_df['retry_strategy_type'].unique()\n 191 | # %%\n 192 | val_df['retry_strategy_type'].unique()\n 193 | # %%\n 194 | # load features and types\n 195 | numerical_columns = [\"setec_txn_amt_usd\",\n 196 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d\",\n 197 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d\",\n 198 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d\",\n 199 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d\",\n 200 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d\",\n 201 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n 202 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n 203 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n 204 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n 205 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n 206 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n 207 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n 208 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n 209 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n 210 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d\",\n 211 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n 212 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n 213 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n 214 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n 215 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n 216 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n 217 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n 218 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n 219 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\",\n 220 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d\",\n 221 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n 222 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n 223 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n 224 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n 225 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n 226 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n 227 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n 228 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n 229 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n 230 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d\",\n 231 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n 232 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n 233 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n 234 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n 235 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n 236 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n 237 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n 238 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n 239 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\", \n 240 |                     # \"bt24_model_score1\" \n 241 |                     ]\n 242 | integer_columns = []\n 243 | encoded_columns = []  # no encoded columns in this example\n 244 | categorical_columns = [\"merchant_fk\",\n 245 |                        \"setec_currency_code\",\n 246 |                        \"primary_response_type\",\n 247 |                        \"processor_settings_type\", # renamed from primary_processor_settings_type\n 248 |                        \"retry_strategy_type\",\n 249 |                        \"card_type\",\n 250 |                        \"fi_usage\", \n 251 |                        \"issuer\", # renamed from cc_issuing_bank\n 252 |                        \"bin\",  # renamed from cc_bin\n 253 |                        # \"cc_postal_code\",  # REMOVED\n 254 |                        # \"cc_country_name\",  # REMOVED\n 255 |                        \"issuer_cntry_code\", # renamed from issuer_country\n 256 |                        #\"debit\", # REMOVED\n 257 |                         # \"cc_prepaid\",  # REMOVED\n 258 |                        #\"pan_guid\", # renamed from cc_pan_guid\n 259 |                        \"is_recurring_txn\", # renamed from recurring \n 260 |                        # from the latest model config file \n 261 |                        \"payment_method_token\", #  # REMOVED\n 262 |                       \"original_payment_method_fk\",  # REMOVED\n 263 |                        \"payment_instrument_type\", \n 264 |                        \"is_cvv_present\", \n 265 |                        \"enrollment_id\", \n 266 |                        \"enrollment_status\", \n 267 |                        \"token_status\", \n 268 |                       \"original_processor_settings_fk\", \n 269 |                        \"vaulted_credential_type\", \n 270 |                       \"shard\",\n 271 |                        \"mcc_code\", #NEW\n 272 |                        \"liability_shift_possible\", #NEW\n 273 |                        \"success_3ds\", #NEW\n 274 |                        \"verifications_txn\", #NEW\n 275 |                        \"fastlane_txn\" #NEW\n 276 |                       ]\n 277 | target_col = \"retry_is_success\"\n 278 | # %%\n 279 | features = numerical_columns + integer_columns + encoded_columns + categorical_columns\n 280 | # %%\n 281 | list_to_txt(features, \"/projects/dnaomi/bt-retry-global-v2/metadata/\", \"v2_features_final.txt\")\n 282 | # %%\n 283 | train_df[features].isnull().mean() * 100\n 284 | # %%\n 285 | # train_df['bt24_model_score1'] = pd.to_numeric(train_df['bt24_model_score1'])\n 286 | # %%\n 287 | # train_df['bt23_model_score1'] = pd.to_numeric(train_df['bt23_model_score1'])\n 288 | # %%\n 289 | val_df['issuer_cntry_code'] = val_df['issuer_country']\n 290 | # %%\n 291 | # convert data types\n 292 | train = convert_column_types(train_df,\n 293 |                              numerical_columns=numerical_columns,\n 294 |                              integer_columns=integer_columns + [target_col],\n 295 |                              categorical_columns=categorical_columns)\n 296 | valid = convert_column_types(val_df,\n 297 |                              numerical_columns=numerical_columns,\n 298 |                              integer_columns=integer_columns + [target_col],\n 299 |                              categorical_columns=categorical_columns)\n 300 | # %%\n 301 | # get features and target\n 302 | train_feat, y_train = get_features_and_target(train, features=features, target_col=target_col)\n 303 | valid_feat, y_valid = get_features_and_target(valid, features=features, target_col=target_col)\n 304 | # %%\n 305 | # best param for model with subset of strategies (all txns)\n 306 | best_params = { \n 307 | 'colsample_bytree': 0.5837239684404587,\n 308 | 'learning_rate': 0.0598927112458938,\n 309 | 'min_child_samples':61,\n 310 | 'min_data_in_bin':25,\n 311 | 'num_leaves':217,\n 312 | 'num_trees':141,\n 313 | 'n_estimators':141,\n 314 | 'n_jobs':8,\n 315 | 'reg_alpha':4.784258485091152e-08,\n 316 | 'reg_lambda':0.0002699654851946926,\n 317 | 'subsample':0.6899589770039457,\n 318 | 'subsample_freq':5,\n 319 | }\n 320 | # %%\n 321 | train_ = train_feat[features]\n 322 | valid_ = valid_feat[features]\n 323 | # %%\n 324 | #model = LGBMClassifier(**best_params)\n 325 | model = LGBMClassifier()\n 326 | model.fit(train_, y_train)\n 327 | # %%\n 328 | pred_probas = model.predict_proba(valid_)\n 329 | predictions = pred_probas[:, -1]\n 330 | metric_values = evaluate_metrics(y_valid, predictions, METRIC_FUNCTIONS)\n 331 | # %%\n 332 | model.booster_.save_model('/projects/dnaomi/bt-retry-global-v2/models/final/bt_retry_v2.txt')\n 333 | # %%\n 334 | pd.DataFrame(index=METRIC_NAMES, data=metric_values, columns=[\"value\"])\n 335 | # %%\n 336 | metric_values\n 337 | # %%\n 338 | lgb.plot_importance(model, figsize=(10,10), importance_type='gain', max_num_features=15)\n 339 | # %%\n 340 | lgb.plot_importance(model, figsize=(10,10), importance_type='split', max_num_features=15)\n 341 | # %%\n 342 | model\n 343 | # %%\n 344 | features = model.feature_name()\n 345 | importances = model.feature_importance(importance_type='gain')\n 346 | feature_importance = pd.DataFrame({'importance':importances, 'feature':features}).sort_values('importance', ascending=False).reset_index(drop=True)\n 347 | feature_importance\n 348 | # %% [markdown]\n 349 | # ## Hyperparameter Tuning with Optuna\n 350 | # %%\n 351 | # !pwd\n 352 | # %%\n 353 | TRACKING_URL = \"https://mlflow.apps.cosmos-onprem.dp.lvs.paypalinc.com\"\n 354 | EXPERIMENT_NAME = \"bt_retry_global_v2_full_fts_strategy_subset_model_all_strat_valid_control\"  \n 355 | STUDY_NAME = \"bt-retry-global-v1-full-fts-strategy-subset-model-all-strat-valid-control\" \n 356 | STUDIES_DIR = \"../reports/studies/\"\n 357 | STUDY_DIR = os.path.join(STUDIES_DIR, STUDY_NAME)\n 358 | if not os.path.exists(STUDY_DIR):\n 359 |     os.mkdir(STUDY_DIR)\n 360 | N_TRIALS = 250\n 361 | OPTUNA_STUDY_PATH = os.path.join(STUDY_DIR, STUDY_NAME + \".pkl\")\n 362 | STDOUT_PATH = os.path.join(STUDY_DIR, STUDY_NAME + \"-stdout.txt\")\n 363 | STDERR_PATH = os.path.join(STUDY_DIR, STUDY_NAME + \"-stdout.txt\")\n 364 | os.environ['MLFLOW_TRACKING_URL'] = TRACKING_URL\n 365 | mlflow.set_tracking_uri(os.environ['MLFLOW_TRACKING_URL'])\n 366 | mlflow.set_experiment(EXPERIMENT_NAME, os.environ['USER'])\n 367 | # %%\n 368 | OBJECTIVE_METRIC_NAME\n 369 | # %%\n 370 | def objective(trial, objective_metric_name=OBJECTIVE_METRIC_NAME):\n 371 |     with mlflow.start_run():\n 372 |         param = {\n 373 |             \"n_jobs\": 8,\n 374 |             \"n_estimators\": trial.suggest_int(\"n_estimators\", 1, 150, 5),\n 375 |             \"min_data_in_bin\": 25,\n 376 |             \"learning_rate\": trial.suggest_loguniform(\"learning_rate\", 1e-5, 1.),\n 377 |             \"reg_alpha\": trial.suggest_loguniform(\"reg_alpha\", 1e-8, 10.0),\n 378 |             \"reg_lambda\": trial.suggest_loguniform(\"reg_lambda\", 1e-8, 10.0),\n 379 |             \"num_leaves\": trial.suggest_int(\"num_leaves\", 2, 256),\n 380 |             \"colsample_bytree\": trial.suggest_uniform(\"colsample_bytree\", 0.5, 1.0),\n 381 |             \"subsample\": trial.suggest_uniform(\"subsample\", 0.4, 0.9),\n 382 |             \"subsample_freq\": trial.suggest_int(\"subsample_freq\", 2, 5),\n 383 |             \"min_child_samples\": trial.suggest_int(\"min_child_samples\", 5, 100),\n 384 |         }\n 385 |         model = LGBMClassifier(**param)\n 386 |         model.fit(train_, y_train)                 \n 387 |         # 7.\n 388 |         pred_probas = model.predict_proba(valid_)\n 389 |         predictions = pred_probas[:, -1]\n 390 |         metric_values = evaluate_metrics(y_valid, predictions, METRIC_FUNCTIONS)\n 391 |         metrics = {name: value for name, value in zip(METRIC_NAMES, metric_values)}\n 392 |         # 8.\n 393 |         mlflow.log_params(param)\n 394 |         mlflow.log_param(\"num_trees\", model.booster_.num_trees())\n 395 |         mlflow.log_metrics(metrics)\n 396 |         mlflow.lightgbm.log_model(model.booster_, \"lgbm_booster\")\n 397 |     return metrics[objective_metric_name]\n 398 | # %%\n 399 | # %%capture capt\n 400 | optuna.logging.set_verbosity(optuna.logging.WARNING)\n 401 | if os.path.exists(OPTUNA_STUDY_PATH):\n 402 |     study = joblib.load(OPTUNA_STUDY_PATH)\n 403 |     n_trials_completed = len(study.trials)\n 404 | else:\n 405 |     study = optuna.create_study(study_name=STUDY_NAME,\n 406 |                                 direction=\"maximize\")\n 407 |     n_trials_completed = 0\n 408 | study.optimize(objective, n_trials=N_TRIALS - n_trials_completed)\n 409 | # %%\n 410 | with open(STDOUT_PATH, \"w\") as f:\n 411 |     f.write(capt.stdout)\n 412 | # %%\n 413 | joblib.dump(study, OPTUNA_STUDY_PATH)\n 414 | # %%",
    "rmr_agent/repos/bt-retry-v2/model-dev/evaluate.py": "   1 | # %%\n   2 | # %config PPMagics.domain='ccg24-hrzana-gds-pacman'\n   3 | # %config PPMagics.autolimit=0\n   4 | # %%\n   5 | # %config Completer.use_jedi = False\n   6 | # %load_ext autoreload\n   7 | # %autoreload 2\n   8 | from functools import partial\n   9 | import numpy as np\n  10 | import pandas as pd\n  11 | from pathlib import Path\n  12 | import matplotlib.pyplot as plt\n  13 | from sklearn.metrics import precision_recall_curve, precision_score, recall_score\n  14 | import lightgbm as lgb\n  15 | plt.style.use('ggplot')\n  16 | plt.rcParams['figure.figsize'] = (9, 6)\n  17 | plt.rcParams['font.size'] = 12\n  18 | # %matplotlib inline\n  19 | # %%\n  20 | colours = [\"#E24A33\", \"#348ABD\", \"#988ED5\", \"#777777\", \"#FBC15E\", \"#8EBA42\", \"#FFB5B8\"]\n  21 | # %%\n  22 | def list_to_txt(lst, folder, path):\n  23 |     \"\"\"Save a list to text file\n  24 |     \"\"\"\n  25 |     with open(folder + path, mode=\"w\") as f:\n  26 |         f.write(\"\\n\".join(lst))\n  27 | def list_from_txt(path):\n  28 |     \"\"\"Return a list with each element containing a line\n  29 |         of the file in the given path\n  30 |     \"\"\"\n  31 |     with open(path, mode=\"r\") as f:\n  32 |         lst = [line.rstrip() for line in f.readlines()]\n  33 |     return lst\n  34 | def write_dict_to_json(folder, output_path, dictionary):\n  35 |     \"\"\"\n  36 |     Write dictionary into JSON\n  37 |     \"\"\"\n  38 |     with open(folder + output_path, \"w\") as outfile:\n  39 |         json.dump(dictionary, outfile)\n  40 | def read_dict_from_json(folder, input_path):\n  41 |     \"\"\"\n  42 |     Read JSON from given path as dictionary\n  43 |     \"\"\"\n  44 |     with open(folder + input_path) as json_file:\n  45 |         data = json.load(json_file)\n  46 |     return data\n  47 | def convert_column_types(df, numerical_columns, integer_columns, categorical_columns):\n  48 |     \"\"\"Convert numerical, integer and categorical columns of provided\n  49 |     pandas.DataFrame\n  50 |         Specificaly, convert categorical columns to pandas.Categorical,\n  51 |         numerical columns to numpy.float32 and\n  52 |         integer columns to numpy.int64\n  53 |     \"\"\"\n  54 |     for col in categorical_columns:\n  55 |         df[col] = pd.Categorical(df[col])\n  56 |     for col in numerical_columns:\n  57 |         df[col] = df[col].astype(np.float32)\n  58 |     for col in integer_columns:\n  59 |         df[col] = df[col].astype(np.int64)\n  60 |     return df\n  61 | # %%\n  62 | \"\"\"\n  63 | BT Retry Global\n  64 | Useful metrics functions.\n  65 | \"\"\"\n  66 | import numpy as np\n  67 | from sklearn.metrics import precision_recall_curve, auc\n  68 | def precision_at_recall(y_true, y_score, recall_value):\n  69 |     \"\"\"Precision at the given recall value\n  70 |     \"\"\"\n  71 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  72 |     if np.sum(recalls >= recall_value) == 0:\n  73 |         return 0.\n  74 |     idx = np.argmin(recalls[recalls >= recall_value])\n  75 |     precision_value = precisions[idx]\n  76 |     return precision_value\n  77 | def threshold_at_recall(y_true, y_score, recall_value):\n  78 |     \"\"\"Threshold at the given recall value\n  79 |     \"\"\"\n  80 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  81 |     if np.sum(recalls >= recall_value) == 0:\n  82 |         return 0.\n  83 |     idx = np.argmin(recalls[recalls >= recall_value])\n  84 |     threshold = thresholds[idx - 1]\n  85 |     return threshold\n  86 | def savings_at_recall(y_true, y_score, recall_value):\n  87 |     \"\"\"Positive prediction rate savings at the given recall value\n  88 |     \"\"\"\n  89 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n  90 |     if np.sum(recalls >= recall_value) == 0:\n  91 |         return 0.\n  92 |     idx = np.argmin(recalls[recalls >= recall_value])\n  93 |     precision_value = precisions[idx]\n  94 |     treshold_value = thresholds[idx]\n  95 |     min_ratio = y_true.mean()\n  96 |     try:\n  97 |         savings = 1 - recall_value * min_ratio / precision_value\n  98 |     except ValueError as e:\n  99 |         savings = 0.\n 100 |     return savings\n 101 | def retry_success_rate_at_recall(y_true, y_score, recall_value):\n 102 |     \"\"\" retry success rate = # of successful retries / # retries\n 103 |         = TP / # retries \n 104 |     \"\"\"\n 105 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n 106 |     if np.sum(recalls >= recall_value) == 0:\n 107 |         return 0.\n 108 |     idx = np.argmin(recalls[recalls >= recall_value])\n 109 |     treshold_value = thresholds[idx]\n 110 |     y_pred = np.where(y_score > treshold_value, 1, 0) \n 111 |     tp = np.sum((y_pred==1) & (y_true == 1))\n 112 |     return tp / len(y_pred) \n 113 | # def precision_at_recall(precisions, recalls, recall_value):\n 114 | #     \"\"\"Precision at the given recall value\n 115 | #     \"\"\"\n 116 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 117 | #     precision_value = precisions[idx]\n 118 | #     return precision_value\n 119 | # def threshold_at_recall(thresholds, recalls, recall_value):\n 120 | #     \"\"\"Threshold at the given recall value\n 121 | #     \"\"\"\n 122 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 123 | #     threshold = thresholds[idx - 1]\n 124 | #     return threshold\n 125 | # def savings_at_recall(precisions, recalls, recall_value, min_ratio):\n 126 | #     \"\"\"Positive prediction rate savings at the given recall value\n 127 | #     \"\"\"\n 128 | #     idx = np.argmin(recalls[recalls >= recall_value])\n 129 | #     precision_value = precisions[idx]\n 130 | #     return 1 - recall_value * min_ratio / precision_value\n 131 | def partial_aucpr(y_true, y_score, recall_lb, recall_ub):\n 132 |     \"\"\"Partial Area Under the PR Curve between the given recall levels\n 133 |     \"\"\"\n 134 |     precisions, recalls, thresholds = precision_recall_curve(y_true, y_score)\n 135 |     if np.sum(recalls >= recall_lb) == 0:\n 136 |         return 0.\n 137 |     idx_right = np.argmin(recalls[recalls >= recall_lb])\n 138 |     if np.sum(recalls >= recall_ub) == 0:\n 139 |         # get max recall possible\n 140 |         idx_left = np.argmax(recalls[recalls >= recall_lb])\n 141 |     else:\n 142 |         idx_left = np.argmin(recalls[recalls >= recall_ub])\n 143 |     try:\n 144 |         p_aucpr = auc(recalls[idx_left:idx_right], precisions[idx_left:idx_right])\n 145 |     except ValueError as e:\n 146 |         p_aucpr = 0.\n 147 |     return p_aucpr\n 148 | def evaluate_metrics(y_true, y_score, metric_functions):\n 149 |     \"\"\"Evaluate a list of metrics (callables) on y_true and y_score\n 150 |     \"\"\"\n 151 |     return [score(y_true, y_score) for score in metric_functions]\n 152 | def get_features_and_target(df, features, target_col):\n 153 |     \"\"\"Return feature matrix and 1-D label vector\n 154 |     \"\"\"\n 155 |     return df[features], df[target_col]\n 156 | # %%\n 157 | # partial area-under-the-curve refers to the area under the precision-recall curve\n 158 | # but only for a specific interval of recall values\n 159 | partial_aucpr_geq90 = partial(partial_aucpr, recall_lb=0.9, recall_ub=1.)\n 160 | precision_at_95 = partial(precision_at_recall, recall_value=0.95)\n 161 | precision_at_99 = partial(precision_at_recall, recall_value=0.99)\n 162 | precision_at_995 = partial(precision_at_recall, recall_value=0.99)\n 163 | # savings refers to the percentage of records that are not predicted as positive:\n 164 | #      savings = 1 - (TP + FP) / (TP + FP + TN + FN)\n 165 | # or, alternatively:\n 166 | #      savings = 1 - minority_ratio * recall / precision\n 167 | savings_at_95 = partial(savings_at_recall, recall_value=0.95)\n 168 | savings_at_99 = partial(savings_at_recall, recall_value=0.99)\n 169 | savings_at_995 = partial(savings_at_recall, recall_value=0.995)\n 170 | METRIC_FUNCTIONS = [precision_at_95, precision_at_99, precision_at_995, savings_at_95, savings_at_99, savings_at_995, partial_aucpr_geq90]\n 171 | METRIC_NAMES = [\"precision_at_95\", \"precision_at_99\", \"precision_at_995\", \"savings_at_95\", \"savings_at_99\", \"savings_at_995\", \"partial_aucpr_geq90\"]\n 172 | # %%\n 173 | DATA_PATH = Path(\n 174 |     \"/projects/dnaomi/bt-retry-global-refresh/data/pypl-bods.gds_pacman_prod.bt_retry_global_refresh_driverset_cc_renamed_radd_subset_filtered_full_test_3/\"\n 175 | )\n 176 | # %%\n 177 | V1_FEATURES_PATH = Path(\"/projects/dnaomi/bt-retry-global-refresh/metadata/features_original.txt\") \n 178 | V1_MODEL_PATH = Path( \"/projects/dnaomi/bt-retry-global/models/lgbm/original_lgbm/original_model.txt\")\n 179 | V2_FEATURES_PATH = Path(\"/projects/dnaomi/bt-retry-global-refresh/metadata/v2_features_final_2.txt\") \n 180 | V2_MODEL_PATH = Path(\"/projects/dnaomi/bt-retry-global-refresh/models/final/bt_retry_v2.txt\")\n 181 | # V2_CONTROL_MODEL_PATH = Path(\"/projects/dnaomi/bt-retry-global-refresh/models/bt_retry_v2_subset_strat_control.txt\")\n 182 | # %%\n 183 | data = pd.read_parquet(DATA_PATH)\n 184 | # %%\n 185 | data['retry_strategy_type'].unique()\n 186 | # %%\n 187 | # load features and types\n 188 | numerical_columns = [\"setec_txn_amt_usd\",\n 189 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d\",\n 190 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d\",\n 191 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d\",\n 192 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d\",\n 193 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d\",\n 194 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n 195 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n 196 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n 197 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n 198 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n 199 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n 200 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n 201 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n 202 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n 203 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d\",\n 204 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n 205 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n 206 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n 207 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n 208 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n 209 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n 210 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n 211 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n 212 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\",\n 213 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d\",\n 214 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n 215 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n 216 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n 217 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n 218 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n 219 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n 220 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n 221 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n 222 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n 223 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d\",\n 224 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n 225 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n 226 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n 227 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n 228 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n 229 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n 230 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n 231 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n 232 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\", \n 233 |                     # \"bt24_model_score1\" \n 234 |                     ]\n 235 | integer_columns = []\n 236 | encoded_columns = []  # no encoded columns in this example\n 237 | categorical_columns = [\"merchant_fk\",\n 238 |                        \"setec_currency_code\",\n 239 |                        \"primary_response_type\",\n 240 |                        \"processor_settings_type\",\n 241 |                        \"retry_strategy_type\",\n 242 |                        \"card_type\",\n 243 |                        \"fi_usage\", \n 244 |                        \"issuer\", \n 245 |                        \"bin\",  \n 246 |                        \"issuer_cntry_code\", \n 247 |                       # \"pan_guid\",\n 248 |                        \"is_recurring_txn\", \n 249 |                        \"payment_instrument_type\", \n 250 |                        \"is_cvv_present\", \n 251 |                        \"enrollment_status\", \n 252 |                        \"token_status\", \n 253 |                        \"vaulted_credential_type\", \n 254 |                        \"mcc_code\", \n 255 |                        \"liability_shift_possible\", \n 256 |                        \"success_3ds\", \n 257 |                        \"verifications_txn\", \n 258 |                        \"fastlane_txn\" \n 259 |                       ]\n 260 | target_col = \"retry_is_success\"\n 261 | # %%\n 262 | data['issuer_cntry_code'] = data['issuer_country']\n 263 | # %%\n 264 | data = convert_column_types(data,\n 265 |                             numerical_columns=numerical_columns,\n 266 |                             integer_columns=integer_columns + [target_col],\n 267 |                             categorical_columns=categorical_columns)\n 268 | # %%\n 269 | data['primary_processor_settings_type'] = data['processor_settings_type']\n 270 | # %%\n 271 | V1_FEATURES = list_from_txt(V1_FEATURES_PATH)\n 272 | v1_model = lgb.Booster(model_file=V1_MODEL_PATH)\n 273 | # %%\n 274 | V2_FEATURES = list_from_txt(V2_FEATURES_PATH)\n 275 | v2_model = lgb.Booster(model_file=V2_MODEL_PATH)\n 276 | #v2_ctrl_model = lgb.Booster(model_file=V2_CONTROL_MODEL_PATH)\n 277 | # %%\n 278 | X_1, y_1 = data[V1_FEATURES], data[target_col]\n 279 | v1_scores = v1_model.predict(X_1)\n 280 | v1_metrics = evaluate_metrics(y_1, v1_scores, METRIC_FUNCTIONS)\n 281 | # %%\n 282 | data[\"v1_score\"] = v1_scores\n 283 | # %%\n 284 | X_2, y_2 = data[V2_FEATURES], data[target_col]\n 285 | v2_scores = v2_model.predict(X_2)\n 286 | v2_metrics = evaluate_metrics(y_2, v2_scores, METRIC_FUNCTIONS)\n 287 | # %%\n 288 | retry_success_rate_at_recall(y_1, v1_scores, 0.95) * 100 \n 289 | # %%\n 290 | retry_success_rate_at_recall(y_2, v2_scores, 0.98) * 100 \n 291 | # %%\n 292 | savings_at_recall(y_2, v2_scores, 0.98) * 100 \n 293 | # %%\n 294 | precision = precision_score(y_2, v2_scores > 0.018447025070137058)\n 295 | recall = recall_score(y_2, v2_scores > 0.018447025070137058)\n 296 | # %%\n 297 | ( 6.111412524741035 - 5.924284896163004) / 5.924284896163004 \n 298 | # %%\n 299 | data[\"v2_score\"] = v2_scores\n 300 | # %%\n 301 | # v2_ctrl_scores = v2_ctrl_model.predict(X_2)\n 302 | # v2_ctrl_metrics = evaluate_metrics(y_2, v2_ctrl_scores, METRIC_FUNCTIONS)\n 303 | # data[\"v2_ctrl_score\"] = v2_ctrl_scores\n 304 | # %%\n 305 | data[target_col].mean() * 100 # retry success rate\n 306 | # %%\n 307 | 5.924284896163004 / 6.2359968251097655 * 100 \n 308 | # %%\n 309 | precision, recall, _ = precision_recall_curve(data[target_col], data['v1_score'])\n 310 | auc_score = auc(recall, precision)\n 311 | auc_score\n 312 | # %%\n 313 | precision, recall, _ = precision_recall_curve(data[target_col], data['v2_score'])\n 314 | auc_score = auc(recall, precision)\n 315 | auc_score\n 316 | # %%\n 317 | pd.DataFrame(index=METRIC_NAMES, data=v1_metrics, columns=[\"value\"])\n 318 | # %%\n 319 | pd.DataFrame(index=METRIC_NAMES, data=v2_metrics, columns=[\"value\"])\n 320 | # %%\n 321 | pd.DataFrame(index=METRIC_NAMES, data=v2_ctrl_metrics, columns=[\"value\"])\n 322 | # %%\n 323 | # to evaluate by segment\n 324 | def evaluate_metrics_by_segment(data, segment_col, target_col, scores_col):\n 325 |     \"\"\"Evaluate metrics by segment\n 326 |     \"\"\"\n 327 |     by_segment = data.groupby(segment_col).apply(lambda df: evaluate_metrics(df[target_col],\n 328 |                                                                              df[scores_col],\n 329 |                                                                              METRIC_FUNCTIONS))\n 330 |     return pd.DataFrame(by_segment.to_list(),\n 331 |                         index=by_segment.index,\n 332 |                         columns=METRIC_NAMES)\n 333 | # %%\n 334 | # this might give some numeric problems due from dividing by zero\n 335 | evaluate_metrics_by_segment(data, \"primary_response_type\", target_col, \"v1_score\")\n 336 | # %%\n 337 | evaluate_metrics_by_segment(data, \"primary_response_type\", target_col, \"v2_score\")\n 338 | # %%\n 339 | evaluate_metrics_by_segment(data, \"primary_response_type\", target_col, \"v2_ctrl_score\")\n 340 | # %%\n 341 | # this might give some numeric problems due from dividing by zero\n 342 | evaluate_metrics_by_segment(data, \"retry_strategy_type\", target_col, \"v1_score\")\n 343 | # %%\n 344 | # this might give some numeric problems due from dividing by zero\n 345 | evaluate_metrics_by_segment(data, \"retry_strategy_type\", target_col, \"v2_score\")\n 346 | # %%\n 347 | # this might give some numeric problems due from dividing by zero\n 348 | evaluate_metrics_by_segment(data, \"retry_strategy_type\", target_col, \"v2_ctrl_score\")\n 349 | # %%\n 350 | # %%\n 351 | fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 352 | precisions, recalls, _ = precision_recall_curve(data[target_col], v1_scores)\n 353 | ax.plot(recalls, precisions, label='V1')\n 354 | precisions, recalls, _ = precision_recall_curve(data[target_col], v2_scores)\n 355 | ax.plot(recalls, precisions, label='V2')\n 356 | # precisions, recalls, _ = precision_recall_curve(data[target_col], v2_ctrl_scores)\n 357 | # ax.plot(recalls, precisions, label='V2 Control')\n 358 | ax.set_xlabel(\"Recall\")\n 359 | ax.set_ylabel(\"Precision\")\n 360 | plt.title(\"Precision Recall Curves of V1 vs. V2\")\n 361 | plt.legend()\n 362 | # %%\n 363 | data['primary_response_type'].unique()\n 364 | # %%\n 365 | data['retry_strategy_type'].unique()\n 366 | # %%\n 367 | #retry_strategies = ['ACQUIRER_RETRY', 'ACQUIRER_MIGRATION_RETRY', 'PROCESSOR_RETRY', 'ALT_MERCHANT_ACCOUNT', 'PINLESS_DEBIT_AS_CREDIT', 'NO_AVS', 'PAN', 'NETWORK_TOKENIZATION', 'ABU']\n 368 | retry_strategies = ['NO_AVS', 'PAN', 'NETWORK_TOKENIZATION', 'ABU']\n 369 | primary_response_types = ['NSF', 'SOFT OTHER', 'NO HONOR', 'HARD OTHER', 'INVALID CC']\n 370 | # %%\n 371 | # %%\n 372 | fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 373 | for cat in retry_strategies:\n 374 |     temp = data[ data['retry_strategy_type']== cat ] \n 375 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n 376 |     ax.plot(recalls, precisions, label=cat)\n 377 | ax.set_xlabel(\"Recall\")\n 378 | ax.set_ylabel(\"Precision\")\n 379 | plt.title(\"Precision Recall Curves by Retry Strategy\")\n 380 | plt.legend()\n 381 | # %%\n 382 | fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 383 | for cat in primary_response_types:\n 384 |     temp = data[ data['primary_response_type']== cat ] \n 385 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n 386 |     ax.plot(recalls, precisions, label=cat)\n 387 | ax.set_xlabel(\"Recall\")\n 388 | ax.set_ylabel(\"Precision\")\n 389 | plt.title(\"Precision Recall Curves by Decline Type\")\n 390 | plt.legend()\n 391 | # %%\n 392 | fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 393 | for cat in primary_response_types:\n 394 |     temp = data[ data['primary_response_type']== cat ] \n 395 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_ctrl_score'])\n 396 |     ax.plot(recalls, precisions, label=cat)\n 397 | ax.set_xlabel(\"Recall\")\n 398 | ax.set_ylabel(\"Precision\")\n 399 | plt.title(\"Precision Recall Curves by Decline Type\")\n 400 | plt.legend()\n 401 | # %%\n 402 | for cat in retry_strategies:\n 403 |     fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 404 |     temp = data[ data['retry_strategy_type']== cat ] \n 405 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v1_score'])\n 406 |     ax.plot(recalls, precisions, label='V1')\n 407 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n 408 |     ax.plot(recalls, precisions, label='V2')\n 409 |     # precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_ctrl_score'])\n 410 |     # ax.plot(recalls, precisions, label='V2 Control')\n 411 |     ax.set_xlabel(\"Recall\")\n 412 |     ax.set_ylabel(\"Precision\")\n 413 |     plt.title(\"Precision Recall Curves of \" + cat)\n 414 |     plt.legend()\n 415 | # %%\n 416 | for cat in primary_response_types:\n 417 |     fig, ax = plt.subplots(1, 1, figsize=(9, 6))\n 418 |     temp = data[ data['primary_response_type']== cat ] \n 419 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v1_score'])\n 420 |     ax.plot(recalls, precisions, label='V1')\n 421 |     precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_score'])\n 422 |     ax.plot(recalls, precisions, label='V2')\n 423 |     # precisions, recalls, _ = precision_recall_curve(temp[target_col], temp['v2_ctrl_score'])\n 424 |     # ax.plot(recalls, precisions, label='V2 Control')\n 425 |     ax.set_xlabel(\"Recall\")\n 426 |     ax.set_ylabel(\"Precision\")\n 427 |     plt.title(\"Precision Recall Curves of \" + cat)\n 428 |     plt.legend()\n 429 | # %% [markdown]\n 430 | # ## Export some test obs as model validation data\n 431 | # %%\n 432 | valid_data = data[:50000][V2_FEATURES + ['v2_score']]\n 433 | # %%\n 434 | # %%\n 435 | dict(valid_data.dtypes)\n 436 | # %%\n 437 | import csv\n 438 | # %%\n 439 | valid_data_filtered = valid_data.dropna(subset=['mcc_code'])\n 440 | # %%\n 441 | # %%\n 442 | valid_data_filtered.to_csv('/projects/dnaomi/bt-retry-global-refresh/deployment/valid_data_filtered_final.csv', quoting=csv.QUOTE_NONE, sep='\\x07')\n 443 | # %%",
    "rmr_agent/repos/bt-retry-v2/deployment/01_export_to_ume.py": "   1 | # %% [markdown]\n   2 | # ### BT Retry\n   3 | # # Model Saving\n   4 | # %%\n   5 | import json\n   6 | import lightgbm\n   7 | # %%\n   8 | def list_from_txt(path):\n   9 |     \"\"\"Return a list with each element containing a line\n  10 |         of the file in the given path\n  11 |     \"\"\"\n  12 |     with open(path, mode=\"r\") as f:\n  13 |         lst = [line.rstrip() for line in f.readlines()]\n  14 |     return lst\n  15 | # %% [markdown]\n  16 | # ## Features\n  17 | # %%\n  18 | FULL_FEATURES_PATH = \"/projects/dnaomi/bt-retry-global-v2/metadata/v2_features_final_2.txt\"\n  19 | FEATURES = list_from_txt(FULL_FEATURES_PATH)\n  20 | # %%\n  21 | categorical_columns = [\"merchant_fk\",\n  22 |                        \"setec_currency_code\",\n  23 |                        \"primary_response_type\",\n  24 |                        \"processor_settings_type\",\n  25 |                        \"retry_strategy_type\",\n  26 |                        \"card_type\",\n  27 |                        \"fi_usage\", \n  28 |                        \"issuer\", \n  29 |                        \"bin\",  \n  30 |                        \"issuer_cntry_code\", \n  31 |                        \"is_recurring_txn\", \n  32 |                        \"payment_instrument_type\", \n  33 |                        \"is_cvv_present\", \n  34 |                        \"enrollment_status\", \n  35 |                        \"token_status\", \n  36 |                        \"vaulted_credential_type\", \n  37 |                        \"mcc_code\", \n  38 |                        \"liability_shift_possible\", \n  39 |                        \"success_3ds\", \n  40 |                        \"verifications_txn\", \n  41 |                        \"fastlane_txn\" \n  42 |                       ]\n  43 | # %% [markdown]\n  44 | # ## Models\n  45 | # %%\n  46 | # model can be loaded in different ways: from txt file, from pickle, from Mlflow...\n  47 | model = lightgbm.Booster(model_file=\"/projects/dnaomi/bt-retry-global-v2/models/bt_retry_v2_small.txt\")\n  48 | # %% [markdown]\n  49 | # ## Export\n  50 | # %%\n  51 | # name for model files\n  52 | name = \"bt_retry_v2\"\n  53 | # get JSON\n  54 | model_json = model.dump_model()\n  55 | # no mapping file\n  56 | model_json_with_pd_path = f\"/projects/dnaomi/bt-retry-global-v2/models/{name}_model_idi.json\"\n  57 | model_json[\"categorical_feature_name\"] = [feat for feat in categorical_columns]\n  58 | with open(model_json_with_pd_path, \"w\") as f:\n  59 |     json.dump(model_json, f)\n  60 | # %% [markdown]\n  61 | # ## Transform to UME\n  62 | # %%\n  63 | from pyScoring.lightgbm import LightGBMTransformer\n  64 | lgb_transformer = LightGBMTransformer(path_to_json='/projects/dnaomi/bt-retry-global-v2/models/bt_retry_v2_model_idi.json')\n  65 | binary_spec = lgb_transformer.create_model_spec(model_name='bt_retry_v2', tree_nodes_only=False, output_name='bt_retry_v2_score')\n  66 | # %%\n  67 | binary_spec\n  68 | # %%\n  69 | output_path = \"/projects/dnaomi/bt-retry-global-v2/models/ume/\"\n  70 | binary_spec.save(output_path)\n  71 | # %%\n  72 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-v2/models/ume/bt_retry_v2.m -tgt bt-retry-v2/bt_retry_v2_final.m\n  73 | # %%\n  74 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-v2/models/ume/bt_retry_v2.m -tgt bt-retry-v2/bt_retry_v2.m\n  75 | # %%\n  76 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-v2/models/bt_retry_v2_model_idi.m -tgt bt-retry-v2/bt_retry_v2_model_idi.m\n  77 | # %%\n  78 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-v2/models/bt_retry_v2_model_idi.json -tgt bt-retry-v2/bt_retry_v2_model_idi.json",
    "rmr_agent/repos/bt-retry-v2/deployment/02_pyscoring_validation.py": "   1 | # %%\n   2 | # %config Completer.use_jedi = False\n   3 | # %%\n   4 | import pyScoring\n   5 | from pyScoring import UMEModel\n   6 | from semi_auto_trans.model_builder import start_semi_trans\n   7 | from semi_auto_trans.validater import validate_model\n   8 | import pandas as pd\n   9 | import os\n  10 | import numpy as np\n  11 | # %%\n  12 | pyScoring.__version__\n  13 | # %% [markdown]\n  14 | # ## (SKIP) Export to UME via pyScoring\n  15 | # %%\n  16 | # load features and types\n  17 | numerical_columns = [\"setec_txn_amt_usd\",\n  18 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_7d\",\n  19 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_7d\",\n  20 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_14d\",\n  21 |                     \"idi_bt_unbranded_retry_bin_rdd_cnt_pri_success_ratio_nt_14d\",\n  22 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_7d\",\n  23 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n  24 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n  25 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n  26 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n  27 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n  28 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n  29 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n  30 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n  31 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n  32 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_14d\",\n  33 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n  34 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n  35 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n  36 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n  37 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n  38 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n  39 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n  40 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n  41 |                     \"idi_bt_unbranded_retry_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\",\n  42 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_7d\",\n  43 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_7d\",\n  44 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_7d\",\n  45 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_7d\",\n  46 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_7d\",\n  47 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_7d\",\n  48 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_7d\",\n  49 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_7d\",\n  50 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_7d\",\n  51 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_7d\",\n  52 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_14d\",\n  53 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_soft_14d\",\n  54 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_nsf_14d\",\n  55 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_dnh_14d\",\n  56 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_retry_success_ratio_post_hard_14d\",\n  57 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_14d\",\n  58 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_soft_14d\",\n  59 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_nsf_14d\",\n  60 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_dnh_14d\",\n  61 |                     \"idi_bt_unbranded_retry_bin_strategy_rdd_cnt_first_retry_success_ratio_post_hard_14d\", \n  62 |                     # \"bt24_model_score1\" \n  63 |                     ]\n  64 | integer_columns = []\n  65 | encoded_columns = []  # no encoded columns in this example\n  66 | categorical_columns = [\"merchant_fk\",\n  67 |                        \"setec_currency_code\",\n  68 |                        \"primary_response_type\",\n  69 |                        \"processor_settings_type\",\n  70 |                        \"retry_strategy_type\",\n  71 |                        \"card_type\",\n  72 |                        \"fi_usage\", \n  73 |                        \"issuer\", \n  74 |                        \"bin\",  \n  75 |                        \"issuer_cntry_code\", \n  76 |                        #\"pan_guid\",\n  77 |                        \"is_recurring_txn\", \n  78 |                        \"payment_instrument_type\", \n  79 |                        \"is_cvv_present\", \n  80 |                        \"enrollment_status\", \n  81 |                        \"token_status\", \n  82 |                        \"vaulted_credential_type\", \n  83 |                        \"mcc_code\", \n  84 |                        \"liability_shift_possible\", \n  85 |                        \"success_3ds\", \n  86 |                        \"verifications_txn\", \n  87 |                        \"fastlane_txn\" \n  88 |                       ]\n  89 | target_col = \"retry_is_success\"\n  90 | # %%\n  91 | def convert_column_types(df, numerical_columns, integer_columns, categorical_columns):\n  92 |     \"\"\"Convert numerical, integer and categorical columns of provided\n  93 |     pandas.DataFrame\n  94 |         Specificaly, convert categorical columns to pandas.Categorical,\n  95 |         numerical columns to numpy.float32 and\n  96 |         integer columns to numpy.int64\n  97 |     \"\"\"\n  98 |     for col in categorical_columns:\n  99 |         df[col] = pd.Categorical(df[col])\n 100 |     for col in numerical_columns:\n 101 |         df[col] = df[col].astype(np.float64)\n 102 |     for col in integer_columns:\n 103 |         df[col] = df[col].astype(np.int64)\n 104 |     return df\n 105 | # %%\n 106 | MODELS_DIR = \"/home/dnaomi/bt-retry-global-refresh/models/ume/\"\n 107 | MODEL_DIR = os.path.join(MODELS_DIR)\n 108 | MODEL_UME_NAME = \"bt_retry_v2\"\n 109 | # %% [markdown]\n 110 | # ### With mapping file\n 111 | # %%\n 112 | start_semi_trans(MODEL_DIR, MODEL_UME_NAME)\n 113 | # %% [markdown]\n 114 | # ## Validate with LightGBM predictions\n 115 | # %%\n 116 | VALID_SAMPLE_PATH = \"/home/dnaomi/bt-retry-global-refresh/deployment/valid_data_filtered_final.csv\"\n 117 | if os.path.exists(VALID_SAMPLE_PATH):\n 118 |     valid_sample = pd.read_csv(VALID_SAMPLE_PATH,sep='\\x07', dtype=str, index_col=0, keep_default_na=False )\n 119 | # %%\n 120 | # %%\n 121 | valid_sample = convert_column_types(valid_sample,\n 122 |                             numerical_columns=numerical_columns,\n 123 |                             integer_columns=integer_columns,\n 124 |                             categorical_columns=categorical_columns)\n 125 | # %% [markdown]\n 126 | # ### Feature List\n 127 | # %%\n 128 | def list_from_txt(path):\n 129 |     \"\"\"Return a list with each element containing a line\n 130 |         of the file in the given path\n 131 |     \"\"\"\n 132 |     with open(path, mode=\"r\") as f:\n 133 |         lst = [line.rstrip() for line in f.readlines()]\n 134 |     return lst \n 135 | # %%\n 136 | features = list_from_txt(\"/projects/dnaomi/bt-retry-global-refresh/metadata/v2_features_final_2.txt\")\n 137 | # %% [markdown]\n 138 | # ### Predict with UME model (with mapping)\n 139 | # %%\n 140 | model_file = os.path.join(MODEL_DIR, \"ume/bt_retry_v2.m\")\n 141 | ume_model = UMEModel(model_file)\n 142 | # %% [markdown]\n 143 | # #### DataFrame\n 144 | # %%\n 145 | ume_predictions_valid = ume_model.predict(valid_sample)\n 146 | # %%\n 147 | ume_predictions_valid\n 148 | # %%\n 149 | ume_preds_filtered = ume_predictions_valid.dropna(subset=['mcc_code'])\n 150 | # %%\n 151 | ume_preds_filtered \n 152 | # %%\n 153 | import csv\n 154 | # %%\n 155 | ume_preds_filtered[:5000].to_csv('/projects/dnaomi/bt-retry-global-refresh/deployment/cosmos_ai_valid_data.csv', quoting=csv.QUOTE_NONE, sep='\\x07', index=False)\n 156 | # %%\n 157 | # %dropzone --put -src /projects/dnaomi/bt-retry-global-refresh/deployment/cosmos_ai_valid_data.csv -tgt bt-retry-v2/cosmos_ai_valid_data_5000_2.csv\n 158 | # %% [markdown]\n 159 | # #### Sample by sample\n 160 | # %%\n 161 | for i in range(10):\n 162 |     single_example_dict = valid_sample[features].iloc[i, :].to_dict()\n 163 | # %% [markdown]\n 164 | # #### Validate\n 165 | # %%\n 166 | valid_mismatches = validate_model(model_file, VALID_SAMPLE_PATH, \"v2_score\", delta=1e-6)\n 167 | # %% [markdown]\n 168 | # ***\n 169 | # ***\n 170 | # %% [markdown]\n 171 | # ***\n 172 | # ***"
  }
}